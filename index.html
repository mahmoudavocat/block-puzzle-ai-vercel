<!DOCTYPE html>
<html lang="ar">
<head>


  
  <link rel="manifest" href="manifest.json">
<meta name="theme-color" content="#121212">

  <meta name="apple-mobile-web-app-capable" content="yes">
  <meta name="apple-mobile-web-app-status-bar-style" content="black-translucent">
  <meta name="mobile-web-app-capable" content="yes">
  <meta name="viewport" content="width=device-width, initial-scale=1, viewport-fit=cover">


  <script>
  if ('serviceWorker' in navigator) {
    navigator.serviceWorker.register('service-worker.js')
      .then(() => console.log('âœ… Service Worker registered'))
      .catch(err => console.error('âŒ Service Worker failed:', err));
  }
</script>


  <script>
    function enterFullscreen() {
      if (document.documentElement.requestFullscreen) {
        document.documentElement.requestFullscreen();
      } else if (document.documentElement.mozRequestFullScreen) { // Firefox
        document.documentElement.mozRequestFullScreen();
      } else if (document.documentElement.webkitRequestFullscreen) { // Chrome, Safari
        document.documentElement.webkitRequestFullscreen();
      } else if (document.documentElement.msRequestFullscreen) { // IE/Edge
        document.documentElement.msRequestFullscreen();
      }
    }
  
    window.addEventListener('load', function () {
      enterFullscreen(); // ØªØ£ÙƒØ¯ Ù…Ù† Ø£Ù† Ø§Ù„ÙˆØ¸ÙŠÙØ© ØªÙÙ†ÙØ° Ø¹Ù†Ø¯ ØªØ­Ù…ÙŠÙ„ Ø§Ù„ØµÙØ­Ø©
    });
  </script>
  
  
  <script src="https://unpkg.com/hammerjs@2.0.8/hammer.min.js"></script>

  <title>Block Puzzle AI</title>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0"/>
  <style>




#aiModeToggleBtn,
#soundToggleBtn {
  padding: 8px 16px;
  border-radius: 12px;
  background: linear-gradient(45deg, #2196F3, #21CBF3);
  color: white;
  font-size: 1rem;
  font-weight: bold;
  border: none;
  cursor: pointer;
  transition: all 0.3s ease;
  box-shadow: 0 0 10px rgba(33, 150, 243, 0.4);
}

#aiModeToggleBtn:hover,
#soundToggleBtn:hover {
  background: linear-gradient(45deg, #00C853, #00E676);
  box-shadow: 0 0 14px rgba(0, 230, 118, 0.5);
}

.enhanced-welcome {
  background: linear-gradient(145deg, #f9f9f9, #ffffff);
  border-radius: 25px;
  padding: 40px 30px;
  box-shadow: 0 8px 24px rgba(0, 0, 0, 0.08);
  max-width: 420px;
  margin: auto;
  text-align: center;
  display: flex;
  flex-direction: column;
  gap: 25px;
  animation: fadeIn 0.7s ease-in-out;
}

.welcome-title {
  font-size: 1.4rem;
  color: #2196F3;
  margin-bottom: 10px;
  font-weight: bold;
}

.btn-group {
  display: flex;
  flex-wrap: wrap;
  justify-content: center;
  gap: 15px;
}

.hero-btn {
  background: #E3F2FD;
  color: #0D47A1;
  border: none;
  border-radius: 12px;
  padding: 10px 18px;
  font-size: 1rem;
  font-weight: 600;
  cursor: pointer;
  transition: background 0.3s ease;
  min-width: 120px;
}

.hero-btn:hover {
  background: #BBDEFB;
}

.step p {
  font-size: 1.1rem;
  color: #444;
  margin-bottom: 10px;
}


#playerStatsCard {
  background: #fff;
  border-radius: 25px;
  padding: 30px;
  max-width: 420px;
  margin: auto;
  box-shadow: 0 4px 12px rgba(0,0,0,0.1);
  display: flex;
  flex-direction: column;
  align-items: center;
  gap: 20px;
  animation: fadeInCard 0.5s ease;
  text-align: center;
}

.stats-title {
  color: #2196F3;
  font-size: 1.3rem;
  margin-bottom: 10px;
}

.stats-content {
  font-size: 1rem;
  line-height: 1.8;
  width: 100%;
}

.stats-content .row {
  display: flex;
  justify-content: space-between;
  align-items: center;
  margin: 8px 0;
}

.stats-content button {
  padding: 5px 10px;
  font-size: 0.85rem;
  border-radius: 10px;
  background-color: #E3F2FD;
  border: 1px solid #90CAF9;
  color: #0D47A1;
  cursor: pointer;
}





#languageGenderCard {
  background: #ffffff;
  border-radius: 20px;
  padding: 25px;
  max-width: 400px;
  margin: auto;
  box-shadow: 0 4px 15px rgba(0, 0, 0, 0.1);
  display: flex;
  flex-direction: column;
  align-items: center;
  gap: 20px;
  animation: fadeInCard 0.6s ease;
}


  #countdownBarContainer {
    width: 100%;
    max-width: 300px;
    height: 12px;
    background: #ddd;
    border-radius: 8px;
    overflow: hidden;
    margin: 10px auto;
    display: none;
  }

  #countdownBar {
    height: 100%;
    width: 100%;
    background: linear-gradient(90deg, #ff00cc, #3333ff, #00ffff, #00cc66, #ffff00, #ff6600, #ff0033);
    background-size: 400% 100%;
    animation: colorfulShift 5s linear infinite, countdownShrink 5s linear forwards;
    transition: width 0.1s linear;
  }

  @keyframes colorfulShift {
    0% { background-position: 0% 50%; }
    100% { background-position: 100% 50%; }
  }

  @keyframes countdownShrink {
    0% { width: 100%; }
    100% { width: 0%; }
  }

#welcomeScreen {
  position: fixed;
  top: 0;
  left: 0;
  width: 100vw;
  height: 100vh;
  background: white;
  z-index: 999;
  display: flex;
  align-items: center;
  justify-content: center;
  flex-direction: column;
}




.fade-out {
  animation: fadeOut 0.7s ease forwards;
}

@keyframes fadeOut {
  from {
    opacity: 1;
  }
  to {
    opacity: 0;
    visibility: hidden;
  }
}


.splash-screen {
  background: linear-gradient(to bottom, #3a0055 0%, #4a007d 50%, #5e20a0 100%);
  position: fixed;
  top: 0; left: 0;
  width: 100%;
  height: 100%;
  display: flex;
  flex-direction: column;
  align-items: center;
  justify-content: center;
  color: white;
  z-index: 9999;
}
.splash-screen::before {
  content: "";
  position: absolute;
  top: 0;
  left: 0;
  width: 100%;
  height: 100%;
  background: radial-gradient(ellipse at top, rgba(255,255,255,0.08), transparent 70%);
  pointer-events: none;
}


.studio-logo {
  width: 240px;
  height: 240px;
  animation: pulse 2s infinite;
}

.studio-name {
  font-size: 1.5rem;
  font-weight: 600;
  font-family: 'Tajawal', sans-serif;
}

@keyframes pulse {
  0% { transform: scale(1); opacity: 0.6; }
  50% { transform: scale(1.05); opacity: 1; }
  100% { transform: scale(1); opacity: 0.6; }
}

    

    
    
    .back-home-btn {
      position: absolute;
      top: 20px;
      left: 20px;
      width: 48px;
      height: 48px;
      background: rgba(255, 255, 255, 0.9);
      border: 2px solid #2196F3;
      border-radius: 50%;
      cursor: pointer;
      display: flex;
      align-items: center;
      justify-content: center;
      z-index: 1000;
      box-shadow: 0 2px 10px rgba(0,0,0,0.1);
      transition: all 0.3s ease;
    }
    
    .back-home-btn:hover {
      background: #2196F3;
      transform: scale(1.1);
    }
    
    .back-home-btn svg {
      stroke: #2196F3;
      transition: all 0.3s ease;
    }
    
    .back-home-btn:hover svg {
      stroke: white;
    }
    
    .screen {
      display: none;
      flex-direction: column;
      align-items: center;
      justify-content: center;
      width: 100%;
      height: 100%;
      position: absolute;
      top: 0;
      left: 0;
      background: #eef6fb;
      text-align: center;
      padding: 20px;
      box-sizing: border-box;
    }
    
    .active { display: flex; }
    
    h1, h2 {
      color: #2196f3;
      margin: 10px;
      font-weight: 600;
    }
    
    .btn {
      background: linear-gradient(45deg, #2196f3, #21cbf3);
      color: white;
      border: none;
      padding: 12px 25px;
      border-radius: 12px;
      cursor: pointer;
      font-size: 1.2em;
      margin-top: 15px;
      box-shadow: 0 4px 12px rgba(0,0,0,0.1);
      transition: all 0.3s ease;
    }
    
    .btn:hover {
      transform: translateY(-2px);
      box-shadow: 0 6px 16px rgba(0,0,0,0.2);
    }
    
    #scoreboard {
      font-size: 1.2rem;
      margin: 10px;
      font-weight: bold;
      color: #2196F3;
    }
    
    #grid {
      display: grid;
      gap: 2px;
      margin: 10px auto;
      width: 90vmin;
      height: 90vmin;
      max-width: 400px;
      max-height: 400px;
      grid-template-columns: repeat(8, 1fr);
      grid-template-rows: repeat(8, 1fr);
    }
    
    .cell {
      width: 100%;
      height: 100%;
      background: #fff;
      border: 1px solid #ccc;
      border-radius: 4px;
      transition: background 0.3s ease;
    }
    
    .filled { background: #2196f3; }
    .preview { background-color: rgba(33, 150, 243, 0.5); }
    .line-clear-preview { background-color: rgba(76, 175, 80, 0.6) !important; }
    
    #shapes {
      display: flex;
      gap: 15px;
      flex-wrap: wrap;
      justify-content: center;
      margin: 10px auto;
      width: 100%;
      max-width: 600px;
    }
    
.floating.shape {
  grid-template-columns: repeat(4, var(--cell-size));
  grid-template-rows: repeat(4, var(--cell-size));
}


.shape {
  touch-action: none;
  display: grid;
  grid-template-columns: repeat(4, clamp(20px, 5vmin, 60px));
  grid-template-rows: repeat(4, clamp(20px, 5vmin, 60px));
  gap: 3px;
  cursor: grab;
  touch-action: none;
}

@media (max-width: 600px) {
  #shapes {
    flex-wrap: nowrap;
    overflow-x: hidden; /* â† ÙŠÙ…Ù†Ø¹ Ø§Ù„Ø³ÙƒØ±ÙˆÙ„ */
    justify-content: space-between;
  }

  #shapes .shape {
    grid-template-columns: repeat(4, 28px); /* â† Ø¨Ø¯Ù„ 36 */
    grid-template-rows: repeat(4, 28px);
    gap: 1.5px;
    flex: 0 0 auto;
  }
}


    
    .block {
      width: 100%;
      height: 100%;
      background: #2196f3;
      border-radius: 4px;
      transition: transform 0.15s ease;
      pointer-events: none;
    }
    
 .floating {
  position: absolute;
  pointer-events: none;
  z-index: 9999;
  will-change: transform;
  transition: none !important;

}

    
   #finalScoreDisplay {
  font-size: 0; /* â† Ù„ØªÙØ§Ø¯ÙŠ Ø§Ù„ØªØ¯Ø§Ø®Ù„ */
  opacity: 0;
}

    
   
    
    #countdown {
      font-size: 1.1rem;
      margin-top: 10px;
      color: #888;
    }
    
    /* ğŸ‘‡ AI Reaction Container */
    #aiContainer {
      position: relative;
      width: 100%;
      max-width: 600px;
      margin: 10px auto;
      display: flex;
      flex-direction: column;
      align-items: center;
      min-height: 120px;
    }
    
    #aiInteractiveArea {
      display: flex;
      align-items: center;
      justify-content: center;
      width: 100%;
      margin-bottom: 10px;
      position: relative;
      min-height: 100px;
    }
    
    .ai-bubble {
      position: relative;
      width: 80px;
      height: 80px;
      opacity: 0;
      transform: scale(0.5) translateY(20px);
      transition: all 0.4s ease;
      z-index: 10;
      margin-right: 15px;
    }
    
    .ai-bubble.show {
      opacity: 1;
      transform: scale(1) translateY(0);
    }
    
    .bubble-inner {
      width: 100%;
      height: 100%;
      border-radius: 50%;
      background: radial-gradient(circle at 30% 30%, #ffffff22, #00000033);
      border: 2px solid #ffffff55;
      display: flex;
      align-items: center;
      justify-content: center;
      animation: float 4s ease-in-out infinite;
      box-shadow: 0 0 12px rgba(255, 255, 255, 0.1);
    }
    
    @keyframes float {
      0%, 100% { transform: translateY(0); }
      50% { transform: translateY(-6px); }
    }
    
    .bubble-inner img {
      width: 60px;
      height: 60px;
      object-fit: contain;
      animation: avatarPulse 2.8s ease-in-out infinite, avatarBlink 6s ease-in-out infinite;
      transform-origin: center center;
    }
    
    @keyframes avatarPulse {
      0%, 100% { transform: scale(1); filter: brightness(1); }
      50% { transform: scale(1.2); filter: brightness(1.25); }
    }
    
    @keyframes avatarBlink {
      0%, 96%, 100% { transform: scaleY(1); filter: brightness(1); }
      97% { transform: scaleY(0.1); filter: brightness(0.3); }
      98% { transform: scaleY(1); filter: brightness(1); }
    }
    
    #aiBoard {
  width: 90vmin;
  max-width: 400px;
  min-height: 80px;
  background: #ffffff;
  border-radius: 16px;
  box-shadow: 0 2px 10px rgba(0,0,0,0.1);
  padding: 10px 20px;
  display: flex;
  justify-content: center;
  align-items: center;
  flex-direction: column;
  opacity: 0;
  transform: scaleX(0);
  transition: all 0.4s ease;
  overflow: hidden;
}
    
    #aiBoard.show {
      transform: scaleX(1);
      opacity: 1;
    }
    
    #aiText {
  font-size: 1.2rem;
  font-weight: 600;
  color: #2196f3;
  text-align: center;
  line-height: 1.4;
  padding: 0 10px;
  word-break: break-word;
  max-width: 100%;
  opacity: 0;
  transform: translateY(10px);
  transition: all 0.5s ease;
  margin: 0;
}

    
    #aiText.show {
      opacity: 1;
      transform: translateY(0);
    }
    
  
    
    @keyframes bubbleEnter {
      0% { opacity: 0; transform: scale(0.2) rotate(0deg); filter: blur(4px); }
      20% { opacity: 1; transform: scale(1.05) rotate(2deg); }
      40% { transform: scale(0.95) rotate(-2deg); }
      60% { transform: scale(1.02) rotate(1deg); }
      80% { transform: scale(0.98) rotate(-1deg); }
      100% { transform: scale(1) rotate(0deg); filter: blur(0); }
    }
    
    @keyframes bubbleExit {
      0% { opacity: 1; transform: scale(1); }
      100% { opacity: 0; transform: scale(0.5) rotate(-10deg); filter: blur(3px); }
    }
    
    .ai-bubble.show {
      animation: bubbleEnter 0.4s ease-out forwards;
    }
    
    .ai-bubble.hide {
      animation: bubbleExit 0.4s ease-in forwards;
    }
    
    @keyframes boardEnter {
      0% { transform: translateX(-100%) scaleX(0); opacity: 0; }
      60% { transform: translateX(20%) scaleX(1.1); opacity: 1; }
      100% { transform: translateX(0) scaleX(1); opacity: 1; }
    }
    
    @keyframes boardExit {
      0% { transform: translateX(0) scaleX(1); opacity: 1; }
      100% { transform: translateX(-100%) scaleX(0); opacity: 0; }
    }
    
    #aiBoard.show {
      animation: boardEnter 0.5s ease-out forwards;
    }
    
    #aiBoard.hide {
      animation: boardExit 0.5s ease-in forwards;
    }
    
.welcome-screen {
  position: fixed;
  top: 0; left: 0;
  width: 100vw;
  height: 100vh;
  background: #eef6fb;
  display: flex;
  align-items: center;
  justify-content: center;
  z-index: 1000;
  flex-direction: column;
}




.welcome-card {
  max-width: 90%;
  padding: 20px;
  box-shadow: 0 0 10px rgba(0,0,0,0.1);
  background: white;
  border-radius: 12px;
  display: flex;
  flex-direction: column;
  align-items: center;
  justify-content: center; /* Ø¯ÙŠ Ø§Ù„Ù…Ù‡Ù…Ø© ğŸ‘‘ */
  min-height: 200px; /* Ø­Ø³Ø¨ Ø­Ø¬Ù… Ø§Ù„Ù…Ø­ØªÙˆÙ‰ */
   display: contents; /* â† ÙŠØ®Ù„ÙŠÙ‡Ø§ Ø´ÙØ§ÙØ© Ù„Ù„ØªÙ†Ø³ÙŠÙ‚ Ø¨Ø¯ÙˆÙ† Ù…Ø§ ØªØ£Ø«Ø± Ø¹Ù„Ù‰ Ø§Ù„ØªÙ…Ø±ÙƒØ² */
}


@keyframes fadeInCard {
  0% { opacity: 0; transform: translateY(20px); }
  100% { opacity: 1; transform: translateY(0); }
}


    .welcome-card p {
      font-size: 1.3rem;
      margin-bottom: 15px;
    }
    
    .welcome-card .btn {
      margin: 8px;
    }
    
    .game-title {
      font-size: 3.5rem;
      color: #2196F3;
      margin: 0 0 30px 0;
      font-weight: 800;
      text-shadow: 0 3px 6px rgba(0,0,0,0.1);
      animation: pulse 2s infinite;
      display: inline-block;
      padding: 0 20px;
      text-align: center;
      width: 100%;
      box-sizing: border-box;
    }
    
    @keyframes pulse {
      0% { transform: scale(1); }
      50% { transform: scale(1.03); }
      100% { transform: scale(1); }
    }
    
    #menu {
      overflow: hidden;
      padding: 0 15px;
      justify-content: center;
    }
    
    .menu-content {
      display: flex;
      flex-direction: column;
      align-items: center;
      justify-content: center;
      height: 100%;
      margin-top: -50px;
    }
    
    .start-btn {
      padding: 15px 40px;
      font-size: 1.5rem;
      margin: 10px 0;
    }
    
    .stats-btn {
      background: rgba(33, 150, 243, 0.1);
      color: #2196F3;
      margin: 10px 0 30px 0;
    }
    
    .copyright {
      font-size: 0.8rem; 
      color: #777;
      margin-top: 40px;
      position: absolute;
      bottom: 20px;
    }
    
    .hidden {
      display: none !important;
    }
    
    #aiFlash {
      position: fixed;
      top: 0;
      left: 0;
      width: 100%;
      height: 100%;
      background: white;
      opacity: 0;
      pointer-events: none;
      z-index: 9999;
      transition: opacity 0.2s ease;
    }
    
/* Ø§Ù„Ù†Ù‚Ø§Ø· */
.ai-dots {
  position: absolute;
  top: 100%;
  left: 50%;
  transform: translateX(-50%);
  display: flex;
  gap: 3px;
  margin-top: 6px;
  animation: curveDots 2s infinite ease-in-out;
}

@keyframes curveDots {
  0% { transform: translateX(-50%) translateY(0) rotate(0deg); }
  50% { transform: translateX(-50%) translateY(3px) rotate(25deg); }
  100% { transform: translateX(-50%) translateY(0) rotate(0deg); }
}

.ai-dots span {
  width: 6px;
  height: 6px;
  background: white;
  border-radius: 50%;
  opacity: 0.6;
  animation: dotFlash 1s infinite alternate;
}

.ai-dots span:nth-child(2) { animation-delay: 0.2s; }
.ai-dots span:nth-child(3) { animation-delay: 0.4s; }

@keyframes dotFlash {
  0% { transform: scale(1); opacity: 0.4; }
  100% { transform: scale(1.3); opacity: 1; }
}

/* Avatar blinking effect */
#aiAvatar.blink {
  opacity: 0.3;
  transition: opacity 0.2s;
}

@keyframes mockShake {
  0% { transform: translateX(0); }
  25% { transform: translateX(-5px); }
  50% { transform: translateX(5px); }
  75% { transform: translateX(-5px); }
  100% { transform: translateX(0); }
}

#aiBubble.mocking {
  animation: mockShake 0.6s ease;
}

@keyframes shakeButton {
  0% { transform: translate(0, 0); }
  20% { transform: translate(-3px, 0); }
  40% { transform: translate(3px, 0); }
  60% { transform: translate(-3px, 0); }
  80% { transform: translate(3px, 0); }
  100% { transform: translate(0, 0); }
}

.shaky {
  animation: shakeButton 0.6s infinite;
}

@keyframes pulseGlow {
  0% { box-shadow: 0 0 10px #21cbf3, 0 0 20px #21cbf3; transform: scale(1); }
  50% { box-shadow: 0 0 20px #00ff99, 0 0 30px #00ff99; transform: scale(1.05); }
  100% { box-shadow: 0 0 10px #21cbf3, 0 0 20px #21cbf3; transform: scale(1); }
}

@keyframes colorShift {
  0% { background: linear-gradient(45deg, #2196f3, #21cbf3); }
  50% { background: linear-gradient(45deg, #00e676, #00c853); }
  100% { background: linear-gradient(45deg, #2196f3, #21cbf3); }
}

.power-btn {
  animation: pulseGlow 2s infinite, colorShift 5s infinite;
}

@keyframes countdownColor {
  0% { color: #00c853; }
  50% { color: #ffc107; }
  100% { color: #f44336; }
}

.countdown-animate {
  animation: countdownColor 5s linear forwards;
}

@keyframes scoreBounce {
  0% { transform: scale(0.5); opacity: 0; }
  60% { transform: scale(1.2); opacity: 1; }
  80% { transform: scale(0.9); }
  100% { transform: scale(1); }
}

.bounce-in {
  animation: scoreBounce 1s ease forwards;
}

.golden-btn {
  background: linear-gradient(45deg, #ffd700, #ffb300);
  color: #fff8dc;
  border: none;
  padding: 15px 30px;
  font-size: 1.4rem;
  font-weight: bold;
  border-radius: 16px;
  cursor: pointer;
  box-shadow: 0 0 15px rgba(255, 215, 0, 0.5);
  animation: goldenPulse 2s infinite alternate;
  transition: all 0.3s ease;
}

.golden-btn:hover {
  transform: scale(1.05);
  box-shadow: 0 0 25px rgba(255, 215, 0, 0.8);
}





.score-burst {
  font-size: 4rem;
  font-weight: bold;
  color: #FFD700;
  text-shadow: 0 0 20px #FFEB3B, 0 0 40px orange;
  animation: explode 0.6s ease-out;
  position: relative;
  z-index: 2;
}

@keyframes explode {
  0% { transform: scale(0.2); opacity: 0; }
  60% { transform: scale(1.3); opacity: 1; }
  100% { transform: scale(1); }
}

.sparkle {
  position: absolute;
  width: 10px;
  height: 10px;
  border-radius: 50%;
  background: radial-gradient(circle, #fff, #ff0, #f00);
  animation: sparkle-move 0.7s ease-out forwards;
  opacity: 0.8;
  z-index: 1;
}

@keyframes sparkle-move {
  0% { transform: scale(0.5) translate(0, 0); opacity: 1; }
  100% {
    transform: scale(1.5)
      translate(calc(-50px + 100px * var(--x)),
                calc(-50px + 100px * var(--y)));
    opacity: 0;
  }
}



#finalScoreDisplay.show {
  font-size: 4rem;
  font-weight: 700;
  color: #4b52bb
; /* Ø£Ø²Ø±Ù‚ Ù…Ù„ÙƒÙŠ */
  font-family: 'Rubik', sans-serif;

  text-align: center;
  margin-top: 20px;
  text-shadow: 1px 1px 3px rgba(0, 0, 0, 0.6); /* Ø¸Ù„ Ø®ÙÙŠÙ Ù„Ù„ØªÙˆØ¶ÙŠØ­ */
  animation: explode-scale 0.5s ease-out;
  opacity: 1;
}





@keyframes explode-scale {
  0% { transform: scale(0.1); opacity: 0; }
  60% { transform: scale(1.3); opacity: 1; }
  100% { transform: scale(1); }
}



.score-particle {
  position: absolute;
  width: 10px;
  height: 10px;
  background: gold;
  border-radius: 50%;
  animation: pop 1.2s ease-out forwards;
  opacity: 0.9;
}

@keyframes pop {
  to {
    transform: translate(var(--x), var(--y)) scale(0);
    opacity: 0;
  }
}







@keyframes goldenPulse {
  0% { box-shadow: 0 0 10px rgba(255, 215, 0, 0.6); }
  100% { box-shadow: 0 0 20px rgba(255, 215, 0, 1); }
}

.welcome-btn {
  font-size: 1.2rem;
  padding: 12px 24px;
  border-radius: 8px;
  border: none;
  background: #2196F3;
  color: white;
  cursor: pointer;
  transition: background 0.3s;
}

.welcome-btn:hover {
  background: #1976D2;
}


.welcome-btn:hover {
  transform: scale(1.05);
  box-shadow: 0 6px 18px rgba(0,0,0,0.2);
}






.welcome-card {
  display: contents; /* ğŸ”¥ Ø§Ù„Ø³Ø­Ø± Ù‡Ù†Ø§ */
}




    </style>
    <!-- Ø¶Ø¹ Ù‡Ø°Ù‡ Ø§Ù„Ø£Ø³Ø·Ø± Ù‚Ø¨Ù„ </head> -->
<meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
<style>
  * {
    -webkit-tap-highlight-color: transparent;
    touch-action: manipulation;
  }
  
  



body {
  margin: 0;
  
  font-family: 'Segoe UI', sans-serif;
  background: #eef6fb;
  height: 100vh;
  overflow: hidden;
  display: block; /* âœ… Ù…Ù‡Ù… Ø¬Ø¯Ø§Ù‹ */
}



html, body {
  margin: 0;
  padding: 0;
  height: 100%;
  background: black;
}

body {
  padding-top: env(safe-area-inset-top);
  padding-bottom: env(safe-area-inset-bottom);
  padding-left: env(safe-area-inset-left);
  padding-right: env(safe-area-inset-right);
}


</style>

<!-- Ø¥Ø¶Ø§ÙØ© Ù‡Ø°Ù‡ Ø§Ù„Ø£Ø³Ø·Ø± -->
<meta http-equiv="X-UA-Compatible" content="IE=edge">
<meta name="mobile-web-app-capable" content="yes">
<meta name="apple-mobile-web-app-capable" content="yes">
<script>
window.addEventListener("DOMContentLoaded", async () => {

  // âœ… ØªÙØ¹ÙŠÙ„ Ø§Ù„ØµÙˆØª Ù…Ù† Ø£ÙˆÙ„ Ù„Ù…Ø³Ø©
 ["touchstart", "click", "pointerdown"].forEach(evt => {
  document.body.addEventListener(evt, () => {
    try {
      if (SoundManager?.context?.state === "suspended") {
        SoundManager.context.resume().then(() => {
          console.log(`ğŸ”Š AudioContext resumed by ${evt}`);

          // ğŸ§  ØªØ³Ø®ÙŠÙ† ØµÙˆØª buttonClick Ù„ØªÙØ§Ø¯ÙŠ Ø§Ù„Ù„Ø§Ø¬
          const source = SoundManager.context.createBufferSource();
          source.buffer = SoundManager.buffers["buttonClick"];
          source.connect(SoundManager.context.destination);
          source.start(0);
          source.stop(SoundManager.context.currentTime + 0.05);
        });
      }
    } catch (err) {
      console.warn("âš ï¸ resume Ø£Ùˆ Ø§Ù„ØªØ³Ø®ÙŠÙ† ÙØ´Ù„:", err);
    }
  }, { once: true });
});


  // âœ… ØªØ­Ù…ÙŠÙ„ ÙØ¹Ù„ÙŠ ÙˆØ§Ù†ØªØ¸Ø§Ø±
  const splash = document.getElementById("splashScreen");

  const MIN_DISPLAY = 2200;
  const MAX_WAIT = 7000;

  const waitMinTime = new Promise(res => setTimeout(res, MIN_DISPLAY));
  const preload = preloadEverything();


  const maxWait = new Promise(res => setTimeout(res, MAX_WAIT));

  await Promise.race([
    Promise.all([preload, waitMinTime]),
    maxWait
  ]);

  splash.classList.add("fade-out");
  setTimeout(() => {
    splash.style.display = "none";
    goToNextScreen();
   const firstVisitDone = localStorage.getItem("firstVisitDone");
if (firstVisitDone === "true") {
  setTimeout(() => {
    showAIReaction('lateOpen');
  }, 1000);
}


  }, 700);

});

async function preloadEverything() {
  await SoundManager.loadSounds();

 const imagePaths = [
  "assets/ai_default.png",
  "assets/ai_happy.png",
  "assets/ai_angry.png",
  "assets/ai_thinking.png",
  "assets/ai_worried.png",
  "assets/ai_smile.png",
  "assets/ai_shocked.png",
  "assets/ai_embarrassed.png",
  "assets/ai_jokey.png",
 ];


  const soundPaths = [
    "assets/sounds/button-click.mp3",
    "assets/sounds/shape-pick.mp3",
    "assets/sounds/singleClear.mp3",
    "assets/sounds/combo-clear.mp3",
    "assets/sounds/bubble-appear.mp3"
  ];

  await Promise.all(
    imagePaths.map((src) => {
      return new Promise((resolve) => {
        const img = new Image();
        img.onload = resolve;
        img.onerror = resolve;
        img.src = src;
      });
    })
  );

  await Promise.all(
    soundPaths.map((src) => {
      return new Promise((resolve) => {
        const audio = new Audio();
        audio.onloadeddata = resolve;
        audio.onerror = resolve;
        audio.src = src;
      });
    })
  );

  // âœ… ØªØ­Ù…ÙŠÙ„ Ù…Ù„Ù Ø§Ù„Ø¬Ù…Ù„ Ø§Ù„ØªÙØ§Ø¹Ù„ÙŠØ© Ø­Ø³Ø¨ Ø§Ù„Ù„ØºØ© + Ø§Ù„Ù†ÙˆØ¹
  await new Promise((resolve) => {
  loadAllAIResponses(resolve); // â¬…ï¸ Ø§Ø³ØªØ®Ø¯Ø§Ù… Ø¯Ø§Ù„Ø© Ø§Ù„ØªØ­Ù…ÙŠÙ„ Ø§Ù„Ø°ÙƒÙŠØ©
});


  await new Promise((resolve) => {
    const script = document.createElement("script");
   const savedData = JSON.parse(localStorage.getItem("blockPlayerData") || "{}");
const lang = savedData.language || "ar";
const gender = savedData.gender || "male";
const playerType = `${lang}_${gender}`;

script.src = `ai_responses/aiResponses_${playerType}.js`;



    script.onload = () => {
  console.log("âœ… ØªÙ… ØªØ­Ù…ÙŠÙ„ Ù…Ù„Ù Ø§Ù„Ø¬Ù…Ù„:", script.src);
  
  // âœ… Ø¯Ù…Ø¬ Ø§Ù„Ø¬Ù…Ù„ ÙŠØ¯ÙˆÙŠÙ‹Ø§ Ù…Ù† tempAIResponses
  if (window.tempAIResponses) {
    window.allAIResponses = window.allAIResponses || {};
    window.allAIResponses[playerType] = window.tempAIResponses;
    console.log("ğŸ“¥ ØªÙ… Ù†Ù‚Ù„ Ø§Ù„Ø¬Ù…Ù„ Ø¥Ù„Ù‰ allAIResponses:", playerType);
  } else {
    console.warn("âš ï¸ tempAIResponses Ù…Ø´ Ù…ÙˆØ¬ÙˆØ¯ Ø¯Ø§Ø®Ù„ Ø§Ù„Ù…Ù„Ù:", script.src);
  }

  if (typeof reloadAIResponses === "function") reloadAIResponses();
  resolve();
};

    script.onerror = () => {
      console.error("âŒ ÙØ´Ù„ ØªØ­Ù…ÙŠÙ„ Ù…Ù„Ù Ø§Ù„Ø¬Ù…Ù„:", script.src);
      resolve();
    };
    document.head.appendChild(script);
  });

  await new Promise((res) => setTimeout(res, 300));
}


// Ø¯Ø§Ù„Ø© Ù„ØªØ­Ø¯ÙŠØ¯ Ø§Ù„ÙˆØ¬Ù‡Ø© Ø¨Ø¹Ø¯ Ø§Ù„ØªØ­Ù…ÙŠÙ„
function goToNextScreen() {
  const data = localStorage.getItem("blockPlayerData");

  if (!data) {
    // Ù„Ùˆ Ø£ÙˆÙ„ Ù…Ø±Ø©ØŒ ÙŠØ¸Ù‡Ø± Ø´Ø§Ø´Ø© Ø§Ø®ØªÙŠØ§Ø± Ø§Ù„Ù„ØºØ© ÙˆØ§Ù„Ø¬Ù†Ø³
    const welcome = document.getElementById("welcomeScreen");
welcome.classList.remove("hidden");
welcome.style.display = "flex";

  } else {
    // ÙŠÙØªØ­ Ø§Ù„Ù‚Ø§Ø¦Ù…Ø© Ø§Ù„Ø±Ø¦ÙŠØ³ÙŠØ© ÙÙ‚Ø·ØŒ Ø¨Ø¯ÙˆÙ† Ø¨Ø¯Ø¡ Ø§Ù„Ù„Ø¹Ø¨Ø©
    const menu = document.getElementById("mainMenu");
if (menu) {
  menu.style.display = "block";
} else {
  console.warn("âš ï¸ Ø¹Ù†ØµØ± mainMenu Ù…Ø´ Ù…ÙˆØ¬ÙˆØ¯ ÙÙŠ Ø§Ù„ØµÙØ­Ø©!");
}


   
  }
}




  // Ø­Ù„ Ù†Ù‡Ø§Ø¦ÙŠ Ù„ØªØ­Ø³ÙŠÙ† Ø§Ù„Ø£Ø¯Ø§Ø¡
if ('connection' in navigator) {
  if (navigator.connection.saveData || navigator.connection.effectiveType.includes('2g')) {
    document.body.classList.add('low-performance');
  }
}


/*** Ø§Ø¨Ø¯Ø£ Ø¥Ø¶Ø§ÙØ© Ù‡Ø°Ø§ Ø§Ù„ÙƒÙˆØ¯ ***/
// ØªØ­Ø³ÙŠÙ† ØªØ­Ù…ÙŠÙ„ Ø§Ù„ØµÙˆØ± (Ø¥Ø°Ø§ ÙˆØ¬Ø¯Øª)
const images = document.querySelectorAll('img');
if (images.length > 0) {
  images.forEach(img => {
    img.loading = 'eager';
    img.decoding = 'async';
  });
}
/*** Ø§Ù†ØªÙ‡Ù‰ Ø§Ù„ÙƒÙˆØ¯ Ø§Ù„Ù…Ø¶Ø§Ù ***/

// Ø¨Ø¹Ø¯ ØªØ­Ù…ÙŠÙ„ Ø§Ù„Ø¹Ù†Ø§ØµØ±

const Pan = new Hammer.Pan({ threshold: 5 });







 
  

document.addEventListener("visibilitychange", function () {
  if (document.hidden) {
    console.log("â¸ï¸ ØªÙ… Ø§Ù„Ø®Ø±ÙˆØ¬ Ù…Ù† Ø§Ù„Ù„Ø¹Ø¨Ø© Ø£Ùˆ Ø¥Ø·ÙØ§Ø¡ Ø§Ù„Ø´Ø§Ø´Ø©");

    // â›” Ø£ÙˆÙ‚Ù Ø§Ù„Ø£Ø­Ø¯Ø§Ø« Ø§Ù„ØªÙØ§Ø¹Ù„ÙŠØ©
    isGameRunning = false;

    // â›” Ø£ÙØ±Øº Ø·Ø§Ø¨ÙˆØ± Ø§Ù„Ø¬Ù…Ù„
    messageQueue = [];
    isShowingMessage = false;

    // â›” Ø£Ø®ÙÙŠ Ø¹Ù†Ø§ØµØ± Ø§Ù„Ø§ÙØªØ§Ø±
    document.getElementById("aiBubble")?.classList.add("hidden");
    document.getElementById("aiBoard")?.classList.add("hidden");
    document.getElementById("aiText")?.classList.remove("show");

    // â›” Ø£ÙˆÙ‚Ù Ø§Ù„ØµÙˆØª
    if (SoundManager?.context?.state === "running") {
      SoundManager.context.suspend().then(() => {
        console.log("ğŸ”‡ ØªÙ… Ø¥ÙŠÙ‚Ø§Ù Ø§Ù„ØµÙˆØª Ù…Ø¤Ù‚ØªÙ‹Ø§");
      });
    }
  } else {
    console.log("â–¶ï¸ ØªÙ… Ø§Ù„Ø±Ø¬ÙˆØ¹ Ù„Ù„Ø¹Ø¨Ø©");

    // âœ… Ø§Ø³ØªØ¦Ù†Ø§Ù Ø§Ù„ØµÙˆØª Ø¹Ù†Ø¯ Ø§Ù„Ø±Ø¬ÙˆØ¹
    if (SoundManager?.context?.state === "suspended") {
      SoundManager.context.resume().then(() => {
        console.log("ğŸ”Š ØªÙ… Ø§Ø³ØªØ¦Ù†Ø§Ù Ø§Ù„ØµÙˆØª");
      });
    }

    // âœ… Ø£Ø¹Ø¯ ØªÙØ¹ÙŠÙ„ Ø§Ù„Ù„Ø¹Ø¨ ÙÙ‚Ø· Ù„Ùˆ ÙƒØ§Ù†Øª Ø§Ù„Ø´Ø§Ø´Ø© Ù‡ÙŠ Ø´Ø§Ø´Ø© Ø§Ù„Ø¬ÙŠÙ…
    const gameScreen = document.getElementById("game");
    if (gameScreen.classList.contains("active")) {
      isGameRunning = true;
    }
  }
});




</script>




<script>
  // ØªØ­Ù…ÙŠÙ„ Ø§Ù„Ø¹Ù†Ø§ØµØ± Ø§Ù„Ø­Ø±Ø¬Ø© Ø£ÙˆÙ„Ø§Ù‹ (ÙŠÙ‚Ù„Ù„ Ø§Ù„ØªÙˆÙ‚Ù)
  document.addEventListener('DOMContentLoaded', () => {
   

    const criticalAssets = [
      'assets/ai_default.png',
      'assets/sounds/button-click.mp3'
    ];
    
    criticalAssets.forEach(asset => {
      const link = document.createElement('link');
      link.rel = 'preload';
      link.as = asset.includes('.mp3') ? 'audio' : 'image';
      link.href = asset;
      document.head.appendChild(link);
    });
  });
  </script>



</head>
<body>
   <div id="splashScreen" class="splash-screen">
    <img src="assets/nova_logo.png" alt="NovaCode Studio Logo" class="studio-logo">
   
  </div><div class="welcome-screen" id="welcomeScreen">
  <div class="welcome-card enhanced-welcome">
    <h2 class="welcome-title" id="welcomeText" style="display: none;"></h2>

    <div id="langButtons" class="btn-group">
      <button onclick="chooseLanguage('ar')" class="hero-btn">ğŸ‡¸ğŸ‡¦ Ø¹Ø±Ø¨ÙŠ</button>
      <button onclick="chooseLanguage('en')" class="hero-btn">ğŸ‡ºğŸ‡¸ English</button>
    </div>

    <div id="step2" class="step" style="display: none;">
      <p id="genderText">ğŸ‘¤ Ø¥Ù†Øª ÙˆÙ„Ø¯ ÙˆÙ„Ø§ Ø¨Ù†ØªØŸ</p>
      <div class="btn-group">
        <button onclick="chooseGender('male')" class="hero-btn">ğŸš¹ ÙˆÙ„Ø¯</button>
        <button onclick="chooseGender('female')" class="hero-btn">ğŸšº Ø¨Ù†Øª</button>
      </div>
    </div>

    <div id="finalStep" style="display:none;"></div>
  </div>
</div>
!-- Ù†Ù‡Ø§ÙŠØ© welcomeScreen -->

<!-- Ù‡Ù†Ø§ ØªØ­Ø· Ø´Ø§Ø´Ø© avatarIntroScreen Ø§Ù„Ø¬Ø¯ÙŠØ¯Ø© -->
<div class="welcome-screen hidden" id="avatarIntroScreen">
  <div id="avatarWrapper" style="display:flex;flex-direction:column;align-items:center;justify-content:center;height:100%;gap:20px;">
    
    <div id="introAiBubble" class="ai-bubble show" style="width:120px;height:120px;">
      <div class="bubble-inner" style="width:100%;height:100%;">
        <img id="introAiAvatar" src="assets/ai_default.png" alt="AI" style="width:90px;height:90px;"/>
        <div class="ai-dots">
          <span></span><span></span><span></span>
        </div>
      </div>
    </div>
    
    <div id="introAiBoard" class="show" style="
  background: white;
  padding: 20px;
  border-radius: 20px;
  box-shadow: 0 4px 12px rgba(0,0,0,0.1);
  width: 90%;
  max-width: 400px;
  height: 180px;
  display: flex;
  align-items: center;
  justify-content: center;
  overflow: hidden;">

      <div id="introAiText" style="font-size:1.3rem;color:#2196F3;line-height:1.5;text-align:center;word-wrap:break-word;"></div>
    </div>

  </div>
</div>



  <!-- Screens -->
  <div class="screen active" id="mainMenu">

    <div class="menu-content">
      <h1 class="game-title">Block Puzzle AI</h1>
      <button class="btn start-btn" onclick="startGame()">Ø§Ø¨Ø¯Ø£ Ø±Ø­Ù„ØªÙŠ</button>
      <button class="btn stats-btn" onclick="showPlayerStats()">ğŸ“ˆ Ø¨ÙŠØ§Ù†Ø§ØªÙŠ</button>
   

      <p class="copyright">By: NovaCode Studio Â© 2025</p>
  
      <div id="adBanner" style="width:100%; height:50px; background:#e6e6e6; display:flex; align-items:center; justify-content:center; font-size:14px; color:#333; margin-top: 20px;">
        Ø¥Ø¹Ù„Ø§Ù† ØªØ¬Ø±ÙŠØ¨ÙŠ Ù‡Ù†Ø§ (Banner)
      </div>
    </div>
  </div>
  
  <div class="screen" id="game">
    <button id="backToMenuBtn" onclick="backToMenu()" class="back-home-btn">
      <svg viewBox="0 0 24 24" width="24" height="24">
        <path d="M19 12H5M12 19l-7-7 7-7" stroke="#2196F3" stroke-width="2"/>
      </svg>
    </button>
    
    <div id="scoreboard">Score: 0</div>
    
    <!-- AI Interactive Area -->
    <div id="aiContainer">
      <div id="aiInteractiveArea">
        <div id="aiBubble" class="ai-bubble hidden">
          <div class="bubble-inner">
            <img id="aiAvatar" src="assets/ai_default.png" alt="AI" />
            <div class="ai-dots">
              <span></span><span></span><span></span>
            </div>
          </div>
        </div>
        
        <div id="aiBoard" class="hidden">
          <div id="aiText"></div>
          
        </div>
      </div>
    </div>
    
    <div id="grid"></div>
    <div id="shapes"></div>
  </div>
<div id="resumeCountdownBarContainer"><div id="resumeCountdownBar"></div></div>

<p id="countdown"></p>


  <div class="screen" id="gameover">
    <h1>Game Over</h1>
    <div id="finalScoreDisplay"></div>
    
    <button class="golden-btn" id="resumeBtn" onclick="resumeGame()">âœ¨ Ø§Ø³ØªÙƒÙ…Ù„ Ø§Ù„Ù„Ø¹Ø¨</button>
    <button class="btn" id="restartBtn" style="display:none;" onclick="restartGame()">Ø§Ø¨Ø¯Ø£ Ù…Ù† Ø¬Ø¯ÙŠØ¯</button>
    <button class="btn golden-btn" id="insightBtn" onclick="showInsightReport()" style="margin-top: 10px; font-size: 1.1rem;">ğŸ“˜ Ø§Ù„ØªÙ‚Ø±ÙŠØ± Ø§Ù„Ù†ÙØ³ÙŠ</button>

<p id="countdown" class="countdown-animate" style="display:none;"></p>

<div id="countdownBarContainer">
  <div id="countdownBar"></div>
</div>



   
    <div id="countdownBarContainer">
  <div id="countdownBar"></div>
</div>

  </div>
  
  

  <div id="playerStats" class="welcome-screen" style="display:none;">
  <div class="welcome-card" id="playerStatsCard">
    <h2 id="statsText" class="stats-title">ğŸ“ˆ Ø¨ÙŠØ§Ù†Ø§ØªÙƒ</h2>
    <div id="statsContent" class="stats-content"></div>
    <button class="welcome-btn" id="backBtn" onclick="closeStats()">ğŸ”™ Ø±Ø¬ÙˆØ¹</button>
  </div>
</div>

  

  <div class="welcome-screen hidden fade-in" id="insightScreen">
    <div id="insightWrapper" style="display:flex;flex-direction:column;align-items:center;justify-content:center;height:100%;gap:20px;">
      <div id="insightAiBubble" class="ai-bubble show" style="width:120px;height:120px;">
        <div class="bubble-inner" style="width:100%;height:100%;">
          <img id="insightAiAvatar" src="assets/ai_default.png" alt="AI" style="width:90px;height:90px;"/>
          <div class="ai-dots"><span></span><span></span><span></span></div>
        </div>
      </div>
      <div id="insightAiBoard" class="show" style="
  background: white;
  padding: 20px;
  border-radius: 20px;
  box-shadow: 0 4px 12px rgba(0,0,0,0.1);
  width: 90%;
  max-width: 400px;
  max-height: 70vh;
  min-height: 200px;
  display: flex;
  flex-direction: column;
  align-items: center;
  justify-content: flex-start;
  overflow-y: auto;
  gap: 10px;">

        <div id="insightAiText" style="font-size:1.2rem;color:#2196F3;line-height:1.5;text-align:center;"></div>
      </div>
      <button id="shareInsightBtn" class="welcome-btn hidden" onclick="shareInsight()">ğŸ”— Ø´Ø§Ø±Ùƒ Ø§Ù„ØªØ­Ù„ÙŠÙ„ Ù…Ø¹ ØµØ­Ø§Ø¨Ùƒ</button>
      <button onclick="closeInsight()" class="welcome-btn hidden" id="closeInsightBtn">ğŸ ÙƒÙØ§ÙŠØ© ØªØ­Ù„ÙŠÙ„.. Ù†Ø±Ø¬Ø¹ØŸ</button>
    </div>
  </div>

  

  <div id="aiFlash"></div>
  <script>

function reloadAIResponses() {
  try {
    const savedData = JSON.parse(localStorage.getItem("blockPlayerData")) || {};
    const lang = savedData.language || "ar";
    const gender = savedData.gender || "male";
    const playerType = `${lang}_${gender}`;

    console.log("ğŸ” Ø¥Ø¹Ø§Ø¯Ø© ØªØ­Ù…ÙŠÙ„ Ø§Ù„Ø¬Ù…Ù„ Ù„Ù€:", playerType);

    if (!window.allAIResponses) {
      console.error("âŒ allAIResponses ØºÙŠØ± Ù…ÙˆØ¬ÙˆØ¯");
      window.aiReady = false;
      return;
    }

    if (window.allAIResponses[playerType]) {
      window.aiResponses = window.allAIResponses[playerType];
      window.aiReady = true;
      console.log("âœ… ØªÙ… ØªØ­Ù…ÙŠÙ„", Object.keys(aiResponses).length, "Ø¬Ù…Ù„ ØªÙØ§Ø¹Ù„ÙŠØ©");
    } else {
      console.error("âŒ Ù„Ø§ ÙŠÙˆØ¬Ø¯ Ø±Ø¯ÙˆØ¯ Ù„Ù„Ù†ÙˆØ¹:", playerType);
      window.aiReady = false;
    }
  } catch (error) {
    console.error("âŒ Ø®Ø·Ø£ ÙÙŠ reloadAIResponses:", error);
    window.aiReady = false;
  }
}





function getRandomAIResponse(eventType) {
  if (typeof aiResponses === "undefined" || !aiResponses[eventType]) {
    console.warn(`âš ï¸ aiResponses ØºÙŠØ± Ù…Ø¹Ø±Ù Ø£Ùˆ Ù…ÙÙŠØ´ Ø¬Ù…Ù„ Ù„Ù„Ø­Ø¯Ø«: ${eventType}`);
    return "";
  }

  const responses = aiResponses[eventType];
  const index = Math.floor(Math.random() * responses.length);
  return responses[index];
}





function checkNearLose() {
  const filled = gridCells.filter(cell => cell.classList.contains("filled")).length;
  const ratio = filled / gridCells.length;

  const now = Date.now();
  const oneMinute = 10 * 1000;


  if (ratio >= 0.60 && (now - lastNearLoseTime >= oneMinute)) {
    showAIReaction("nearLose");
    lastNearLoseTime = now;
  }
}





function setupButtonSounds() {
  // Ø±Ø¨Ø· Ø§Ù„ØµÙˆØª Ø¨Ø¬Ù…ÙŠØ¹ Ø§Ù„Ø£Ø²Ø±Ø§Ø± ÙÙŠ Ø§Ù„ØµÙØ­Ø©
  document.querySelectorAll('button').forEach(button => {
    button.addEventListener('click', () => {
      SoundManager.play('buttonClick');
    });
  });
  
  // Ø±Ø¨Ø· Ø§Ù„ØµÙˆØª Ø¨Ø§Ù„Ø¹Ù†Ø§ØµØ± Ø§Ù„Ø£Ø®Ø±Ù‰ Ø§Ù„ØªÙŠ ØªØªØµØ±Ù Ù…Ø«Ù„ Ø§Ù„Ø£Ø²Ø±Ø§Ø±
  document.querySelectorAll('[onclick]').forEach(el => {
    if (el.tagName !== 'BUTTON') {
      el.addEventListener('click', () => {
        SoundManager.play('buttonClick');
      });
    }
  });
}



// ğŸ”Š Ø±Ø¨Ø· Ø¬Ù…ÙŠØ¹ Ø§Ù„Ø£Ø²Ø±Ø§Ø± Ø¨ØªØ´ØºÙŠÙ„ Ø§Ù„ØµÙˆØª
document.addEventListener('click', function(event) {
  const el = event.target.closest('button, .btn, [role="button"], [onclick]');
  if (el && !el.classList.contains('no-sound')) {
    SoundManager.play('buttonClick');
  }
});


    </script>
    

    <!-- AI Reaction Elements -->




  <script>

    // Ø¯Ø§Ù„Ø© Ø°ÙƒÙŠØ© ØªØªØ¹Ù‚Ø¨ Ø¬Ù…ÙŠØ¹ Ø§Ù„Ù†Ù‚Ø±Ø§Øª ÙÙŠ Ø§Ù„ØµÙØ­Ø©

    // Ø§Ù„ÙƒÙˆØ¯ Ø§Ù„Ø£Ø³Ø§Ø³ÙŠ Ù„Ù„Ø¹Ø¨Ø© ÙŠØ¨Ù‚Ù‰ ÙƒÙ…Ø§ Ù‡Ùˆ Ø¨Ø¯ÙˆÙ† ØªØºÙŠÙŠØ±
    // ÙÙ‚Ø· ÙŠØªÙ… ØªØ¹Ø¯ÙŠÙ„ Ø¯Ø§Ù„Ø© showAIReaction Ù„ØªØªÙ†Ø§Ø³Ø¨ Ù…Ø¹ Ø§Ù„ØªØµÙ…ÙŠÙ… Ø§Ù„Ø¬Ø¯ÙŠØ¯
let isGameRunning = false;
let isTouchActive = false;
let lastLineClearTime = 0;
let shapesSinceLastClear = 0;
let failedShapePlacements = 0;
let uselessShapesInARow = 0;
let countingUselessShapes = false; // â† Ù†Ø¨Ø¯Ø£ Ø§Ù„Ø¹Ø¯ Ø¨Ø¹Ø¯ Ø£ÙˆÙ„ Ù†Ø¬Ø§Ø­
let lastNearLoseTime = 0;
let smallClearsInARow = 0;
let lastSecretTime = 0;
let lastJokeyTime = 0;
let lastAIReactionTime = 0; // â† Ø¨ÙŠØªØ­Ø¯Ø« ÙƒÙ„ Ù…Ø§ AI ÙŠØªÙƒÙ„Ù…
let lastAIEventType = null;
let messageQueue = [];
let isShowingMessage = false;

const eventPriority = {
  nearLose: 5,
  angry: 4,
  embarrassed: 3,
  combo: 3,
  lineClear: 2,
  jokey: 1,
  idle: 0,
  secret: 1
};

function showAIReaction(eventType) {
    const aiEnabled = localStorage.getItem("aiModeEnabled") !== "false";
  if (!aiEnabled) return;

  if (!isGameRunning && eventType !== "combo") return;


  if (eventType === 'lateOpen') {
    showSingleAIReaction(eventType);
    return;
  }

  // âœ… Ù„Ø§ Ù†Ø³Ù…Ø­ Ø¨ØªÙƒØ±Ø§Ø± Ù†ÙØ³ Ø§Ù„Ø­Ø¯Ø« Ø¥Ù„Ø§ Ø¥Ø°Ø§ Ø§Ù„Ø·Ø§Ø¨ÙˆØ± ÙØ§Ø¶ÙŠ
  const alreadyShown = (eventType === lastAIEventType);
  const queueFull = isShowingMessage || messageQueue.length > 0;

  if (alreadyShown && queueFull) {
    console.log("ğŸš« ØªÙ… ØªØ¬Ø§Ù‡Ù„ ØªÙƒØ±Ø§Ø± Ø§Ù„Ø­Ø¯Ø« ÙÙŠ Ø§Ù„Ø²Ø­Ù…Ø©:", eventType);
    return;
  }

  if (isShowingMessage) {
    if (messageQueue.length === 0) {
      messageQueue.push(eventType);
    } else {
      const current = messageQueue[0];
      if (eventPriority[eventType] > eventPriority[current]) {
        messageQueue[0] = eventType;
      }
    }
    return;
  }

  showSingleAIReaction(eventType);
}

function processMessageQueue() {
  if (messageQueue.length === 0) {
    isShowingMessage = false;
    return;
  }

  const next = messageQueue.shift();
  showSingleAIReaction(next);
}

function showSingleAIReaction(eventType) {
  isShowingMessage = true;
  lastAIReactionTime = Date.now();

  const aiBubble = document.getElementById("aiBubble");
  const aiBoard = document.getElementById("aiBoard");
  const aiText = document.getElementById("aiText");
  const aiAvatar = document.getElementById("aiAvatar");
  const heatBar = document.getElementById("aiHeatBar");

  // âœ… ØªØºÙŠÙŠØ± Ø§Ù„ØµÙˆØ±Ø© Ø­Ø³Ø¨ Ø§Ù„Ø­Ø¯Ø«
  const avatarMap = {
    idle: "ai_thinking.png",
    combo: "ai_happy.png",
    lineClear: "ai_smile.png",
    nearLose: "ai_worried.png",
    angry: "ai_angry.png",
    shocked: "ai_shocked.png",
    embarrassed: "ai_embarrassed.png",
    default: "ai_default.png"
  };

  aiAvatar.src = `assets/${avatarMap[eventType] || avatarMap.default}`;

  // âœ… ØªØ´ØºÙŠÙ„ ØµÙˆØª Ø§Ù„ÙÙ‚Ø§Ø¹Ø©
const message = getRandomAIResponse(eventType);
if (!message) {
  isShowingMessage = false;
  return;
}

if (isGameRunning) {
  SoundManager.play("bubbleAppear");
}



  // âœ… Ø¹Ø±Ø¶ Ø§Ù„Ø¹Ù†Ø§ØµØ± Ø¨ØµØ±ÙŠÙ‹Ø§
  aiBubble.classList.remove("hidden");
  aiBubble.classList.add("show");

  aiBoard.classList.remove("hidden");
  aiBoard.classList.add("show");

  aiText.textContent = message;
  aiText.classList.add("show");

  

  // Ù…Ø¯Ø© Ø¹Ø±Ø¶ Ø§Ù„Ø¬Ù…Ù„Ø© ÙˆØ§Ù„ØªØ£Ø«ÙŠØ±Ø§Øª
  const DISPLAY_TIME = 3500 + Math.floor(Math.random() * 1500); // Ù…Ù† 3.5 Ø¥Ù„Ù‰ 5 Ø«ÙˆØ§Ù†ÙŠ


  setTimeout(() => {
    aiBubble.classList.remove("show");
    aiBubble.classList.add("hide");

    aiBoard.classList.remove("show");
    aiBoard.classList.add("hide");

    aiText.classList.remove("show");
    

    setTimeout(() => {
      aiBubble.classList.remove("hide");
      aiBubble.classList.add("hidden");

      aiBoard.classList.remove("hide");
      aiBoard.classList.add("hidden");

      isShowingMessage = false;
      processMessageQueue();
    }, 500); // â† ØªØ·Ø§Ø¨Ù‚ Ù…Ø¹ ØªØ£Ø«ÙŠØ± Ø§Ù„Ø®Ø±ÙˆØ¬
  }, DISPLAY_TIME);
  lastAIEventType = eventType;

}




    // Ø¨Ø§Ù‚ÙŠ ÙƒÙˆØ¯ Ø§Ù„Ù„Ø¹Ø¨Ø© ÙŠØ¨Ù‚Ù‰ ÙƒÙ…Ø§ Ù‡Ùˆ Ø¨Ø¯ÙˆÙ† ØªØºÙŠÙŠØ±
  

    const gameTranslations = {
      ar: {
        startBtn: "Ø§Ø¨Ø¯Ø£ Ø±Ø­Ù„ØªÙŠ",
        statsBtn: "ğŸ“ˆ Ø¨ÙŠØ§Ù†Ø§ØªÙŠ",
        scoreText: "Ø§Ù„Ù†Ù‚Ø§Ø·: ",
        gameOver: "Ø§Ù†ØªÙ‡Øª Ø§Ù„Ù„Ø¹Ø¨Ø©",
        resumeBtn: "Ø§Ø³ØªÙƒÙ…Ù„ Ø§Ù„Ù„Ø¹Ø¨ (Ø¥Ø¹Ù„Ø§Ù†)",
        restartBtn: "Ù„Ø¹Ø¨Ø© Ø¬Ø¯ÙŠØ¯Ø©",
        countdownText: "Ø£Ùˆ Ø§Ù†ØªØ¸Ø± 5 Ø«ÙˆØ§Ù†ÙŠ...",
        aiThinking: "ğŸ¤– ÙŠÙÙƒØ±...",
        statsTitle: "Ø¨ÙŠØ§Ù†Ø§Øª Ø§Ù„Ù„Ø§Ø¹Ø¨",
        backBtn: "ğŸ”™ Ø±Ø¬ÙˆØ¹",
        levelMessage: "Ù…Ø³ØªÙˆØ§Ùƒ: Ø¹Ø§Ù„Ù…ÙŠ"
      },
      en: {
        startBtn: "Start My Journey",
        statsBtn: "ğŸ“ˆ My Stats",
        scoreText: "Score: ",
        gameOver: "Game Over",
        resumeBtn: "Resume Game (Ad)",
        restartBtn: "Start New Game",
        countdownText: "Or wait 5 seconds...",
        aiThinking: "ğŸ¤– Thinking...",
        statsTitle: "Player Stats",
        backBtn: "ğŸ”™ Back",
        levelMessage: "Your Level: Pro"
      }
    };

    let gridCells = [], shapesInHand = [], shapesUsed = 0, score = 0;
    let difficultyLevel = 1;
    let floatingStartX = 0, floatingStartY = 0, pointerStartX = 0, pointerStartY = 0;
    let aiInternalNotes = [];
let isSoundOn = true; // â† Ù‡Ø°Ø§ Ø§Ù„Ø³Ø·Ø± Ù‡Ù†Ø§
    let aiMemory = {
      context: [],
      mood: "neutral",
      lastEvent: null,
      intensity: 0
    };

    let playerBehavior = {
  fastMoves: 0,
  slowMoves: 0,
  perfectClears: 0,
  nearFails: 0,
  lastMoveTime: null,
  avgSpeed: 0,
  totalMoves: 0,
  failedAttempts: 0,
  lastShapeCode: null,
  repeatedShapeCount: 0
};



let lastActivityTime = Date.now(); // â±ï¸ Ù„ØªØªØ¨Ø¹ Ø¢Ø®Ø± Ù†Ø´Ø§Ø· Ù„Ù„Ù‘Ø§Ø¹Ø¨

    let currentShape = null, sourceElement = null, floating = null;
    let offset = { x: 0, y: 0 }, resumed = false, monitorInterval = null;
let animationFrameId = null;

    const grid = document.getElementById("grid");
    const shapesDiv = document.getElementById("shapes");
    const scoreboard = document.getElementById("scoreboard");
    const finalScoreDisplay = document.getElementById("finalScoreDisplay");
    const resumeBtn = document.getElementById("resumeBtn");
    const restartBtn = document.getElementById("restartBtn");
    const countdownEl = document.getElementById("countdown");
/*** Ø§Ø¨Ø¯Ø£ Ø¥Ø¶Ø§ÙØ© Ù‡Ø°Ø§ Ø§Ù„ÙƒÙˆØ¯ ***/
const canvas = document.querySelector('canvas');
if (canvas) {
  canvas.style.imageRendering = 'pixelated';
  canvas.style.transform = 'translateZ(0)';
}
/*** Ø§Ù†ØªÙ‡Ù‰ Ø§Ù„ÙƒÙˆØ¯ Ø§Ù„Ù…Ø¶Ø§Ù ***/
  const screens = {
  menu: document.getElementById("mainMenu"),
  game: document.getElementById("game"),
  gameover: document.getElementById("gameover")
};


    const weightedShapes = [
  { shape: [[0,0]], weight: 1 }, // Ù†Ù‚Ø·Ø© ÙˆØ§Ø­Ø¯Ø©
  { shape: [[0,0],[1,0]], weight: 1 }, // Ø®Ø· Ø±Ø£Ø³ÙŠ Ù…ÙƒÙˆÙ† Ù…Ù† Ù†Ù‚Ø·ØªÙŠÙ†
  { shape: [[0,0],[0,1]], weight: 1 }, // Ø®Ø· Ø£ÙÙ‚ÙŠ Ù…ÙƒÙˆÙ† Ù…Ù† Ù†Ù‚Ø·ØªÙŠÙ†
  { shape: [[0,0],[1,0],[0,1]], weight: 1 }, // Ø´ÙƒÙ„ L ØµØºÙŠØ±
  { shape: [[0,0],[1,0],[2,0]], weight: 4 }, // Ø®Ø· Ø±Ø£Ø³ÙŠ Ù…ÙƒÙˆÙ† Ù…Ù† 3 Ù†Ù‚Ø§Ø·
  { shape: [[0,0],[0,1],[0,2]], weight: 4 }, // Ø®Ø· Ø£ÙÙ‚ÙŠ Ù…ÙƒÙˆÙ† Ù…Ù† 3 Ù†Ù‚Ø§Ø·
  { shape: [[0,0],[1,0],[1,1]], weight: 2 }, // Ø´ÙƒÙ„ Ø²Ø§ÙˆÙŠØ© ÙŠÙ…ÙŠÙ† ØªØ­Øª
  { shape: [[0,0],[0,1],[1,1]], weight: 2 }, // Ø´ÙƒÙ„ Ø²Ø§ÙˆÙŠØ© ÙŠØ³Ø§Ø± ØªØ­Øª
  { shape: [[0,0],[1,0],[2,0],[0,1],[1,1],[2,1]], weight: 7 }, // Ù…Ø³ØªØ·ÙŠÙ„ 2x3
  { shape: [[0,0],[1,0],[2,0],[1,1]], weight: 1 }, // Ø´ÙƒÙ„ T Ù…Ù‚Ù„ÙˆØ¨
  { shape: [[0,0],[0,1],[1,1],[2,1]], weight: 2 }, // Ø´ÙƒÙ„ Ø³Ù‡Ù… Ù„Ù„ÙŠÙ…ÙŠÙ†
  { shape: [[0,0],[1,0],[2,0],[3,0]], weight: 3 }, // Ø®Ø· Ø±Ø£Ø³ÙŠ Ø·ÙˆÙŠÙ„ 4 Ù†Ù‚Ø§Ø·
  { shape: [[0,0],[0,1],[0,2],[0,3]], weight: 3 }, // Ø®Ø· Ø£ÙÙ‚ÙŠ Ø·ÙˆÙŠÙ„ 4 Ù†Ù‚Ø§Ø·
  { shape: [[0,0],[1,0],[0,1],[1,1]], weight: 7 }, // Ù…Ø±Ø¨Ø¹ 2x2
  { shape: [[0,0],[1,0],[2,0],[0,1],[1,1],[2,1],[0,2],[1,2],[2,2]], weight: 7 }, // Ù…Ø±Ø¨Ø¹ 3x3
  { shape: [[0,0],[0,1],[0,2],[1,2],[2,2]], weight: 1 }, // Ø´ÙƒÙ„ L Ù…Ø¹ÙƒÙˆØ³ ÙƒØ¨ÙŠØ±
  { shape: [[0,0],[2,0],[0,1],[2,1],[0,2],[1,2],[2,2]], weight: 0.5 }, // Ø´ÙƒÙ„ U
  { shape: [[0,0],[1,0],[2,0],[1,1],[1,2]], weight: 2 }, // Ø´ÙƒÙ„ +
  { shape: [[0,0],[1,0],[1,1],[1,2],[2,2]], weight: 0.5 }, // Ø´ÙƒÙ„ S Ù…Ø§Ø¦Ù„
  { shape: [[0,0],[0,1],[1,1],[1,2],[2,2]], weight: 0.5 }  // Ø´ÙƒÙ„ Z Ù…Ø§Ø¦Ù„
];


  function switchScreen(screen) {
  if (!screens[screen]) {
    console.error(`âŒ Ø§Ù„Ø´Ø§Ø´Ø© '${screen}' Ù…Ø´ Ù…Ø¹Ø±ÙØ© Ø¯Ø§Ø®Ù„ screens object`);
    return;
  }

  Object.values(screens).forEach(s => s.classList.remove("active"));
  screens[screen].classList.add("active");
}

function startGame() {
  isGameRunning = true;
  console.log("ğŸ® ØªÙ… ØªØ´ØºÙŠÙ„ startGame()");
  gameStartTime = Date.now();
  lastActivityTime = Date.now();

  if (!window.aiReady) {
    console.log("Ù„Ø³Ù‡ Ù…Ø³ØªÙ†ÙŠ ØªØ­Ù…ÙŠÙ„ Ø§Ù„Ø¬Ù…Ù„...");
    setTimeout(startGame, 100);
    clearPreview();
    shapesDiv.innerHTML = "";
    return; // â›” Ø¥Ù†Ù‡Ø§Ø¡ Ù…Ø¨ÙƒØ± Ù‚Ø¨Ù„ ØªÙ†ÙÙŠØ° Ø£ÙŠ Ø´ÙŠØ¡ Ø¢Ø®Ø±
  }
  

  // âœ… Ø¨Ø¯Ø¡ Ù…Ø±Ø§Ù‚Ø¨Ø© Ø§Ù„Ø®Ù…ÙˆÙ„ (Ø§Ù„Ù…Ù„Ù„)
  setInterval(() => {
    if (Date.now() - lastActivityTime > 17000) {
      showAIReaction("idle");
      lastActivityTime = Date.now(); // Ù…Ù†Ø¹ Ø§Ù„ØªÙƒØ±Ø§Ø± Ø§Ù„Ø³Ø±ÙŠØ¹
    }
  }, 4000);

  // âœ… Ø¨Ø¯Ø¡ Ù…Ø±Ø§Ù‚Ø¨Ø© Ø§Ù„Ø¬ÙŠÙ… Ø£ÙˆÙØ± Ø¨Ø¹Ø¯ Ø§Ù„ØªØ£ÙƒØ¯ Ù…Ù† Ø¬Ø§Ù‡Ø²ÙŠØ© AI
  startGameOverWatcher();

  resumed = false;

  let oldBehavior = JSON.parse(localStorage.getItem("blockBehavior") || "{}");
  if (oldBehavior.totalMoves) playerBehavior = oldBehavior;

  switchScreen("game");
  grid.innerHTML = "";
  gridCells = [];

  for (let i = 0; i < 64; i++) {
    const cell = document.createElement("div");
    cell.className = "cell";
    grid.appendChild(cell);
    gridCells.push(cell);
  }

  score = 0;
  shapesUsed = 0;
  updateScore();
  generateSmartShapes();

  // âœ… Ù…Ø±Ø§Ù‚Ø¨Ø© Ø§Ù„Ø£Ø¯Ø§Ø¡ Ø§Ù„Ø³ÙŠØ¦
  setTimeout(() => {
    const checkBadPerformance = setInterval(() => {
      if (!isGameRunning) return;

      const elapsed = Date.now() - gameStartTime;
      console.log("â± ÙˆÙ‚Øª Ø§Ù„Ù„Ø¹Ø¨:", elapsed, "ğŸ“‰ Ø§Ù„Ù†Ù‚Ø§Ø·:", score, "ğŸ”¥ ÙƒÙ…Ø¨Ùˆ:", playerBehavior.perfectClears);
      if (score < 350 && elapsed > 25000 && playerBehavior.perfectClears === 0) {
        showAIReaction("embarrassed");
        clearInterval(checkBadPerformance);
      }
    }, 5000);
  }, 10000);

  // âœ… Ø¥Ø¹Ø§Ø¯Ø© ØªÙØ¹ÙŠÙ„ Ø§Ù„ØµÙˆØª Ù„Ùˆ Ù…ØªÙˆÙ‚Ù
  document.body.addEventListener('touchstart', () => {
    if (SoundManager.context?.state === 'suspended') {
      SoundManager.context.resume();
    }
  }, { once: true });
}

    function restartGame() {
    
      startGame();
    }

    function updateScore() {
      scoreboard.textContent = `Score: ${score}`;
      let smartFactor = 0;
if (playerBehavior.avgSpeed && playerBehavior.avgSpeed < 2000) smartFactor += 1;
if (playerBehavior.perfectClears >= 5) smartFactor += 1;
if (playerBehavior.nearFails === 0 && score > 800) smartFactor += 1;
difficultyLevel = 1 + smartFactor * 0.3; // ØªÙ‚Ù„ÙŠÙ„ ÙˆØªÙŠØ±Ø© Ø§Ù„ØªØµØ§Ø¹Ø¯


    }

    function xyToIndex(x, y) {
      return y * 8 + x;
    }


function canPlaceAnyShape() {
  return shapesInHand.some(shape => canPlaceShapeAnywhere(shape));
}

setInterval(() => {
  const now = Date.now();
  if (now - lastSecretTime >= 60000 && now - lastAIReactionTime >= 5000) {
    showAIReaction("secret");
    lastSecretTime = now;
  }
}, 5000); // Ù†Ø±Ø§Ù‚Ø¨ ÙƒÙ„ 5 Ø«ÙˆØ§Ù†ÙŠ

setInterval(() => {
  const now = Date.now();
  if (now - lastJokeyTime >= 30000 && now - lastAIReactionTime >= 5000) {
    showAIReaction("jokey");
    lastJokeyTime = now;
  }
}, 5000); // Ù†Ø±Ø§Ù‚Ø¨ ÙƒÙ„ 5 Ø«ÙˆØ§Ù†ÙŠ




function canPlaceShapeAnywhere(shape) {
  const normalized = normalizeShape(shape);
  const maxX = Math.max(...normalized.map(([x]) => x));
  const maxY = Math.max(...normalized.map(([_, y]) => y));

  for (let y = 0; y <= 8 - maxY - 1; y++) {
    for (let x = 0; x <= 8 - maxX - 1; x++) {
      if (canPlace(normalized, x, y)) {
        return true;
      }
    }
  }

  return false;
}






function canPlaceShapeAt(shape, startRow, startCol) {
  for (let r = 0; r < shape.length; r++) {
    for (let c = 0; c < shape[r].length; c++) {
      if (shape[r][c]) {
        const cellIndex = xyToIndex(startCol + c, startRow + r);
        if (cellIndex < 0 || cellIndex >= gridCells.length || gridCells[cellIndex].classList.contains("filled")) {
          return false;
        }
      }
    }
  }
  return true;
}




function canPlace(shape, x, y) {
  for (const [dx, dy] of shape) {
    const gx = x + dx;
    const gy = y + dy;

    if (gx < 0 || gx >= 8 || gy < 0 || gy >= 8) {
      return false;
    }

    const index = gy * 8 + gx;
    const cell = gridCells[index];

    if (!cell || cell.classList.contains("filled")) {
      return false;
    }
  }

  return true;
}





function canShapeFitAnywhere(shape) {
  shape = normalizeShape(shape); // â† Ù‡Ø°Ø§ Ø§Ù„ØªØ¹Ø¯ÙŠÙ„ Ù…Ù‡Ù… Ø¬Ø¯Ù‹Ø§
  const maxDx = Math.max(...shape.map(([dx]) => dx));
  const maxDy = Math.max(...shape.map(([_, dy]) => dy));

  for (let y = 0; y <= 7 - maxDy; y++) {
    for (let x = 0; x <= 7 - maxDx; x++) {
      if (canPlace(shape, x, y)) {
        return true;
      }
    }
  }

  return false;
}


function normalizeShape(shape) {
  const minX = Math.min(...shape.map(([x]) => x));
  const minY = Math.min(...shape.map(([_, y]) => y));
  return shape.map(([x, y]) => [x - minX, y - minY]);
}









    function rotateShape(shape, times = 1) {
      let result = shape.map(([x, y]) => [x, y]);
      for (let t = 0; t < times; t++) {
        result = result.map(([x, y]) => [y, -x]);
        const minX = Math.min(...result.map(([x]) => x));
        const minY = Math.min(...result.map(([_, y]) => y));
        result = result.map(([x, y]) => [x - minX, y - minY]);
      }
      return result;
    }




    function createShapeElement(shape) {
  const el = document.createElement("div");
  el.className = "shape";

  // Ø­Ø³Ø§Ø¨ Ø£Ù‚Ù„ Ø¥Ø­Ø¯Ø§Ø«ÙŠ X Ùˆ Y Ù„ØªØ¨Ø¯Ø£ Ø§Ù„Ø´Ø¨ÙƒØ© Ù…Ù† Ø§Ù„Ø²Ø§ÙˆÙŠØ© Ø§Ù„Ø¹Ù„ÙŠØ§ Ø§Ù„ÙŠØ³Ø±Ù‰
  const xs = shape.map(([x]) => x);
  const ys = shape.map(([_, y]) => y);
  const minX = Math.min(...xs);
  const minY = Math.min(...ys);

  shape.forEach(([x, y]) => {
    const block = document.createElement("div");
    block.className = "block";

    // ØªØ­Ø¯ÙŠØ¯ Ù…ÙˆÙ‚Ø¹ Ø§Ù„Ø¨Ù„ÙˆÙƒ Ø¯Ø§Ø®Ù„ Ø´Ø¨ÙƒØ© 4x4 Ù„ÙƒÙ† ØªØ¨Ø¯Ø£ Ù…Ù† (0,0)
    block.style.gridColumn = `${x - minX + 1}`;
    block.style.gridRow = `${y - minY + 1}`;

    el.appendChild(block);
  });

  return el;
}


    function getRandomWeightedShape() {
      let filtered = weightedShapes.filter(s => s.shape.length <= (5 + difficultyLevel));
      let totalWeight = filtered.reduce((sum, s) => sum + s.weight, 0);
      let rand = Math.random() * totalWeight;
      for (let s of filtered) {
        if (rand < s.weight) return s.shape;
        rand -= s.weight;
      }
    }


document.addEventListener("touchmove", e => {
  
if (activePointerId !== "touch" || !floating) return;

  const touch = e.touches[0];
  const moveX = touch.pageX - pointerStartX;
  const moveY = touch.pageY - pointerStartY;
  floating.style.left = `${floatingStartX + moveX}px`;
  floating.style.top = `${floatingStartY + moveY}px`;
}, { passive: false });





function generateSmartShapes() {
  shapesDiv.innerHTML = "";
  shapesUsed = 0;
  shapesInHand = [];
  let tries = 0;

  while (shapesInHand.length < 3 && tries < 100) {
  let shape = getRandomWeightedShape();
let rotation = Math.floor(Math.random() * 4);
shape = rotateShape(shape, rotation);
shape = normalizeShape(shape); // â† Ù…Ù‡Ù… Ø¬Ø¯Ù‹Ø§ Ù‡Ù†Ø§



    if (canShapeFitAnywhere(shape)) {
      shapesInHand.push(shape);
    }

    tries++;
  }

  // âœ… ØªØ£ÙƒØ¯ Ø£Ù† Ø¬Ù…ÙŠØ¹ Ø§Ù„Ø£Ø´ÙƒØ§Ù„ Ù‚Ø§Ø¨Ù„Ø© Ù„Ù„ÙˆØ¶Ø¹
  const anyFit = shapesInHand.some(shape => canShapeFitAnywhere(shape));
  if (shapesInHand.length < 3 || !anyFit) {
    console.warn("ğŸ›‘ ÙØ´Ù„ ØªÙˆÙ„ÙŠØ¯ Ø£Ø´ÙƒØ§Ù„ ØµØ§Ù„Ø­Ø© â€“ Game Over");
    showGameOver();
    return;
  }





  
  // âœ… ØªÙˆÙ„ÙŠØ¯ Ø§Ù„Ø¹Ù†Ø§ØµØ± Ø¹Ù„Ù‰ Ø§Ù„Ø´Ø§Ø´Ø©
  shapesInHand.forEach(shape => {
    const el = createShapeElement(shape);
    shapesDiv.appendChild(el);

   el.addEventListener("pointerdown", e => {
      if (activePointerId !== null && e.pointerId !== activePointerId) return; // âŒ ØªØ¬Ø§Ù‡Ù„ Ø£ÙŠ Ù„Ù…Ø³Ø© Ø¥Ø¶Ø§ÙÙŠØ©
  activePointerId = e.pointerId;
 
  activePointerId = e.pointerId;
if (e.pointerType === "touch") {
  activeTouchId = e.pointerId;
}

el.addEventListener("touchstart", e => {
  if (activePointerId !== null) return;

  const touch = e.touches[0];
  activePointerId = "touch";
  activeTouchId = touch.identifier;

  pointerStartX = touch.pageX;
  pointerStartY = touch.pageY;
  floatingStartX = el.offsetLeft;
  floatingStartY = el.offsetTop;
  floating = el;

  el.style.zIndex = 1000;
  SoundManager.play('shapePick');
});

  SoundManager.play('shapePick');

      SoundManager.play('shapePick');
      e.preventDefault();

      sourceElement = el;

      const cellSize = gridCells[0].getBoundingClientRect().width;
      document.documentElement.style.setProperty('--cell-size', `${cellSize}px`);

      const rect = el.getBoundingClientRect();
      offset.x = e.clientX - rect.left;
      offset.y = e.clientY - rect.top;

      floating = el.cloneNode(true);
      floating.classList.add("floating");

      const maxX = Math.max(...shape.map(([x]) => x));
      const maxY = Math.max(...shape.map(([_, y]) => y));

      floating.style.width = `${cellSize * (maxX + 1)}px`;
      floating.style.height = `${cellSize * (maxY + 1)}px`;

      document.body.appendChild(floating);

      const x = e.pageX - offset.x;
      const y = e.pageY - offset.y - (cellSize * 4);

      floating.style.left = `${x}px`;
      floating.style.top = `${y}px`;

      pointerStartX = e.pageX;
      pointerStartY = e.pageY;
      floatingStartX = x;
      floatingStartY = y;

      currentShape = shape;
      lastPointer = { pageX: e.pageX, pageY: e.pageY };

 

      animationFrameId = requestAnimationFrame(followPointer);

      el.style.visibility = "hidden";
    });
  });
}




let activeTouchId = null;
let activePointerId = null;


let gameOverCheckInterval = null;
let isDragging = false;


function startGameOverWatcher() {
  clearInterval(gameOverCheckInterval);

  gameOverCheckInterval = setInterval(() => {
    if (isDragging) return; // ÙˆÙ‚Ù Ø§Ù„ÙØ­Øµ Ø£Ø«Ù†Ø§Ø¡ Ø§Ù„Ø³Ø­Ø¨

   


    const filledCellsCount = gridCells.filter(c => c.classList.contains("filled")).length;
    const fillRatio = filledCellsCount / gridCells.length;

    if (fillRatio >= 0.75 && !window._alreadyWarnedNearLose) {
      showAIReaction('nearLose');
      setTimeout(() => {
  window._alreadyWarnedNearLose = false;
}, 10000);

    }

    shapesInHand.forEach((shape, i) => {
      const canFit = canShapeFitAnywhere(shape);
     
    });


    const anyFit = shapesInHand.some(shape => canPlaceShapeAnywhere(shape));
    

  if (!anyFit) {
  

  // ğŸ‘‡ Ù…Ù‡Ù… Ø¬Ø¯Ø§Ù‹ Ù†ÙˆÙ‚Ù Ù…Ø±Ø§Ù‚Ø¨Ø© Ø§Ù„Ø¬ÙŠÙ… Ø£ÙˆÙØ±
  clearInterval(gameOverCheckInterval);

  // âœ… Ù†ÙÙ‘Ø° Ø§Ù„Ø¬ÙŠÙ… Ø£ÙˆÙØ± Ù…Ø¨Ø§Ø´Ø±Ø©
  showGameOver();
}

  }, 100);

}






function trackPointer(e) {
  lastPointer.pageX = e.pageX;
  lastPointer.pageY = e.pageY;
}



function followPointer() {
  if (!floating || !lastPointer) return;

  const cellSize = gridCells[0].getBoundingClientRect().width;
  const gridRect = grid.getBoundingClientRect();

  const speedBoost = 1.4;

  const moveX = (lastPointer.pageX - pointerStartX) * speedBoost;
  const moveY = (lastPointer.pageY - pointerStartY) * speedBoost;

  const x = floatingStartX + moveX;
  const y = floatingStartY + moveY;
lastActivityTime = Date.now(); // ØªØ­Ø¯ÙŠØ« ÙˆÙ‚Øª Ø§Ù„Ù†Ø´Ø§Ø· Ø§Ù„Ø£Ø®ÙŠØ±
  // ğŸ”„ ØªØ­Ø±ÙŠÙƒ Ø§Ù„Ø´ÙƒÙ„ Ø§Ù„Ø¹Ø§Ø¦Ù… Ø¨Ø³Ø±Ø¹Ø© Ø£Ø¹Ù„Ù‰
  floating.style.left = `${x}px`;
  floating.style.top = `${y}px`;

  // âœ… Ø­Ø³Ø§Ø¨ Ù…ÙˆØ¶Ø¹ Ø§Ù„Ø¸Ù„ Ø¨Ù†Ø§Ø¡Ù‹ Ø¹Ù„Ù‰ Ù…Ø±ÙƒØ² Ø§Ù„Ø´ÙƒÙ„ Ù…Ø¹ ØªØ¹ÙˆÙŠØ¶ 0.5 Ø®Ù„ÙŠØ© Ù„ØªÙˆØ§Ø²Ù† Ø§Ù„Ø­Ø±ÙƒØ©
  const gridX = Math.floor((x + cellSize * 0.5 - gridRect.left) / (gridRect.width / 8));
  const gridY = Math.floor((y + cellSize * 0.5 - gridRect.top) / (gridRect.height / 8));

  if (canPlace(currentShape, gridX, gridY)) {
    showPreview(currentShape, gridX, gridY);
  } else {
    clearPreview();
  }

  animationFrameId = requestAnimationFrame(followPointer);
}






function placeShape(shape, x, y) {
  
  failedShapePlacements = 0; // â† Ù†Ø¨Ø¯Ø£ Ø§Ù„Ø¹Ø¯ Ù…Ù† Ø¬Ø¯ÙŠØ¯ Ù„Ùˆ Ù†Ø¬Ø­ ÙÙŠ ÙˆØ§Ø­Ø¯Ø©

  shapesSinceLastClear++;
if (shapesSinceLastClear >= 6) {
  showAIReaction('embarrassed');
  shapesSinceLastClear = 0;
}

  shapesInHand = shapesInHand.filter(s => s !== currentShape);

  shape.forEach(([dx, dy]) => {
    gridCells[xyToIndex(x + dx, y + dy)].classList.add("filled");
  });
shapesSinceLastClear++;
if (shapesSinceLastClear >= 6) {
  showAIReaction("embarrassed");
  shapesSinceLastClear = 0;
}

  score += shape.length * 10;
checkFullLines();
updateScore();
checkNearLose();


  shapesUsed++;

  // Ø§Ù„Ø¬Ù…Ù„ Ø§Ù„ØªÙØ§Ø¹Ù„ÙŠØ© Ù„Ù„Ø°ÙƒØ§Ø¡ Ø§Ù„Ø§ØµØ·Ù†Ø§Ø¹ÙŠ
  if (playerBehavior.repeatedShapeCount >= 3) {
    showAIReaction('angry');
    playerBehavior.repeatedShapeCount = 0;
  }

  if (playerBehavior.failedAttempts >= 3) {
    showAIReaction('angry');
    playerBehavior.failedAttempts = 0;
  }

  if (playerBehavior.totalMoves >= 6 && playerBehavior.perfectClears === 0 && score < 250) {
    showAIReaction("embarrassed");
  }

  shapesInHand.forEach((shape, i) => {
  
});

  if (shapesUsed >= 3) {
    generateSmartShapes();
    shapesUsed = 0;

    // âœ… ÙØ­Øµ Ø§Ù„Ø¬ÙŠÙ… Ø£ÙˆÙØ± Ø¨Ø¹Ø¯ Ø§Ù„ØªÙˆÙ„ÙŠØ¯
    if (!canPlaceAnyShape()) {
      console.warn("ğŸ“› Ù…ÙÙŠØ´ Ù…ÙƒØ§Ù† Ù„Ø£ÙŠ Ø´ÙƒÙ„ â€“ Game Over");
      showGameOver();
      return;
    }
  }
 if (countingUselessShapes) {
  uselessShapesInARow++;
  if (uselessShapesInARow >= 6) {
    showAIReaction("embarrassed");
    uselessShapesInARow = 0;
  }
}


}
    
// Ø¶Ø¹ Ù‡Ø°Ø§ Ø¨Ø¯Ù„Ø§Ù‹ Ù…Ù† gameLoop Ø§Ù„Ù‚Ø¯ÙŠÙ…
function runGame() {
  // Ø£ÙƒÙˆØ§Ø¯ Ø§Ù„Ù„Ø¹Ø¨Ø© Ø§Ù„Ø­Ø§Ù„ÙŠØ© Ù‡Ù†Ø§
  if (!document.hidden) {
    setTimeout(runGame, 1000/60); // 60 FPS
  }
  lastActivityTime = Date.now(); // â±ï¸ ØªØ­Ø¯ÙŠØ« Ø¢Ø®Ø± Ù†Ø´Ø§Ø·

}






runGame();

    function checkFullLines() {
  let clearedRows = [], clearedCols = [];

  // ÙƒÙˆØ¯ Ø§Ù„ÙƒØ´Ù Ø¹Ù† Ø§Ù„ØµÙÙˆÙ ÙˆØ§Ù„Ø£Ø¹Ù…Ø¯Ø© Ø§Ù„Ù…Ù…ØªÙ„Ø¦Ø© ÙŠØ¨Ù‚Ù‰ ÙƒÙ…Ø§ Ù‡Ùˆ
  for (let row = 0; row < 8; row++) {
    if ([...Array(8)].every((_, col) => gridCells[xyToIndex(col, row)].classList.contains("filled"))) {
      clearedRows.push(row);
    }
  }

  for (let col = 0; col < 8; col++) {
    if ([...Array(8)].every((_, row) => gridCells[xyToIndex(col, row)].classList.contains("filled"))) {
      clearedCols.push(col);
    }
  }
shapesSinceLastClear = 0; // ØµÙÙŠÙ†Ø§ Ø§Ù„Ø¹Ø¯Ø§Ø¯ Ù„Ø£Ù† ØªÙ… Ù…Ø³Ø­ ØµÙÙˆÙ

  if (clearedRows.length || clearedCols.length) {
    const totalCleared = clearedRows.length + clearedCols.length;

// Ø§Ù„Ø­Ø§Ù„Ø© 1: Ù…Ø³Ø­ 3 ØµÙÙˆÙ Ø£Ùˆ Ø£ÙƒØ«Ø± Ù…Ø±Ø© ÙˆØ§Ø­Ø¯Ø©
if (totalCleared >= 3) {
  showAIReaction("shocked");
  smallClearsInARow = 0; // Ù†Ø¨Ø¯Ø£ Ù…Ù† Ø¬Ø¯ÙŠØ¯
}

// Ø§Ù„Ø­Ø§Ù„Ø© 2: Ù…Ø³Ø­ ØµÙ Ø£Ùˆ ØµÙÙŠÙ†
else if (totalCleared > 0 && totalCleared <= 2) {
  smallClearsInARow++;
  if (smallClearsInARow >= 3) {
    showAIReaction("shocked");
    smallClearsInARow = 0;
  }
} else {
  // Ù„Ùˆ Ù…Ø§ÙÙŠØ´ Ù…Ø³Ø­ ØµÙÙˆÙ ÙÙŠ Ø§Ù„Ù„Ø¹Ø¨Ø© Ø¯ÙŠ
  smallClearsInARow = 0;
}

    countingUselessShapes = true;
uselessShapesInARow = 0;

    uselessShapesInARow = 0;

    shapesSinceLastClear = 0;

    // Ø£Ø¶Ù Ù‡Ø°Ø§ Ø§Ù„Ø¬Ø²Ø¡ Ø§Ù„Ø¬Ø¯ÙŠØ¯ Ù‡Ù†Ø§ â†“
    
    
    // ØªØ´ØºÙŠÙ„ Ø§Ù„ØµÙˆØª Ø§Ù„Ù…Ù†Ø§Ø³Ø¨
    if (totalCleared >= 2) {
      SoundManager.play('comboClear');
    } else {
      SoundManager.play('singleClear');
    }

    // Ø¨Ø§Ù‚ÙŠ Ø§Ù„ÙƒÙˆØ¯ ÙŠØ¨Ù‚Ù‰ ÙƒÙ…Ø§ Ù‡Ùˆ â†“
    clearedRows.forEach(row => {
      for (let col = 0; col < 8; col++) gridCells[xyToIndex(col, row)].classList.remove("filled");
    });

    clearedCols.forEach(col => {
      for (let row = 0; row < 8; row++) gridCells[xyToIndex(col, row)].classList.remove("filled");
    });

    score += totalCleared * 100;
    updateScore();

    setTimeout(() => {
      if (totalCleared >= 2) {
        showAIReaction('combo');
      } else {
        showAIReaction('lineClear');
      }
      
    }, 100);
  }
}


function showGameOver() {
  if (screens.gameover.classList.contains("active")) return;

  clearInterval(gameOverCheckInterval);
  playerBehavior.nearFails++;

  switchScreen("gameover");

  // âœ… Ø¥Ø¸Ù‡Ø§Ø± Ø§Ù„Ø²Ø± Ø§Ù„Ø°Ù‡Ø¨ÙŠ
  document.getElementById("resumeBtn").style.display = "inline-block";
  document.getElementById("restartBtn").style.display = "none";
  document.getElementById("insightBtn").style.display = "none";

  // âœ… Ø¹Ø±Ø¶ Ø§Ù„Ø³ÙƒÙˆØ± Ø¨Ø´ÙƒÙ„ Ù…ØªÙØ¬Ø±
  const finalDisplay = document.getElementById("finalScoreDisplay");
  finalDisplay.innerHTML = `<div class="score-burst">${score}</div>`;
  finalDisplay.classList.add("show");

  // âœ… ØªÙØ¬ÙŠØ± Ù…ÙØ±Ù‚Ø¹Ø§Øª Ø­ÙˆÙ„ Ø§Ù„Ø±Ù‚Ù…
  triggerFireworks(finalDisplay);

  // âœ… Ø¹Ø¯Ø§Ø¯ Ø§Ù„Ø§Ø³ØªØ¦Ù†Ø§Ù
  countdownEl.style.display = "block";
  startResumeCountdown();

  // âœ… Ø­ÙØ¸ Ø§Ù„Ø£Ø¯Ø§Ø¡
  const history = JSON.parse(localStorage.getItem("playerHistory") || "[]");
  history.push({
    score,
    fastMoves: playerBehavior.fastMoves,
    slowMoves: playerBehavior.slowMoves,
    perfectClears: playerBehavior.perfectClears,
    nearFails: playerBehavior.nearFails,
    failedAttempts: playerBehavior.failedAttempts || 0,
    totalMoves: playerBehavior.totalMoves,
    avgSpeed: playerBehavior.avgSpeed,
    duration: Date.now() - gameStartTime,
    mood: aiMemory.mood || "neutral",
    shapeRepeats: playerBehavior.repeatedShapeCount || 0
  });
  if (history.length > 10) history.shift();
  localStorage.setItem("playerHistory", JSON.stringify(history));

  isGameRunning = false;
}


function triggerFireworks(container) {
  for (let i = 0; i < 12; i++) {
    const sparkle = document.createElement("div");
    sparkle.className = "sparkle";
    sparkle.style.left = `${50 + Math.random() * 100 - 50}%`;
    sparkle.style.top = `${50 + Math.random() * 100 - 50}%`;
    container.appendChild(sparkle);
    setTimeout(() => sparkle.remove(), 1000);
  }
}




function resumeGame() {
  isGameRunning = true;

  // Ù‡Ø°Ø§ Ù…ÙƒØ§Ù† ÙˆØ¶Ø¹ ÙƒÙˆØ¯ AdMob Ø§Ù„Ø­Ù‚ÙŠÙ‚ÙŠ Ù„Ø§Ø­Ù‚Ø§Ù‹
  // Ø§Ù„Ù…Ø«Ø§Ù„ Ø§Ù„ØªØ§Ù„ÙŠ Ø¬Ø§Ù‡Ø² Ù„Ø§Ø³ØªØ¨Ø¯Ø§Ù„Ù‡ Ø¨Ù€ AdMob Rewarded Ad
  
  // 1. Ù‡Ù†Ø§ Ø³ØªØ¶Ø¹ ÙƒÙˆØ¯ Ø¹Ø±Ø¶ Ø§Ù„Ø¥Ø¹Ù„Ø§Ù† Ø§Ù„Ù…ÙƒØ§ÙØ¦ (AdMob)
  // 2. Ø¹Ù†Ø¯ Ø§ÙƒØªÙ…Ø§Ù„ Ù…Ø´Ø§Ù‡Ø¯Ø© Ø§Ù„Ø¥Ø¹Ù„Ø§Ù†ØŒ ÙŠØªÙ… ØªÙ†ÙÙŠØ° Ø§Ù„ÙƒÙˆØ¯ Ø¯Ø§Ø®Ù„ onAdWatched()
  
  // Ù…Ø­Ø§ÙƒØ§Ø© Ù„Ø¹Ø±Ø¶ Ø§Ù„Ø¥Ø¹Ù„Ø§Ù† (Ø§Ø­Ø°Ù Ù‡Ø°Ø§ Ø¹Ù†Ø¯ Ø¯Ù…Ø¬ AdMob Ø§Ù„ÙØ¹Ù„ÙŠ)
  const onAdWatched = () => {
    // ÙƒÙˆØ¯ Ø§Ø³ØªØ¦Ù†Ø§Ù Ø§Ù„Ù„Ø¹Ø¨ Ø§Ù„ÙØ¹Ù„ÙŠ
    clearInterval(countdownTimer);
    clearPreview();
    
    // Ù…Ø³Ø­ Ø£ÙŠ Ø£Ø´ÙƒØ§Ù„ Ù…ØªØ¨Ù‚ÙŠØ©
    shapesDiv.innerHTML = "";
    generateSmartShapes(); // â† ØªÙˆÙ„ÙŠØ¯ Ø£Ø´ÙƒØ§Ù„ Ø¬Ø¯ÙŠØ¯Ø© Ø¨Ø¹Ø¯ Ø§Ù„Ø¥Ø¹Ù„Ø§Ù†

    // Ø¥Ø¹Ø§Ø¯Ø© ØªØ´ØºÙŠÙ„ Ù…Ø±Ø§Ù‚Ø¨Ø© Ø§Ù„Ø¬ÙŠÙ… Ø£ÙˆÙØ± Ø¨Ø¹Ø¯ Ø§Ù„Ø§Ø³ØªØ¦Ù†Ø§Ù
startGameOverWatcher();

    // Ù…Ø³Ø­ Ø¨Ø¹Ø¶ Ø§Ù„Ø®Ù„Ø§ÙŠØ§ Ø¹Ø´ÙˆØ§Ø¦ÙŠØ§Ù‹ (Ù…Ø«Ø§Ù„: 5 Ø®Ù„Ø§ÙŠØ§)
let filledCells = gridCells.filter(cell => cell.classList.contains("filled"));
let targetToClear = Math.floor(filledCells.length * 0.4); // 40% Ù…Ù† Ø§Ù„Ù…Ù„ÙŠØ§Ù†ÙŠÙ†



let cellSize = 0;




let cellsCleared = 0;
for (let row = 0; row < 8; row++) {
  for (let col = 0; col < 8; col++) {
    const index = xyToIndex(col, row);
    const cell = gridCells[index];

    if (cell.classList.contains("filled")) {
      cell.classList.remove("filled");
      cellsCleared++;
    }

    if (cellsCleared >= targetToClear) break;
  }
  if (cellsCleared >= targetToClear) break;
}


    
    // Ø¥Ø¹Ø§Ø¯Ø© ØªÙˆÙ„ÙŠØ¯ Ø§Ù„Ø£Ø´ÙƒØ§Ù„


    // Ø§Ù„Ø¹ÙˆØ¯Ø© Ø¥Ù„Ù‰ Ø´Ø§Ø´Ø© Ø§Ù„Ù„Ø¹Ø¨
    switchScreen("game");
    
    // Ø¨Ø¯Ø¡ Ø§Ù„Ù…Ø±Ø§Ù‚Ø¨Ø© Ù…Ù† Ø¬Ø¯ÙŠØ¯

  };
  
  // Ù…Ø­Ø§ÙƒØ§Ø© Ø§Ù„Ø¥Ø¹Ù„Ø§Ù† (Ø§Ø³ØªØ¨Ø¯Ù„ Ù‡Ø°Ø§ Ø¨ AdMob)
  onAdWatched(); // Ø§Ø­Ø°Ù Ù‡Ø°Ø§ Ø§Ù„Ø³Ø·Ø± Ø¹Ù†Ø¯ Ø¯Ù…Ø¬ AdMØ¨
  
  // ÙƒÙˆØ¯ AdMob Ø§Ù„Ù…Ø«Ø§Ù„ (Ø¬Ø§Ù‡Ø² Ù„Ù„Ø¥Ø¶Ø§ÙØ©):
  /*
  if(window.admob) {
    admob.rewarded.load().then(() => {
      return admob.rewarded.show();
    }).then(() => {
      onAdWatched();
    }).catch(err => {
      console.log("Error showing ad:", err);
    });
  }
  */
}

// Ø¯Ø§Ù„Ø© Ù…Ø³Ø§Ø¹Ø¯Ø© Ù„Ø¹Ø±Ø¶ Ø§Ù„Ø¥Ø¹Ù„Ø§Ù† (Ø³ØªØ­ØªØ§Ø¬ Ù„Ø±Ø¨Ø·Ù‡Ø§ Ø¨AdMob Ù„Ø§Ø­Ù‚Ø§Ù‹)
function showRewardedAdWithCallback(callback) {
  isGameRunning = true;
  lastActivityTime = Date.now();
startGameOverWatcher();


  // Ø¬Ø§Ù‡Ø²Ø© Ù„Ø¯Ù…Ø¬ AdMob Ù…Ø¨Ø§Ø´Ø±Ø©
  callback(); // Ø§Ø­Ø°Ù Ù‡Ø°Ø§ Ø§Ù„Ø³Ø·Ø± Ø¹Ù†Ø¯ Ø¯Ù…Ø¬ AdMob
  
  // Ù†Ù…ÙˆØ°Ø¬ ÙƒÙˆØ¯ AdMob:
  /*
  return new Promise((resolve) => {
    if(window.admob) {
      admob.rewarded.load().then(() => {
        return admob.rewarded.show();
      }).then(() => {
        callback();
        resolve(true);
      }).catch(err => {
        console.log("Error showing ad:", err);
        resolve(false);
      });
    } else {
      resolve(false);
    }
  });
  */
 
}



function showRewardedAd(callback) {
  // Ù‡Ø°Ø§ Ù…ÙƒØ§Ù† Ø±Ø¨Ø· Ø¥Ø¹Ù„Ø§Ù† AdMob Ø§Ù„Ø­Ù‚ÙŠÙ‚ÙŠ Ù„Ø§Ø­Ù‚Ù‹Ø§
  console.log("ğŸ“º Ø¹Ø±Ø¶ Ø¥Ø¹Ù„Ø§Ù† Ø§Ù„Ù…ÙƒØ§ÙØ£Ø©");
  
  // Ù„Ù…Ø­Ø§ÙƒØ§Ø© Ø§Ù„Ø¥Ø¹Ù„Ø§Ù† (Ù„Ù„ØªØ·ÙˆÙŠØ± ÙÙ‚Ø·)
  const adShown = confirm("Ù‡Ø°Ø§ Ù…ÙƒØ§Ù† Ø¥Ø¹Ù„Ø§Ù† Ø§Ù„Ù…ÙƒØ§ÙØ£Ø©. Ù‡Ù„ ØªØ±ÙŠØ¯ Ø§Ù„Ù…ØªØ§Ø¨Ø¹Ø©ØŸ");
  
  if (adShown) {
    if (callback) callback();
    return true;
  }
  return false;
}

function generateInsightReport() {
  const textArea = document.getElementById("insightAiText");
  const avatar = document.getElementById("insightAiAvatar");
  const dots = document.querySelector("#insightAiBubble .ai-dots");
  const shareBtn = document.getElementById("shareInsightBtn");
  const closeBtn = document.getElementById("closeInsightBtn");

  shareBtn.classList.add("hidden");
  closeBtn.classList.add("hidden");
  shareBtn.classList.remove("visible");
  closeBtn.classList.remove("visible");

  const b = playerBehavior;
  const mood = aiMemory?.mood || "neutral";
  const lang = JSON.parse(localStorage.getItem("blockPlayerData"))?.language || 'ar';
  const ai = window.aiResponses?.insightBlocks || {};
  const rand = arr => arr[Math.floor(Math.random() * arr.length)];
  const report = [];

  // 1. Ù…Ù‚Ø¯Ù…Ø© Ø¬Ø§Ø¯Ø© ØªØ­Ù„ÙŠÙ„ÙŠØ©
  if (ai.opening?.length) report.push("ğŸ§  " + rand(ai.opening));

  // 2. ØªØ­Ù„ÙŠÙ„ Ø£Ø¯Ø§Ø¡ (Ø­Ø³Ø¨ Ø§Ù„Ù†ØªØ§Ø¦Ø¬)
  if (b.score > 4000 && ai.analysis_strong?.length) {
    report.push("ğŸ“Š " + rand(ai.analysis_strong));
  } else if (b.score < 1000 && ai.analysis_weak?.length) {
    report.push("ğŸ“‰ " + rand(ai.analysis_weak));
  } else if (ai.analysis_neutral?.length) {
    report.push("ğŸ“ˆ " + rand(ai.analysis_neutral));
  }

  // 3. ØªØ­Ù„ÙŠÙ„ Ù†ÙØ³ÙŠ (Ø­Ø³Ø¨ Ø§Ù„Ø³Ù„ÙˆÙƒ)
  if (b.repeatedShapeCount > 3 && ai.emotion_stubborn?.length) {
    report.push("ğŸ§± " + rand(ai.emotion_stubborn));
  } else if (b.failedAttempts > 4 && ai.emotion_nervous?.length) {
    report.push("ğŸ˜° " + rand(ai.emotion_nervous));
  } else if (b.slowMoves > b.fastMoves && ai.emotion_hesitant?.length) {
    report.push("ğŸ¢ " + rand(ai.emotion_hesitant));
  } else if (ai.emotion_generic?.length) {
    report.push("ğŸŒ€ " + rand(ai.emotion_generic));
  }

  // 4. Ø¯Ø¹Ù… Ø¹Ø§Ø·ÙÙŠ Ø­Ù‚ÙŠÙ‚ÙŠ (Ù„Ùˆ ÙØ¹Ù„Ø§Ù‹ ÙŠØ³ØªØ­Ù‚)
  if ((b.perfectClears >= 1 || b.gamesPlayed >= 4 || b.failedAttempts >= 5) && ai.support?.length) {
    report.push("ğŸ’™ " + rand(ai.support));
  }

  // 5. Ø¯Ø¹ÙˆØ© Ù„Ù„ØªØ­Ø¯ÙŠ Ø¨Ù†Ø§Ø¡Ù‹ Ø¹Ù„Ù‰ Ø§Ù„Ù…Ø²Ø§Ø¬ Ø§Ù„Ø­Ø§Ù„ÙŠ Ù„Ù„Ø®ØµÙ…
  if (mood === "confident" && ai.challenge_strong?.length) {
    report.push("ğŸ”¥ " + rand(ai.challenge_strong));
  } else if (ai.challenge_neutral?.length) {
    report.push("ğŸ¯ " + rand(ai.challenge_neutral));
  }

  // 6. ØªØ´Ø¨ÙŠÙ‡ Ø®ØªØ§Ù…ÙŠ ØºØ±ÙŠØ¨
  if (ai.closing?.length) {
    report.push("ğŸŒ€ " + rand(ai.closing));
  }

  const message = "\n\n" + report.join("\n\n");

  textArea.textContent = "";
  dots.style.display = "flex";
  avatar.src = "assets/ai_thinking.png";

  setTimeout(() => {
    dots.style.display = "none";
    let i = 0;
    function typeChar() {
      if (i < message.length) {
        textArea.textContent += message[i++];
        setTimeout(typeChar, 35);
      } else {
        shareBtn.classList.remove("hidden");
        closeBtn.classList.remove("hidden");
        shareBtn.classList.add("visible");
        closeBtn.classList.add("visible");
        avatar.src = "assets/ai_smile.png";
        avatar.classList.add("bounce");
      }
    }
    typeChar();
  }, 1000);
    startAvatarIntroduction();
}



function showInsightReport() {
  // Ø¥Ø®ÙØ§Ø¡ Ø´Ø§Ø´Ø© gameover Ø£ÙˆÙ„Ø§Ù‹
  document.getElementById("gameover").classList.remove("active");
  
  // Ø¥Ø¸Ù‡Ø§Ø± Ø´Ø§Ø´Ø© Ø§Ù„ØªÙ‚Ø±ÙŠØ±
  document.getElementById("insightScreen").classList.remove("hidden");
  
  // ØªÙˆÙ„ÙŠØ¯ Ø§Ù„ØªÙ‚Ø±ÙŠØ±
  generateInsightReport();
  
  // Ø¥Ø¹Ø§Ø¯Ø© ØªØ­Ù…ÙŠÙ„ Ø±Ø¯ÙˆØ¯ Ø§Ù„Ø°ÙƒØ§Ø¡ Ø§Ù„Ø§ØµØ·Ù†Ø§Ø¹ÙŠ Ù„Ù„ØªØ£ÙƒØ¯ Ù…Ù† Ø¹Ù…Ù„Ù‡Ø§
  reloadAIResponses();
}


    function showAIMessage(text) {
      const aiText = document.getElementById("aiText");
      const heatBar = document.getElementById("aiHeatBar");
      aiText.textContent = text;
      aiText.classList.remove("show");
      heatBar.classList.remove("active");
      void aiText.offsetWidth;
      void heatBar.offsetWidth;
      aiText.classList.add("show");
      heatBar.classList.add("active");

      setTimeout(() => {
        aiText.classList.remove("show");
        heatBar.classList.remove("active");
      }, 3500);
    }

    function clearRandomLine() {
      const isRow = Math.random() < 0.5;
      const index = Math.floor(Math.random() * 8);
      if (isRow) {
        for (let col = 0; col < 8; col++) {
          gridCells[xyToIndex(col, index)].classList.remove("filled");
        }
      } else {
        for (let row = 0; row < 8; row++) {
          gridCells[xyToIndex(index, row)].classList.remove("filled");
        }
      }
    }

    

    function clearPreview() {
      gridCells.forEach(cell => {
        cell.classList.remove("preview");
        cell.classList.remove("line-clear-preview");
      });
    }

    function showPreview(shape, x, y) {
      clearPreview();
      const previewIndexes = [];

      shape.forEach(([dx, dy]) => {
        const gx = x + dx;
        const gy = y + dy;
        if (gx >= 0 && gx < 8 && gy >= 0 && gy < 8) {
          const index = xyToIndex(gx, gy);
          previewIndexes.push(index);
          gridCells[index].classList.add("preview");
        }
      });

      for (let row = 0; row < 8; row++) {
        if ([...Array(8)].every((_, col) => {
          const i = xyToIndex(col, row);
          return gridCells[i].classList.contains("filled") || previewIndexes.includes(i);
        })) {
          for (let col = 0; col < 8; col++) {
            gridCells[xyToIndex(col, row)].classList.add("line-clear-preview");
          }
        }
      }

      for (let col = 0; col < 8; col++) {
        if ([...Array(8)].every((_, row) => {
          const i = xyToIndex(col, row);
          return gridCells[i].classList.contains("filled") || previewIndexes.includes(i);
        })) {
          for (let row = 0; row < 8; row++) {
            gridCells[xyToIndex(col, row)].classList.add("line-clear-preview");
          }
        }
      }
    }



    let lastPointer = null;

function animateFloating(e) {
  if (!e || !e.pageX || !e.pageY) return;
  if (!floating || !lastPointer || !currentShape) return;

  const gridX = lastPointer.gridX;
  const gridY = lastPointer.gridY;

  if (typeof gridX === "undefined" || typeof gridY === "undefined") return;

  requestAnimationFrame(() => {
    const centerX = e.pageX - offset.x;
    const centerY = e.pageY - offset.y;

    const floatX = centerX - floating.offsetWidth / 2;
    const floatY = centerY - floating.offsetHeight / 2 - (cellSize * 4);

    floating.style.left = `${floatX}px`;
    floating.style.top = `${floatY}px`;

    if (canPlace(currentShape, gridX, gridY)) {
      showPreview(currentShape, gridX, gridY);
    } else {
      clearPreview();
    }
  });
}



window.addEventListener("pointermove", e => {
  if (e.pointerId !== activePointerId) return;

  if (!floating) return;
  lastPointer = e;
  animateFloating(e);
});






document.addEventListener("pointerup", e => {
  if (e.pointerId === activePointerId) {
  activePointerId = null;
}
// ğŸ‘ˆ ÙÙƒ Ù‚ÙÙ„ Ø§Ù„Ù„Ù…Ø³Ø© Ù„Ù…Ø§ ØªØ®Ù„Øµ

  if (!floating) return;

  // ğŸ§  Ù†Ø­Ø³Ø¨ Ù…ÙƒØ§Ù† Ø§Ù„Ø¥Ø³Ù‚Ø§Ø· Ø¨Ù†ÙØ³ Ø·Ø±ÙŠÙ‚Ø© Ø§Ù„Ø´ÙƒÙ„ Ø§Ù„Ø¹Ø§Ø¦Ù… (Ù…Ø¹ Ø³Ø±Ø¹Ø© 1.4)
  const cellSize = gridCells[0].getBoundingClientRect().width;
  const gridRect = grid.getBoundingClientRect();

  const moveX = (e.pageX - pointerStartX) * 1.4;
  const moveY = (e.pageY - pointerStartY) * 1.4;

  const boostedX = floatingStartX + moveX;
  const boostedY = floatingStartY + moveY;

  const gridX = Math.floor((boostedX + cellSize * 0.5 - gridRect.left) / (gridRect.width / 8));
  const gridY = Math.floor((boostedY + cellSize * 0.5 - gridRect.top) / (gridRect.height / 8));

  if (canPlace(currentShape, gridX, gridY)) {
    placeShape(currentShape, gridX, gridY);
    sourceElement.remove(); // Ø­Ø°Ù Ø§Ù„Ø´ÙƒÙ„ Ù…Ù† ØªØ­Øª
  } else {
    
    sourceElement.style.visibility = "visible"; // Ø±Ø¬Ù‘Ø¹Ù‡ Ù„Ùˆ ÙØ´Ù„
    failedShapePlacements++;
console.log("âŒ ÙØ´Ù„ ÙÙŠ ÙˆØ¶Ø¹ Ø§Ù„Ø´ÙƒÙ„ - Ø§Ù„Ù…Ø­Ø§ÙˆÙ„Ø© Ø±Ù‚Ù…", failedShapePlacements);

if (failedShapePlacements >= 3) {
  showAIReaction('angry');
  failedShapePlacements = 0;
}

    failedShapePlacements++;
console.log("âŒ ÙØ´Ù„ ÙÙŠ ÙˆØ¶Ø¹ Ø§Ù„Ø´ÙƒÙ„ - Ø§Ù„Ø¹Ø¯Ø¯:", failedShapePlacements);

if (failedShapePlacements >= 3) {
  showAIReaction('angry');
  failedShapePlacements = 0;
}

  }

  clearPreview();
  floating.remove();
  floating = null;
  currentShape = null;
  sourceElement = null;

  cancelAnimationFrame(animationFrameId);
  isDragging = false;
  activePointerId = null;



});






  let playerData;
try {
  playerData = JSON.parse(localStorage.getItem("blockPlayerData")) || {};
  if (typeof playerData.language !== 'string' || typeof playerData.gender !== 'string') {
    throw new Error("Ø¨ÙŠØ§Ù†Ø§Øª ØºÙŠØ± ØµØ§Ù„Ø­Ø©");
  }
} catch (e) {
  console.warn("ğŸš¨ Ø¨ÙŠØ§Ù†Ø§Øª Ù…Ø´ Ù…Ø¸Ø¨ÙˆØ·Ø© Ù…Ù† localStorage - Ù‡Ù†Ø¨Ø¯Ø£ Ù…Ù† Ø¬Ø¯ÙŠØ¯");
  localStorage.removeItem("blockPlayerData");
  playerData = { language: '', gender: '' };
}



    function chooseLanguage(lang) {
  playerData.language = lang;
  localStorage.setItem("blockPlayerData", JSON.stringify(playerData));
  document.getElementById("step2").style.display = "none";
document.getElementById("welcomeText").style.display = "block";
document.getElementById("langButtons").style.display = "none";
document.getElementById("step2").style.display = "block";



  if(lang === 'en') {
    document.getElementById("welcomeText").innerText = "ğŸ¤– Hello! Let me know you better!";
    document.getElementById("genderText").innerText = "ğŸ‘¤ Are you a boy or a girl?";
    document.querySelectorAll("#step2 button")[0].innerText = "ğŸš¹ Boy";
    document.querySelectorAll("#step2 button")[1].innerText = "ğŸšº Girl";

    document.getElementById("ageText").innerText = "ğŸ‚ How old are you?";
    document.querySelectorAll("#step3 button")[0].innerText = "ğŸ”¢ Under 18";
    document.querySelectorAll("#step3 button")[1].innerText = "ğŸ”¢ Above 18";

    document.querySelector("#finalStep button").innerText = "ğŸš€ Let's Start The Journey!";
  } else {
    document.getElementById("welcomeText").innerText = "ğŸ¤– Ø£Ù‡Ù„Ø§Ù‹! Ø®Ù„ÙŠÙ†Ø§ Ù†ØªØ¹Ø±Ù Ø¹Ù„ÙŠÙƒ Ø´ÙˆÙŠØ©!";
    document.getElementById("genderText").innerText = "ğŸ‘¤ Ø¥Ù†Øª ÙˆÙ„Ø¯ ÙˆÙ„Ø§ Ø¨Ù†ØªØŸ";
    document.querySelectorAll("#step2 button")[0].innerText = "ğŸš¹ ÙˆÙ„Ø¯";
    document.querySelectorAll("#step2 button")[1].innerText = "ğŸšº Ø¨Ù†Øª";

    document.getElementById("ageText").innerText = "ğŸ‚ Ø¹Ù…Ø±Ùƒ Ø£Ù‚Ù„ Ù…Ù† 18 ÙˆÙ„Ø§ Ø£ÙƒØªØ±ØŸ";
    document.querySelectorAll("#step3 button")[0].innerText = "ğŸ”¢ Ø£Ù‚Ù„ Ù…Ù† 18";
    document.querySelectorAll("#step3 button")[1].innerText = "ğŸ”¢ Ø£ÙƒØ¨Ø± Ù…Ù† 18";

    document.querySelector("#finalStep button").innerText = "ğŸš€ ÙŠÙ„Ø§ Ù†Ø¨Ø¯Ø£ Ø§Ù„Ø±Ø­Ù„Ø©!";
  }

  applyLanguage(); // â† Ø³Ø·Ø± Ù…Ù‡Ù… Ø¬Ø¯Ø§Ù‹ Ù„Ø¶Ù…Ø§Ù† ØªØ±Ø¬Ù…Ø© Ø¨Ø§Ù‚ÙŠ Ø§Ù„ÙˆØ§Ø¬Ù‡Ø©
  switchScreen("menu"); // â† Ù„Ùˆ ÙƒÙ†Øª Ø¹Ø§ÙŠØ² ÙŠÙ†Ù‚Ù„Ù‡ ØªÙ„Ù‚Ø§Ø¦ÙŠÙ‹Ø§ Ù„Ù„Ù‚Ø§Ø¦Ù…Ø© Ø¨Ø¹Ø¯ Ø§Ù„Ù„ØºØ©

}


function chooseGender(gender) {
  playerData.gender = gender;
  localStorage.setItem("blockPlayerData", JSON.stringify(playerData));

  document.getElementById("welcomeScreen").classList.add("hidden");
  document.getElementById("avatarIntroScreen").classList.remove("hidden");

  reloadAIResponses();

 reloadAIResponses();
setTimeout(() => {
  if (window.aiReady) {
  showReactionMessage(getAvatarWelcomeMessage());


  }
  localStorage.setItem("firstVisitDone", "true");

}, 100);

}





 function getAvatarWelcomeMessage() {
  localStorage.setItem("blockPlayerData", JSON.stringify(playerData));
  reloadAIResponses();

  function startAvatarIntroduction() {
    document.getElementById("welcomeScreen").classList.add("hidden");
document.getElementById("avatarIntroScreen").classList.remove("hidden");

    console.log("ğŸš€ Ø¯Ø®Ù„Ù†Ø§ ÙØ¹Ù„Ø§Ù‹ Ø¹Ù„Ù‰ startAvatarIntroduction()");

  const aiText = document.getElementById("introAiText");
  const aiDots = document.querySelector("#avatarIntroScreen .ai-dots");
  const avatarImg = document.getElementById("introAiAvatar");
  
  const savedData = JSON.parse(localStorage.getItem("blockPlayerData")) || {};
  const lang = savedData.language || "ar";
  const gender = savedData.gender || "male";
  
  let message = "";

  if (lang === "ar") {
    if (gender === "male") {
      message = "Ø£Ù‡Ù„Ø§Ù‹ Ø¨ÙŠÙƒ!\nØ£Ù†Ø§ Ø¨ÙŠØ¶Ø© Ø§Ù„Ø¨Ø·Ø±ÙŠÙ‚ Ø§Ù„Ø²Ø±Ù‚Ø§Ø¡ Ø§Ù„Ù…Ø²Ø±Ù‚Ø´Ø©... Ø°ÙƒØ§Ø¡ Ø§ØµØ·Ù†Ø§Ø¹ÙŠ Ø¹Ù„Ù‰ Ù…Ø²Ø§Ø¬ÙŠ ÙØ§Ø®Ø± Ù…Ù† Ø§Ù„Ø¢Ø®Ø±.\nÙ…Ù‡Ù…ØªÙŠ Ø§Ù„Ø¨Ø³ÙŠØ·Ø©: Ø£Ø®Ù„ÙŠÙƒ ØªØ·ÙØ´ ÙˆØªÙ…Ø³Ø­ Ø§Ù„Ù„Ø¹Ø¨Ø©!";
    } else {
      message = "Ø£Ù‡Ù„Ø§Ù‹ Ø¨ÙŠÙƒÙŠ!\nØ£Ù†Ø§ Ø¨ÙŠØ¶Ø© Ø§Ù„Ø¨Ø·Ø±ÙŠÙ‚ Ø§Ù„Ø²Ø±Ù‚Ø§Ø¡ Ø§Ù„Ù…Ø²Ø±Ù‚Ø´Ø©... Ø°ÙƒØ§Ø¡ Ø§ØµØ·Ù†Ø§Ø¹ÙŠ Ø¹Ù„Ù‰ Ù…Ø²Ø§Ø¬ÙŠ ÙØ§Ø®Ø± Ù…Ù† Ø§Ù„Ø¢Ø®Ø±.\nÙ…Ù‡Ù…ØªÙŠ Ø§Ù„Ù„Ø°ÙŠØ°Ø©: Ø£Ø®Ù„ÙŠÙƒÙŠ ØªØ²Ù‡Ù‚ÙŠ ÙˆØªÙ…Ø³Ø­ÙŠ Ø§Ù„Ù„Ø¹Ø¨Ø©!";
    }
  } else if (lang === "en") {
    if (gender === "male") {
      message = "Hey there!\nI'm the Blue Penguin Egg... a sarcastic piece of AI made just to mess with you.\nMy simple mission: Make you rage quit and delete the game!";
    } else {
      message = "Hey girl!\nI'm the Blue Penguin Egg... a sarcastic piece of AI crafted just to drive you crazy.\nMy sweet mission: Make you rage quit and uninstall the game!";
    }
  }

  aiText.textContent = "";
  aiDots.style.display = "flex"; 

  setTimeout(() => {
    aiDots.style.display = "none"; 

    let charIndex = 0;
    function typeNextChar() {
      if (charIndex < message.length) {
        aiText.textContent += message[charIndex];
        charIndex++;
        setTimeout(typeNextChar, 40); // Ø³Ø±Ø¹Ø© Ø§Ù„ÙƒØªØ§Ø¨Ø©
      } else {
        
        setTimeout(() => {
  avatarImg.src = "assets/ai_angry.png";
  avatarImg.classList.add("shake");

  // ğŸ‘‡ Ø¥Ù†Ø´Ø§Ø¡ Ø²Ø±Ø§Ø± "ÙŠÙ„Ø§ Ù†Ø¨Ø¯Ø£ Ø§Ù„Ø±Ø­Ù„Ø©"
  const startBtn = document.createElement("button");
  startBtn.innerText = lang === "ar" ? "ğŸ® ÙŠÙ„Ø§ Ù†Ø¨Ø¯Ø£ Ø§Ù„Ø±Ø­Ù„Ø©!" : "ğŸ® Let's Start!";
  startBtn.className = "welcome-btn";
  startBtn.style.marginTop = "25px";
startBtn.onclick = () => {
  let data = JSON.parse(localStorage.getItem("blockPlayerData")) || {};
  data.introDone = true;
  localStorage.setItem("blockPlayerData", JSON.stringify(data));

  // Ø£Ø®ÙÙŠ ÙƒÙ„ Ø§Ù„Ø´Ø§Ø´Ø§Øª Ø§Ù„ØªÙ…Ù‡ÙŠØ¯ÙŠØ©
  document.getElementById("welcomeScreen").classList.add("hidden");
  document.getElementById("avatarIntroScreen").classList.add("hidden");

  // Ø§ÙØªØ­ Ø§Ù„Ù‚Ø§Ø¦Ù…Ø© Ø§Ù„Ø±Ø¦ÙŠØ³ÙŠØ©
  switchScreen("menu");
  applyLanguage();
};


  document.getElementById("avatarWrapper").appendChild(startBtn);
}, 2000);

      }
    }

    typeNextChar();
  }, 1200);

}



document.getElementById("welcomeText").innerText = "ğŸ¤– Ø¬Ø§Ø±ÙŠ Ø§Ù„ØªØ­Ø¶ÙŠØ± Ù„Ù…ØºØ§Ù…Ø±ØªÙƒ.";
document.getElementById("langButtons").style.display = "none";


  // Ù†Ø¨Ø¯Ø£ ÙØ­Øµ Ø§Ù„ØªØ­Ù…ÙŠÙ„
  const checkReady = setInterval(() => {
    if (window.aiReady) {
      clearInterval(checkReady);
      document.getElementById("welcomeScreen").style.display = "none";
document.getElementById("avatarIntroScreen").classList.remove("hidden");
startAvatarIntroduction();

    }
  }, 100);
}





    function showPlayerStats() {
      let savedData = JSON.parse(localStorage.getItem("blockPlayerData")) || {};
      let lang = savedData.language || 'ar';
      let t = applyLanguageText(lang);
      
      let highestScore = localStorage.getItem("blockHighestScore") || 0;
      let lastScore = localStorage.getItem("blockLastScore") || 0;
      let playCount = localStorage.getItem("blockPlayCount") || 0;
      let aiEnabled = localStorage.getItem("aiModeEnabled") !== "false";


let soundEnabled = localStorage.getItem("soundEnabled") !== "false";

let statsHTML = `
  <div class="row">${t.genderLabel}: ${savedData.gender === 'male' ? (lang === 'ar' ? 'ÙˆÙ„Ø¯' : 'Boy') : (lang === 'ar' ? 'Ø¨Ù†Øª' : 'Girl')}
    <button onclick="changeGender()">${t.change}</button>
  </div>
  <div class="row">${t.langLabel}: ${lang === 'ar' ? 'Ø§Ù„Ø¹Ø±Ø¨ÙŠØ©' : 'English'}
    <button onclick="changeLanguage()">${t.change}</button>
  </div>
  <div class="row">${t.highScore}: ${highestScore}</div>
  <div class="row">${t.lastScore}: ${lastScore}</div>
  <div class="row">${t.playCount}: ${playCount}</div>
  <hr style="width:100%;margin:10px 0;">
  <div class="row">${t.aiMessage}:
    <button id="aiModeToggleBtn" onclick="toggleAIMode()">
      ${aiEnabled ? t.aiStatusOn : t.aiStatusOff}
    </button>
  </div>
  <div class="row">${t.soundLabel}:
    <button id="soundToggleBtn" onclick="toggleSoundSetting()">
      ${soundEnabled ? t.soundOn : t.soundOff}
    </button>
  </div>
  <div style="margin-top: 10px; color: #4CAF50;">${gameTranslations[lang].levelMessage}</div>
`;




      document.getElementById("statsContent").innerHTML = statsHTML;
      document.getElementById("playerStats").style.display = "flex";
    }

    function changeGender() {
  let data = JSON.parse(localStorage.getItem("blockPlayerData")) || {};
  data.gender = (data.gender === 'male') ? 'female' : 'male';
  localStorage.setItem("blockPlayerData", JSON.stringify(data));
  reloadAIResponses(); // ğŸ‘ˆ ØªØ¶ÙŠÙ Ø¯ÙŠ
  showPlayerStats();
}



function toggleAIMode() {
  const current = localStorage.getItem("aiModeEnabled");
  const newValue = current === "false" ? "true" : "false";
  localStorage.setItem("aiModeEnabled", newValue);

  // ØªØ­Ø¯ÙŠØ« Ø§Ù„Ø²Ø± Ø¨ØµØ±ÙŠÙ‹Ø§
  const btn = document.getElementById("aiModeToggleBtn");
  if (btn) {
    const t = applyLanguageText(playerData.language || "ar");
btn.textContent = newValue === "true" ? t.aiStatusOn : t.aiStatusOff;

  }
}

function toggleSoundSetting() {
  const current = localStorage.getItem("soundEnabled");
  const newValue = current === "false" ? "true" : "false";
  localStorage.setItem("soundEnabled", newValue);
  isSoundOn = newValue === "true";

  const t = applyLanguageText(playerData.language || "ar");
  const btn = document.getElementById("soundToggleBtn");
  if (btn) {
    btn.textContent = isSoundOn ? t.soundOn : t.soundOff;
  }
}






function getTranslation(key) {
  const lang = localStorage.getItem("lang") || "en";
  return gameTranslations[lang][key] || key;
}


function changeLanguage() {
  let data = JSON.parse(localStorage.getItem("blockPlayerData")) || {};
  data.language = (data.language === 'ar') ? 'en' : 'ar';
  localStorage.setItem("blockPlayerData", JSON.stringify(data));
  reloadAIResponses(); // ğŸ‘ˆ ØªØ¶ÙŠÙ Ø¯ÙŠ
  showPlayerStats();
  applyLanguage();
}


    function closeStats() {
      document.getElementById("playerStats").style.display = "none";
    }

    function getAIPersonalMessage(score) {
      const lang = JSON.parse(localStorage.getItem("blockPlayerData"))?.language || 'ar';
      
      if(score < 100) return lang === 'ar' ? "Ù„Ø³Ù‡ Ø¨ØªØ¨Ø¯Ø£ Ø§Ù„Ø±Ø­Ù„Ø©! ğŸš€" : "Just starting! ğŸš€";
      if(score < 500) return lang === 'ar' ? "Ø£Ø¯Ø§Ø¡ Ø¬Ù…ÙŠÙ„! ğŸ’ª Ø§Ø³ØªÙ…Ø±." : "Good performance! ğŸ’ª Keep going.";
      if(score < 1000) return lang === 'ar' ? "Ø¥Ù†Øª Ù…Ø­ØªØ±Ù! ğŸ”¥" : "You're a pro! ğŸ”¥";
      return gameTranslations[lang].levelMessage;
    }

    function applyLanguage() {
      const saved = JSON.parse(localStorage.getItem("blockPlayerData")) || {};
      const lang = saved.language || "ar";
      const t = gameTranslations[lang];

      document.querySelector(".game-title").textContent = "Block Puzzle AI";
      document.querySelector(".start-btn").textContent = t.startBtn;
      document.querySelector(".stats-btn").textContent = t.statsBtn;
      document.getElementById("shareInsightBtn").textContent = lang === "ar"
  ? "ğŸ”— Ø´Ø§Ø±Ùƒ Ø§Ù„ØªØ­Ù„ÙŠÙ„ Ù…Ø¹ ØµØ­Ø§Ø¨Ùƒ"
  : "ğŸ”— Share Insight";

document.getElementById("closeInsightBtn").textContent = lang === "ar"
  ? "ğŸ ÙƒÙØ§ÙŠØ© ØªØ­Ù„ÙŠÙ„.. Ù†Ø±Ø¬Ø¹ØŸ"
  : "ğŸ Enough insight.. go back?";

      document.getElementById("insightBtn").textContent = lang === "ar"
  ? "ğŸ“˜ ØªÙ‚Ø±ÙŠØ± Ø­Ø§Ù„ØªÙƒ Ø§Ù„Ù†ÙØ³ÙŠØ©"
  : "ğŸ“˜ AI Insight Report";

      document.getElementById("scoreboard").textContent = t.scoreText + score;
      document.querySelector("#gameover h1").textContent = t.gameOver;
      document.getElementById("resumeBtn").textContent = t.resumeBtn;
      document.getElementById("restartBtn").textContent = t.restartBtn;
      document.getElementById("countdown").textContent = t.countdownText;
      document.getElementById("statsText").textContent = t.statsTitle;
      document.getElementById("backBtn").textContent = t.backBtn;

      if (document.getElementById("welcomeScreen").style.display !== "none") {
        chooseLanguage(lang);
      }
    }

    function shareInsight() {
  const report = document.getElementById("insightAiText").textContent;
  if (navigator.share) {
    navigator.share({
      title: "ØªØ­Ù„ÙŠÙ„ Ø§Ù„Ø¨ÙŠØ¶Ø© ğŸ§ ",
      text: report,
    }).then(() => {
      console.log("âœ… ØªÙ… Ù…Ø´Ø§Ø±ÙƒØ© Ø§Ù„ØªØ­Ù„ÙŠÙ„");
    }).catch(err => {
      alert("âŒ ÙØ´Ù„ ÙÙŠ Ø§Ù„Ù…Ø´Ø§Ø±ÙƒØ©: " + err);
    });
  } else {
    alert("Ø§Ù„Ù…Ø´Ø§Ø±ÙƒØ© ØºÙŠØ± Ù…Ø¯Ø¹ÙˆÙ…Ø© ÙÙŠ Ù‡Ø°Ø§ Ø§Ù„Ù…ØªØµÙØ­.");
  }
}


function closeInsight() {
  document.getElementById("insightScreen").classList.add("hidden");
  switchScreen("menu");
}




    function applyLanguageText(lang) {
      return {
        vibrationLabel: lang === 'ar' ? "ğŸ“³ Ø§Ù„Ø§Ù‡ØªØ²Ø§Ø²" : "ğŸ“³ Vibration",
vibrationOn: lang === 'ar' ? "âœ… Ù…ÙØ¹Ù„" : "âœ… On",
vibrationOff: lang === 'ar' ? "ğŸš« ØºÙŠØ± Ù…ÙØ¹Ù„" : "ğŸš« Off",

        soundLabel: lang === 'ar' ? "ğŸ”Š Ø§Ù„ØµÙˆØª" : "ğŸ”Š Sound",
soundOn: lang === 'ar' ? "âœ… Ø´ØºØ§Ù„" : "âœ… On",
soundOff: lang === 'ar' ? "ğŸš« Ù…ØºÙ„Ù‚" : "ğŸš« Off",

        genderLabel: lang === 'ar' ? "ğŸ‘¤ Ø§Ù„Ù†ÙˆØ¹" : "ğŸ‘¤ Gender",
        ageLabel: lang === 'ar' ? "ğŸ‚ Ø§Ù„Ø³Ù†" : "ğŸ‚ Age",
        langLabel: lang === 'ar' ? "ğŸŒ Ø§Ù„Ù„ØºØ©" : "ğŸŒ Language",
        highScore: lang === 'ar' ? "ğŸ† Ø£Ø¹Ù„Ù‰ Ù†ØªÙŠØ¬Ø©" : "ğŸ† High Score",
        lastScore: lang === 'ar' ? "ğŸ¯ Ø¢Ø®Ø± Ù†ØªÙŠØ¬Ø©" : "ğŸ¯ Last Score",
        playCount: lang === 'ar' ? "ğŸ”¥ Ù…Ø±Ø§Øª Ø§Ù„Ù„Ø¹Ø¨" : "ğŸ”¥ Play Count",
        aiMessage: lang === 'ar' ? "ğŸ’¡ Ø§Ù„Ù…Ø³Ø§Ø¹Ø¯ Ø§Ù„Ø°ÙƒÙŠ" : "ğŸ’¡ Smart Assistant",
aiStatusOn: lang === 'ar' ? "âœ… Ù…ÙØ¹Ù„" : "âœ… Enabled",
aiStatusOff: lang === 'ar' ? "ğŸš« ØºÙŠØ± Ù…ÙØ¹Ù„" : "ğŸš« Disabled",

        change: lang === 'ar' ? "ØªØºÙŠÙŠØ±" : "Change"
      };
    }

    let idleTimer, idleRepeater;
    function resetIdleTimer() {
      clearTimeout(idleTimer);
      clearInterval(idleRepeater);

      idleTimer = setTimeout(() => {
        showAIReaction("idle");
        idleRepeater = setInterval(() => {
          showAIReaction("idle");
        }, 15000);
      }, 12000);
    }

    ["pointerdown", "pointermove", "keydown"].forEach(evt =>
      window.addEventListener(evt, resetIdleTimer)
    );
    resetIdleTimer();

   function backToMenu() {
  isGameRunning = false;

  // â›” Ø£ÙˆÙ‚Ù ØµÙˆØª Ø§Ù„Ø¨Ø§Ø¨Ù„ Ø¥Ù† ÙˆÙØ¬Ø¯
  if (SoundManager?.sounds?.bubbleAppear) {
    SoundManager.sounds.bubbleAppear.pause();
    SoundManager.sounds.bubbleAppear.currentTime = 0;
  }

  // â›” Ø£Ø®ÙÙ Ø§Ù„ÙÙ‚Ø§Ø¹Ø©
  document.getElementById("aiBubble")?.classList.add("hidden");
  document.getElementById("aiBubble")?.classList.remove("show", "hide");
  document.getElementById("aiBoard")?.classList.add("hidden");
  document.getElementById("aiBoard")?.classList.remove("show", "hide");
  document.getElementById("aiText")?.classList.remove("show");

  // â›” Ø§Ù…Ø³Ø­ Ø£ÙŠ Ø±Ø³Ø§Ø¦Ù„ Ù…Ø¹Ù„Ù‚Ø©
  messageQueue = [];
  isShowingMessage = false;

  // âœ… Ø§Ø±Ø¬Ø¹ Ù„Ù„Ù‚Ø§Ø¦Ù…Ø©
  switchScreen("menu");
}



let countdownTimer;
function startResumeCountdown() {
  const countdownEl = document.getElementById("countdown");
  const countdownBarContainer = document.getElementById("countdownBarContainer");
  const countdownBar = document.getElementById("countdownBar");
  const restartBtn = document.getElementById("restartBtn");
  const insightBtn = document.getElementById("insightBtn");
  const resumeBtn = document.getElementById("resumeBtn");
  const finalScoreDisplay = document.getElementById("finalScoreDisplay");

  let seconds = 5;

  // Ø¥Ø®ÙØ§Ø¡ Ø§Ù„Ø¹Ù†Ø§ØµØ± Ù‚Ø¨Ù„ Ø§Ù„Ø¨Ø¯Ø¡
  countdownEl.style.display = "block";
  countdownBarContainer.style.display = "block";
  countdownBar.style.animation = "countdownShrink 5s linear forwards";
  countdownEl.textContent = `Ø£Ùˆ Ø§Ù†ØªØ¸Ø± ${seconds} Ø«ÙˆØ§Ù†ÙŠ.`;
  finalScoreDisplay.style.display = "none";
  finalScoreDisplay.classList.remove("show", "bounce-in");

  // Ø¹Ø¯ ØªÙ†Ø§Ø²Ù„ÙŠ
  countdownTimer = setInterval(() => {
    seconds--;
    if (seconds > 0) {
      countdownEl.textContent = `Ø£Ùˆ Ø§Ù†ØªØ¸Ø± ${seconds} Ø«ÙˆØ§Ù†ÙŠ.`;
    }
  }, 1000);

  // Ø¨Ø¹Ø¯ 5 Ø«ÙˆØ§Ù†ÙŠ - Ø¥Ø¸Ù‡Ø§Ø± Ø²Ø± Ø§Ù„ØªÙ‚Ø±ÙŠØ± ÙˆØ§Ù„Ø±ÙŠØ³ØªØ§Ø±Øª + Ø§Ù„Ø³ÙƒÙˆØ± Ù…Ø¹ Ù…Ø¤Ø«Ø±Ø§Øª
setTimeout(() => {
  clearInterval(countdownTimer);
  countdownEl.style.display = "none";
  countdownBarContainer.style.display = "none";
  resumeBtn.style.display = "none";
  restartBtn.style.display = "inline-block";
  insightBtn.style.display = "inline-block";

  // âœ¨ Ø¥Ø¸Ù‡Ø§Ø± Ø§Ù„Ø³ÙƒÙˆØ± Ø¨Ø¹Ø¯ Ø§Ù†ØªÙ‡Ø§Ø¡ Ø§Ù„Ø¹Ø¯Ø§Ø¯ ÙÙ‚Ø·
  finalScoreDisplay.textContent = score;
  finalScoreDisplay.style.display = "block";
  finalScoreDisplay.classList.add("show", "bounce-in");

  // ğŸ’¥ Ù…ÙØ±Ù‚Ø¹Ø§Øª Ø­ÙˆÙ„ Ø§Ù„Ø³ÙƒÙˆØ±
  for (let i = 0; i < 15; i++) {
    const particle = document.createElement("div");
    particle.className = "score-particle";
    particle.style.left = `${50 + Math.random() * 10 - 5}%`;
    particle.style.top = `${50 + Math.random() * 10 - 5}%`;
    particle.style.setProperty('--x', `${Math.random() * 200 - 100}px`);
    particle.style.setProperty('--y', `${Math.random() * 200 - 100}px`);
    finalScoreDisplay.appendChild(particle);

    setTimeout(() => particle.remove(), 1500);
  }

}, 5000);

}




function showReactionMessage(message) {
  const aiEnabled = localStorage.getItem("aiModeEnabled") !== "false";
if (!aiEnabled) return;

  const isGameActive = document.getElementById("game").classList.contains("active");
  const isIntroActive = document.getElementById("avatarIntroScreen").classList.contains("active");

  // ğŸ‘‡ Ù„Ùˆ Ø§Ù„Ø´Ø§Ø´Ø© Ù…Ø´ Ù†Ø´Ø·Ø© Ø­Ø§Ù„ÙŠÙ‹Ø§ØŒ Ø§Ø³ØªÙ†Ù‰ Ø´ÙˆÙŠØ© ÙˆØ¬Ø±Ø¨ ØªØ§Ù†ÙŠ
  if (!(isGameActive || isIntroActive)) {
    setTimeout(() => {
      showReactionMessage(message);
    }, 200);
    return;
  }

  if (document.hidden) {
    isShowingMessage = false;
    return;
  }




  if (isGameRunning) {
  SoundManager.play('bubbleAppear');
}

  const aiBubble = document.getElementById("aiBubble");
  const aiBoard = document.getElementById("aiBoard");
  const aiText = document.getElementById("aiText");
  const heatBar = document.getElementById("aiHeatBar");
  const aiDots = document.querySelector(".ai-dots");

  aiText.textContent = "";
  aiDots.style.display = "flex"; // Ø§Ø¸Ù‡Ø§Ø± Ø§Ù„Ù†Ù‚Ø· Ø§Ù„Ù„ÙŠ Ø¨ØªØªØ­Ø±Ùƒ

  aiBubble.classList.remove("hidden");
  aiBoard.classList.remove("hidden");
  aiBubble.classList.add("show");
  aiBoard.classList.add("show");
  aiText.classList.remove("hidden");
  aiText.classList.add("show");

  // Reset and animate the heat bar
  heatBar.style.width = "100%";
  heatBar.style.transition = "none";
  void heatBar.offsetWidth;
  heatBar.style.transition = "width 3s linear";
  heatBar.style.width = "0%";

  // Ø¨Ø¹Ø¯ Ø«Ø§Ù†ÙŠØ© Ù…Ù† Ø§Ù„ØªÙÙƒÙŠØ±ØŒ ÙŠØ¨Ø¯Ø£ ÙŠÙƒØªØ¨ Ø§Ù„Ø¬Ù…Ù„Ø©
  setTimeout(() => {
    aiDots.style.display = "none"; // Ø§Ø®ÙØ§Ø¡ Ø§Ù„Ù†Ù‚Ø·
    let charIndex = 0;
    function typeNextChar() {
      if (charIndex < message.length) {
        aiText.textContent += message[charIndex];
        charIndex++;
        setTimeout(typeNextChar, 40); // Ø³Ø±Ø¹Ø© Ø§Ù„Ø­Ø±Ù
      }
    }
    typeNextChar();
  }, 1000); // ÙˆÙ‚Øª Ø§Ù„ØªÙÙƒÙŠØ± Ù‚Ø¨Ù„ ÙŠØ¨Ø¯Ø£ ÙŠÙƒØªØ¨

  // Hide after 3.5 seconds
  setTimeout(() => {
    aiBubble.classList.add("hide");
    aiBoard.classList.add("hide");
    aiText.classList.remove("show");

    setTimeout(() => {
      aiBubble.classList.remove("show", "hide");
      aiBoard.classList.remove("show", "hide");
      aiBubble.classList.add("hidden");
      aiBoard.classList.add("hidden");
      aiText.classList.add("hidden");

      processMessageQueue();
    }, 500);
  }, 3500);
}




function startAvatarBlink() {
  const avatarImg = document.getElementById("aiAvatar");
  setInterval(() => {
    avatarImg.classList.add("blink");
    setTimeout(() => {
      avatarImg.classList.remove("blink");
    }, 200); // Ù…Ø¯Ø© Ø§Ù„Ø±Ù…Ø´
  }, 4000); // ÙƒÙ„ 4 Ø«ÙˆØ§Ù†ÙŠ Ø±Ù…Ø´Ø©
}

startAvatarBlink();

window.allAIResponses = {}; // Ù…ÙƒØ§Ù† ØªØ®Ø²ÙŠÙ† ÙƒÙ„ Ø§Ù„Ø¬Ù…Ù„

function loadAllAIResponses(callback) {
  const configs = ['ar_male', 'ar_female', 'en_male', 'en_female'];
  let loadedCount = 0;
  const totalToLoad = configs.length;

  function checkAllLoaded() {
    loadedCount++;
    console.log(`âœ… ØªÙ… ØªØ­Ù…ÙŠÙ„ (${loadedCount}/${totalToLoad})`);
    if (loadedCount === totalToLoad) {
      console.log("ğŸ‰ Ø§ÙƒØªÙ…Ù„ ØªØ­Ù…ÙŠÙ„ Ø¬Ù…ÙŠØ¹ Ù…Ù„ÙØ§Øª Ø§Ù„Ø±Ø¯ÙˆØ¯");
      if (callback) callback();
    }
  }

  configs.forEach(config => {
    const script = document.createElement('script');
    script.src = `ai_responses/aiResponses_${config}.js`;
    script.onload = function() {
      if (window.tempAIResponses) {
        window.allAIResponses[config] = window.tempAIResponses;
        delete window.tempAIResponses;
      }
      checkAllLoaded();
    };
    script.onerror = function() {
      console.error(`âŒ ÙØ´Ù„ ØªØ­Ù…ÙŠÙ„: aiResponses_${config}.js`);
      checkAllLoaded();
    };
    document.body.appendChild(script);
  });
}


function toggleSound() {
  isSoundOn = !isSoundOn;

  const icon = document.getElementById("soundIcon");

  if (isSoundOn) {
    icon.setAttribute("fill", "#2196F3");
    icon.setAttribute("d", "M3 9v6h4l5 5V4L7 9H3zm13.5 3c0-1.77-1.02-3.29-2.5-4.03v8.05c1.48-.73 2.5-2.25 2.5-4.02z");
  } else {
    icon.setAttribute("fill", "#ccc");
    icon.setAttribute("d", "M3 9v6h4l5 5V4L7 9H3z"); // Ø´ÙƒÙ„ Ù…ÙƒØ¨Ø± Ø¨Ø¯ÙˆÙ† Ù…ÙˆØ¬Ø§Øª
  }
}

window.onload = () => {
  loadAllAIResponses(() => {
    reloadAIResponses();
    let savedData = JSON.parse(localStorage.getItem("blockPlayerData"));
    if (savedData && savedData.language) {
      document.getElementById("welcomeScreen").style.display = "none";
      applyLanguage();
    }
    setupButtonSounds(); // <-- Ù‡Ø°Ù‡ Ù‡ÙŠ Ø§Ù„Ø¥Ø¶Ø§ÙØ© Ø§Ù„Ø¬Ø¯ÙŠØ¯Ø©
  });
}

// Sound Manager - ÙŠØ¯ÙŠØ± Ø¬Ù…ÙŠØ¹ Ø§Ù„Ø£ØµÙˆØ§Øª ÙÙŠ Ø§Ù„Ù„Ø¹Ø¨Ø©
const SoundManager = {
  sounds: {},
  context: new (window.AudioContext || window.webkitAudioContext)(),
buffers: {}, // Ù„ØªØ®Ø²ÙŠÙ† Ø§Ù„Ø£ØµÙˆØ§Øª Ø¨Ø¹Ø¯ ÙÙƒ ØªØ´ÙÙŠØ±Ù‡Ø§
loadSounds: async function () {
  const files = {
    buttonClick: "assets/sounds/button-click.mp3",
    shapePick: "assets/sounds/shape-pick.mp3",
    singleClear: "assets/sounds/singleClear.mp3",
    comboClear: "assets/sounds/combo-clear.mp3",
    bubbleAppear: "assets/sounds/bubble-appear.mp3"
  };

  const ctx = this.context;

  for (let key in files) {
    try {
      const response = await fetch(files[key]);
      const arrayBuffer = await response.arrayBuffer();
      const audioBuffer = await ctx.decodeAudioData(arrayBuffer);
      this.buffers[key] = audioBuffer;

      // âœ… ØªØ³Ø®ÙŠÙ† buttonClick Ø¨Ø¹Ø¯ Ø§Ù„ØªØ­Ù…ÙŠÙ„
      if (key === 'buttonClick') {
        const source = ctx.createBufferSource();
        source.buffer = audioBuffer;
        source.connect(ctx.destination);
        source.start(0);
        source.stop(ctx.currentTime + 0.05); // ØªÙˆÙ‚Ù Ø³Ø±ÙŠØ¹
      }

    } catch (err) {
      console.warn("âŒ ÙØ´Ù„ ØªØ­Ù…ÙŠÙ„ Ø§Ù„ØµÙˆØª:", key, err);
    }
  }

  console.log("âœ… Ø§Ù„Ø£ØµÙˆØ§Øª ØªÙ… ØªØ­Ù…ÙŠÙ„Ù‡Ø§ ÙˆÙÙƒ ØªØ´ÙÙŠØ±Ù‡Ø§");
},


play: function (name) {
  if (!isSoundOn) return;

  const buffer = this.buffers?.[name];
  if (buffer) {
    const source = this.context.createBufferSource();
    source.buffer = buffer;
    source.connect(this.context.destination);
    source.start(0);
  }
},

};

  </script>

<script>
document.addEventListener("DOMContentLoaded", () => {
  const grid = document.getElementById("grid");
  if (!grid) {
    console.warn("âš ï¸ Ø§Ù„Ø¹Ù†ØµØ± #grid ØºÙŠØ± Ù…ÙˆØ¬ÙˆØ¯.");
    return;
  }

  window.manager = new Hammer.Manager(grid);

  const Pan = new Hammer.Pan({ threshold: 5 });
  manager.add(Pan);

manager.on('panstart panmove panend', (e) => {
  const eventMap = {
    'panstart': 'pointerdown',
    'panmove': 'pointermove',
    'panend': 'pointerup'
  };

  // âœ… Ù…Ù†Ø¹ Ø£ÙŠ Ù„Ù…Ø³Ø© Ø¥Ø¶Ø§ÙÙŠØ© ØºÙŠØ± Ø§Ù„Ø£ÙˆÙ„Ù‰
  if (eventMap[e.type] === "pointerdown" && isTouchActive) return;
  if (eventMap[e.type] === "pointerdown") isTouchActive = true;
  if (eventMap[e.type] === "pointerup") isTouchActive = false;

  const event = new PointerEvent(eventMap[e.type], {
    clientX: e.center.x,
    clientY: e.center.y
  });

 const realTarget = document.elementFromPoint(e.center.x, e.center.y);
if (realTarget) {
  realTarget.dispatchEvent(event);
}

});


  // ğŸŸ¢ ØªØ®Ø²ÙŠÙ†Ù‡ ÙÙŠ window Ø¹Ù„Ø´Ø§Ù† ØªØ³ØªØ®Ø¯Ù…Ù‡ ÙÙŠ Ø£Ù…Ø§ÙƒÙ† ØªØ§Ù†ÙŠØ© Ù„Ùˆ Ø­Ø¨ÙŠØª
  window.hammerManager = manager;
});
</script>

<script>
  document.addEventListener("DOMContentLoaded", () => {
    const grid = document.getElementById("grid");
    if (!grid) {
      console.warn("âš ï¸ Ø§Ù„Ø¹Ù†ØµØ± #grid Ù…Ø´ Ù…ÙˆØ¬ÙˆØ¯.");
      return;
    }
  
    window.manager = new Hammer.Manager(grid);
    const Pan = new Hammer.Pan({ threshold: 5 });
    window.manager.add(Pan);
  
    window.manager.on('panstart panmove panend', (e) => {
      const eventMap = {
        'panstart': 'pointerdown',
        'panmove': 'pointermove',
        'panend': 'pointerup'
      };
  
      const event = new PointerEvent(eventMap[e.type], {
        clientX: e.center.x,
        clientY: e.center.y
      });
  
     const realTarget = document.elementFromPoint(e.center.x, e.center.y);
if (realTarget) {
  realTarget.dispatchEvent(event);
}

    });
  });
  </script>

<script>
  document.addEventListener("DOMContentLoaded", () => {
    const grid = document.getElementById("grid");
    if (!grid) {
      console.warn("âš ï¸ Ø§Ù„Ø¹Ù†ØµØ± #grid ØºÙŠØ± Ù…ÙˆØ¬ÙˆØ¯.");
      return;
    }
  
    window.manager = new Hammer.Manager(grid);
    const Pan = new Hammer.Pan({ threshold: 5 });
    window.manager.add(Pan);
  
    window.manager.on('panstart panmove panend', (e) => {
      const eventMap = {
        'panstart': 'pointerdown',
        'panmove': 'pointermove',
        'panend': 'pointerup'
      };
  
      const event = new PointerEvent(eventMap[e.type], {
        clientX: e.center.x,
        clientY: e.center.y
      });
  
      const realTarget = document.elementFromPoint(e.center.x, e.center.y);
if (realTarget) {
  realTarget.dispatchEvent(event);
}

    });
  
    // âœ… Ø£ÙŠ Ø§Ø³ØªØ®Ø¯Ø§Ù… ØªØ§Ù†ÙŠ Ù„Ù„Ù€ manager Ù„Ø§Ø²Ù… ÙŠØ¨Ù‚Ù‰ Ù‡Ù†Ø§ Ø£Ùˆ Ø¨Ø¹Ø¯Ù‡
  });

  window.addEventListener('DOMContentLoaded', async () => {
  await preloadEverything(); // Ù‡Ù†Ø§ Ø¨Ù†ÙØªØ±Ø¶ Ø¹Ù†Ø¯Ùƒ Ø¯Ø§Ù„Ø© ØªØ­Ù…ÙŠÙ„ Ø£ØµÙˆØ§Øª/ØµÙˆØ±


document.body.addEventListener("touchend", (e) => {
  if (activePointerId !== "touch") return;

  const isOriginalTouchGone = Array.from(e.changedTouches).some(t => t.identifier === activeTouchId);
  if (!isOriginalTouchGone) return; // âœ… Ù„Ùˆ Ø§Ù„Ù„ÙŠ Ø®Ø±Ø¬ Ù…Ø´ Ù†ÙØ³ Ø§Ù„Ù„Ù…Ø³Ø© Ø§Ù„Ø£ØµÙ„ÙŠØ©ØŒ ØªØ¬Ø§Ù‡Ù„

  activePointerId = null;
  activeTouchId = null;

  if (!floating) return;

  const cellSize = gridCells[0].getBoundingClientRect().width;

  // Ù†Ø³ØªØ®Ø¯Ù… Ø¢Ø®Ø± Ø¥Ø­Ø¯Ø§Ø«ÙŠØ§Øª Ù…Ø­ÙÙˆØ¸Ø©
  const moveX = (lastPointer.pageX - pointerStartX) * 1.4;
  const moveY = (lastPointer.pageY - pointerStartY) * 1.4;

  const boostedX = floatingStartX + moveX;
  const boostedY = floatingStartY + moveY;

  const gridRect = grid.getBoundingClientRect();
  const gridX = Math.floor((boostedX + cellSize * 0.5 - gridRect.left) / (gridRect.width / 8));
  const gridY = Math.floor((boostedY + cellSize * 0.5 - gridRect.top) / (gridRect.height / 8));

  tryDropFloatingShape(gridX, gridY);
});

  // Ù†Ø¯ÙŠ ÙØ±ØµØ© 2 Ø«Ø§Ù†ÙŠØ© Ù„Ù„Ø¹Ø±Ø¶
  setTimeout(() => {
    document.getElementById("splashScreen").style.display = "none";
   // Ø¯ÙŠ Ø§Ù„Ø¯Ø§Ù„Ø© Ø§Ù„Ù„ÙŠ ØªÙØªØ­ Ø§Ù„Ù‚Ø§Ø¦Ù…Ø© Ø£Ùˆ intro AI
  }, 2000);
});



  </script>
  

  <script>
  if ('serviceWorker' in navigator) {
    navigator.serviceWorker.getRegistrations().then(registrations => {
      for (let reg of registrations) {
        reg.update(); // ØªØ­Ø¯Ø« ØªÙ„Ù‚Ø§Ø¦ÙŠÙ‹Ø§
      }
    });
  }
</script>





<script>
  if ('serviceWorker' in navigator) {
    window.addEventListener('load', () => {
      navigator.serviceWorker.register('/service-worker.js')
        .then(reg => console.log('âœ… Service Worker registered:', reg))
        .catch(err => console.error('âŒ SW registration failed:', err));
    });
  }
</script>


</body>
</html>