<!DOCTYPE html>
<html lang="ar">
<head>


  
  <link rel="manifest" href="manifest.json">
<meta name="theme-color" content="#121212">

  <meta name="apple-mobile-web-app-capable" content="yes">
  <meta name="apple-mobile-web-app-status-bar-style" content="black-translucent">
  <meta name="mobile-web-app-capable" content="yes">
  <meta name="viewport" content="width=device-width, initial-scale=1, viewport-fit=cover">


  <script>
  if ('serviceWorker' in navigator) {
    navigator.serviceWorker.register('service-worker.js')
      .then(() => console.log('‚úÖ Service Worker registered'))
      .catch(err => console.error('‚ùå Service Worker failed:', err));
  }
</script>


  <script>
    function enterFullscreen() {
      if (document.documentElement.requestFullscreen) {
        document.documentElement.requestFullscreen();
      } else if (document.documentElement.mozRequestFullScreen) { // Firefox
        document.documentElement.mozRequestFullScreen();
      } else if (document.documentElement.webkitRequestFullscreen) { // Chrome, Safari
        document.documentElement.webkitRequestFullscreen();
      } else if (document.documentElement.msRequestFullscreen) { // IE/Edge
        document.documentElement.msRequestFullscreen();
      }
    }
  
    window.addEventListener('load', function () {
      enterFullscreen(); // ÿ™ÿ£ŸÉÿØ ŸÖŸÜ ÿ£ŸÜ ÿßŸÑŸàÿ∏ŸäŸÅÿ© ÿ™ŸèŸÜŸÅÿ∞ ÿπŸÜÿØ ÿ™ÿ≠ŸÖŸäŸÑ ÿßŸÑÿµŸÅÿ≠ÿ©
    });
  </script>
  
  
  <script src="https://unpkg.com/hammerjs@2.0.8/hammer.min.js"></script>

  <title>Block Puzzle AI</title>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0"/>
  <style>




#aiModeToggleBtn,
#soundToggleBtn {
  padding: 8px 16px;
  border-radius: 12px;
  background: linear-gradient(45deg, #2196F3, #21CBF3);
  color: white;
  font-size: 1rem;
  font-weight: bold;
  border: none;
  cursor: pointer;
  transition: all 0.3s ease;
  box-shadow: 0 0 10px rgba(33, 150, 243, 0.4);
}

#aiModeToggleBtn:hover,
#soundToggleBtn:hover {
  background: linear-gradient(45deg, #00C853, #00E676);
  box-shadow: 0 0 14px rgba(0, 230, 118, 0.5);
}

.enhanced-welcome {
  background: linear-gradient(145deg, #f9f9f9, #ffffff);
  border-radius: 25px;
  padding: 40px 30px;
  box-shadow: 0 8px 24px rgba(0, 0, 0, 0.08);
  max-width: 420px;
  margin: auto;
  text-align: center;
  display: flex;
  flex-direction: column;
  gap: 25px;
  animation: fadeIn 0.7s ease-in-out;
}

.welcome-title {
  font-size: 1.4rem;
  color: #2196F3;
  margin-bottom: 10px;
  font-weight: bold;
}

.btn-group {
  display: flex;
  flex-wrap: wrap;
  justify-content: center;
  gap: 15px;
}

.hero-btn {
  background: #E3F2FD;
  color: #0D47A1;
  border: none;
  border-radius: 12px;
  padding: 10px 18px;
  font-size: 1rem;
  font-weight: 600;
  cursor: pointer;
  transition: background 0.3s ease;
  min-width: 120px;
}

.hero-btn:hover {
  background: #BBDEFB;
}

.step p {
  font-size: 1.1rem;
  color: #444;
  margin-bottom: 10px;
}


#playerStatsCard {
  background: #fff;
  border-radius: 25px;
  padding: 30px;
  max-width: 420px;
  margin: auto;
  box-shadow: 0 4px 12px rgba(0,0,0,0.1);
  display: flex;
  flex-direction: column;
  align-items: center;
  gap: 20px;
  animation: fadeInCard 0.5s ease;
  text-align: center;
}

.stats-title {
  color: #2196F3;
  font-size: 1.3rem;
  margin-bottom: 10px;
}

.stats-content {
  font-size: 1rem;
  line-height: 1.8;
  width: 100%;
}

.stats-content .row {
  display: flex;
  justify-content: space-between;
  align-items: center;
  margin: 8px 0;
}

.stats-content button {
  padding: 5px 10px;
  font-size: 0.85rem;
  border-radius: 10px;
  background-color: #E3F2FD;
  border: 1px solid #90CAF9;
  color: #0D47A1;
  cursor: pointer;
}





#languageGenderCard {
  background: #ffffff;
  border-radius: 20px;
  padding: 25px;
  max-width: 400px;
  margin: auto;
  box-shadow: 0 4px 15px rgba(0, 0, 0, 0.1);
  display: flex;
  flex-direction: column;
  align-items: center;
  gap: 20px;
  animation: fadeInCard 0.6s ease;
}


  #countdownBarContainer {
    width: 100%;
    max-width: 300px;
    height: 12px;
    background: #ddd;
    border-radius: 8px;
    overflow: hidden;
    margin: 10px auto;
    display: none;
  }

  #countdownBar {
    height: 100%;
    width: 100%;
    background: linear-gradient(90deg, #ff00cc, #3333ff, #00ffff, #00cc66, #ffff00, #ff6600, #ff0033);
    background-size: 400% 100%;
    animation: colorfulShift 5s linear infinite, countdownShrink 5s linear forwards;
    transition: width 0.1s linear;
  }

  @keyframes colorfulShift {
    0% { background-position: 0% 50%; }
    100% { background-position: 100% 50%; }
  }

  @keyframes countdownShrink {
    0% { width: 100%; }
    100% { width: 0%; }
  }

#welcomeScreen {
  position: fixed;
  top: 0;
  left: 0;
  width: 100vw;
  height: 100vh;
  background: white;
  z-index: 999;
  display: flex;
  align-items: center;
  justify-content: center;
  flex-direction: column;
}




.fade-out {
  animation: fadeOut 0.7s ease forwards;
}

@keyframes fadeOut {
  from {
    opacity: 1;
  }
  to {
    opacity: 0;
    visibility: hidden;
  }
}


.splash-screen {
  background: linear-gradient(to bottom, #3a0055 0%, #4a007d 50%, #5e20a0 100%);
  position: fixed;
  top: 0; left: 0;
  width: 100%;
  height: 100%;
  display: flex;
  flex-direction: column;
  align-items: center;
  justify-content: center;
  color: white;
  z-index: 9999;
}
.splash-screen::before {
  content: "";
  position: absolute;
  top: 0;
  left: 0;
  width: 100%;
  height: 100%;
  background: radial-gradient(ellipse at top, rgba(255,255,255,0.08), transparent 70%);
  pointer-events: none;
}


.studio-logo {
  width: 240px;
  height: 240px;
  animation: pulse 2s infinite;
}

.studio-name {
  font-size: 1.5rem;
  font-weight: 600;
  font-family: 'Tajawal', sans-serif;
}

@keyframes pulse {
  0% { transform: scale(1); opacity: 0.6; }
  50% { transform: scale(1.05); opacity: 1; }
  100% { transform: scale(1); opacity: 0.6; }
}

    

    
    
    .back-home-btn {
      position: absolute;
      top: 20px;
      left: 20px;
      width: 48px;
      height: 48px;
      background: rgba(255, 255, 255, 0.9);
      border: 2px solid #2196F3;
      border-radius: 50%;
      cursor: pointer;
      display: flex;
      align-items: center;
      justify-content: center;
      z-index: 1000;
      box-shadow: 0 2px 10px rgba(0,0,0,0.1);
      transition: all 0.3s ease;
    }
    
    .back-home-btn:hover {
      background: #2196F3;
      transform: scale(1.1);
    }
    
    .back-home-btn svg {
      stroke: #2196F3;
      transition: all 0.3s ease;
    }
    
    .back-home-btn:hover svg {
      stroke: white;
    }
    
    .screen {
      display: none;
      flex-direction: column;
      align-items: center;
      justify-content: center;
      width: 100%;
      height: 100%;
      position: absolute;
      top: 0;
      left: 0;
      background: #eef6fb;
      text-align: center;
      padding: 20px;
      box-sizing: border-box;
    }
    
    .active { display: flex; }
    
    h1, h2 {
      color: #2196f3;
      margin: 10px;
      font-weight: 600;
    }
    
    .btn {
      background: linear-gradient(45deg, #2196f3, #21cbf3);
      color: white;
      border: none;
      padding: 12px 25px;
      border-radius: 12px;
      cursor: pointer;
      font-size: 1.2em;
      margin-top: 15px;
      box-shadow: 0 4px 12px rgba(0,0,0,0.1);
      transition: all 0.3s ease;
    }
    
    .btn:hover {
      transform: translateY(-2px);
      box-shadow: 0 6px 16px rgba(0,0,0,0.2);
    }
    
    #scoreboard {
      font-size: 1.2rem;
      margin: 10px;
      font-weight: bold;
      color: #2196F3;
    }
    
    #grid {
      display: grid;
      gap: 2px;
      margin: 10px auto;
      width: 90vmin;
      height: 90vmin;
      max-width: 400px;
      max-height: 400px;
      grid-template-columns: repeat(8, 1fr);
      grid-template-rows: repeat(8, 1fr);
    }
    
    .cell {
      width: 100%;
      height: 100%;
      background: #fff;
      border: 1px solid #ccc;
      border-radius: 4px;
      transition: background 0.3s ease;
    }
    
    .filled { background: #2196f3; }
    .preview { background-color: rgba(33, 150, 243, 0.5); }
    .line-clear-preview { background-color: rgba(76, 175, 80, 0.6) !important; }
    
    #shapes {
      display: flex;
      gap: 15px;
      flex-wrap: wrap;
      justify-content: center;
      margin: 10px auto;
      width: 100%;
      max-width: 600px;
    }
    
.floating.shape {
  grid-template-columns: repeat(4, var(--cell-size));
  grid-template-rows: repeat(4, var(--cell-size));
}


.shape {
  touch-action: none;
  display: grid;
  grid-template-columns: repeat(4, clamp(20px, 5vmin, 60px));
  grid-template-rows: repeat(4, clamp(20px, 5vmin, 60px));
  gap: 3px;
  cursor: grab;
  touch-action: none;
}

@media (max-width: 600px) {
  #shapes {
    flex-wrap: nowrap;
    overflow-x: hidden; /* ‚Üê ŸäŸÖŸÜÿπ ÿßŸÑÿ≥ŸÉÿ±ŸàŸÑ */
    justify-content: space-between;
  }

  #shapes .shape {
    grid-template-columns: repeat(4, 28px); /* ‚Üê ÿ®ÿØŸÑ 36 */
    grid-template-rows: repeat(4, 28px);
    gap: 1.5px;
    flex: 0 0 auto;
  }
}


    
    .block {
      width: 100%;
      height: 100%;
      background: #2196f3;
      border-radius: 4px;
      transition: transform 0.15s ease;
      pointer-events: none;
    }
    
 .floating {
  position: absolute;
  pointer-events: none;
  z-index: 9999;
  will-change: transform;
  transition: none !important;

}

    
   #finalScoreDisplay {
  font-size: 0; /* ‚Üê ŸÑÿ™ŸÅÿßÿØŸä ÿßŸÑÿ™ÿØÿßÿÆŸÑ */
  opacity: 0;
}

    
   
    
    #countdown {
      font-size: 1.1rem;
      margin-top: 10px;
      color: #888;
    }
    
    /* üëá AI Reaction Container */
    #aiContainer {
      position: relative;
      width: 100%;
      max-width: 600px;
      margin: 10px auto;
      display: flex;
      flex-direction: column;
      align-items: center;
      min-height: 120px;
    }
    
    #aiInteractiveArea {
      display: flex;
      align-items: center;
      justify-content: center;
      width: 100%;
      margin-bottom: 10px;
      position: relative;
      min-height: 100px;
    }
    
    .ai-bubble {
      position: relative;
      width: 80px;
      height: 80px;
      opacity: 0;
      transform: scale(0.5) translateY(20px);
      transition: all 0.4s ease;
      z-index: 10;
      margin-right: 15px;
    }
    
    .ai-bubble.show {
      opacity: 1;
      transform: scale(1) translateY(0);
    }
    
    .bubble-inner {
      width: 100%;
      height: 100%;
      border-radius: 50%;
      background: radial-gradient(circle at 30% 30%, #ffffff22, #00000033);
      border: 2px solid #ffffff55;
      display: flex;
      align-items: center;
      justify-content: center;
      animation: float 4s ease-in-out infinite;
      box-shadow: 0 0 12px rgba(255, 255, 255, 0.1);
    }
    
    @keyframes float {
      0%, 100% { transform: translateY(0); }
      50% { transform: translateY(-6px); }
    }
    
    .bubble-inner img {
      width: 60px;
      height: 60px;
      object-fit: contain;
      animation: avatarPulse 2.8s ease-in-out infinite, avatarBlink 6s ease-in-out infinite;
      transform-origin: center center;
    }
    
    @keyframes avatarPulse {
      0%, 100% { transform: scale(1); filter: brightness(1); }
      50% { transform: scale(1.2); filter: brightness(1.25); }
    }
    
    @keyframes avatarBlink {
      0%, 96%, 100% { transform: scaleY(1); filter: brightness(1); }
      97% { transform: scaleY(0.1); filter: brightness(0.3); }
      98% { transform: scaleY(1); filter: brightness(1); }
    }
    
    #aiBoard {
  width: 90vmin;
  max-width: 400px;
  min-height: 80px;
  background: #ffffff;
  border-radius: 16px;
  box-shadow: 0 2px 10px rgba(0,0,0,0.1);
  padding: 10px 20px;
  display: flex;
  justify-content: center;
  align-items: center;
  flex-direction: column;
  opacity: 0;
  transform: scaleX(0);
  transition: all 0.4s ease;
  overflow: hidden;
}
    
    #aiBoard.show {
      transform: scaleX(1);
      opacity: 1;
    }
    
    #aiText {
  font-size: 1.2rem;
  font-weight: 600;
  color: #2196f3;
  text-align: center;
  line-height: 1.4;
  padding: 0 10px;
  word-break: break-word;
  max-width: 100%;
  opacity: 0;
  transform: translateY(10px);
  transition: all 0.5s ease;
  margin: 0;
}

    
    #aiText.show {
      opacity: 1;
      transform: translateY(0);
    }
    
  
    
    @keyframes bubbleEnter {
      0% { opacity: 0; transform: scale(0.2) rotate(0deg); filter: blur(4px); }
      20% { opacity: 1; transform: scale(1.05) rotate(2deg); }
      40% { transform: scale(0.95) rotate(-2deg); }
      60% { transform: scale(1.02) rotate(1deg); }
      80% { transform: scale(0.98) rotate(-1deg); }
      100% { transform: scale(1) rotate(0deg); filter: blur(0); }
    }
    
    @keyframes bubbleExit {
      0% { opacity: 1; transform: scale(1); }
      100% { opacity: 0; transform: scale(0.5) rotate(-10deg); filter: blur(3px); }
    }
    
    .ai-bubble.show {
      animation: bubbleEnter 0.4s ease-out forwards;
    }
    
    .ai-bubble.hide {
      animation: bubbleExit 0.4s ease-in forwards;
    }
    
    @keyframes boardEnter {
      0% { transform: translateX(-100%) scaleX(0); opacity: 0; }
      60% { transform: translateX(20%) scaleX(1.1); opacity: 1; }
      100% { transform: translateX(0) scaleX(1); opacity: 1; }
    }
    
    @keyframes boardExit {
      0% { transform: translateX(0) scaleX(1); opacity: 1; }
      100% { transform: translateX(-100%) scaleX(0); opacity: 0; }
    }
    
    #aiBoard.show {
      animation: boardEnter 0.5s ease-out forwards;
    }
    
    #aiBoard.hide {
      animation: boardExit 0.5s ease-in forwards;
    }
    
.welcome-screen {
  position: fixed;
  top: 0; left: 0;
  width: 100vw;
  height: 100vh;
  background: #eef6fb;
  display: flex;
  align-items: center;
  justify-content: center;
  z-index: 1000;
  flex-direction: column;
}




.welcome-card {
  max-width: 90%;
  padding: 20px;
  box-shadow: 0 0 10px rgba(0,0,0,0.1);
  background: white;
  border-radius: 12px;
  display: flex;
  flex-direction: column;
  align-items: center;
  justify-content: center; /* ÿØŸä ÿßŸÑŸÖŸáŸÖÿ© üëë */
  min-height: 200px; /* ÿ≠ÿ≥ÿ® ÿ≠ÿ¨ŸÖ ÿßŸÑŸÖÿ≠ÿ™ŸàŸâ */
   display: contents; /* ‚Üê ŸäÿÆŸÑŸäŸáÿß ÿ¥ŸÅÿßŸÅÿ© ŸÑŸÑÿ™ŸÜÿ≥ŸäŸÇ ÿ®ÿØŸàŸÜ ŸÖÿß ÿ™ÿ£ÿ´ÿ± ÿπŸÑŸâ ÿßŸÑÿ™ŸÖÿ±ŸÉÿ≤ */
}


@keyframes fadeInCard {
  0% { opacity: 0; transform: translateY(20px); }
  100% { opacity: 1; transform: translateY(0); }
}


    .welcome-card p {
      font-size: 1.3rem;
      margin-bottom: 15px;
    }
    
    .welcome-card .btn {
      margin: 8px;
    }
    
    .game-title {
      font-size: 3.5rem;
      color: #2196F3;
      margin: 0 0 30px 0;
      font-weight: 800;
      text-shadow: 0 3px 6px rgba(0,0,0,0.1);
      animation: pulse 2s infinite;
      display: inline-block;
      padding: 0 20px;
      text-align: center;
      width: 100%;
      box-sizing: border-box;
    }
    
    @keyframes pulse {
      0% { transform: scale(1); }
      50% { transform: scale(1.03); }
      100% { transform: scale(1); }
    }
    
    #menu {
      overflow: hidden;
      padding: 0 15px;
      justify-content: center;
    }
    
    .menu-content {
      display: flex;
      flex-direction: column;
      align-items: center;
      justify-content: center;
      height: 100%;
      margin-top: -50px;
    }
    
    .start-btn {
      padding: 15px 40px;
      font-size: 1.5rem;
      margin: 10px 0;
    }
    
    .stats-btn {
      background: rgba(33, 150, 243, 0.1);
      color: #2196F3;
      margin: 10px 0 30px 0;
    }
    
    .copyright {
      font-size: 0.8rem; 
      color: #777;
      margin-top: 40px;
      position: absolute;
      bottom: 20px;
    }
    
    .hidden {
      display: none !important;
    }
    
    #aiFlash {
      position: fixed;
      top: 0;
      left: 0;
      width: 100%;
      height: 100%;
      background: white;
      opacity: 0;
      pointer-events: none;
      z-index: 9999;
      transition: opacity 0.2s ease;
    }
    
/* ÿßŸÑŸÜŸÇÿßÿ∑ */
.ai-dots {
  position: absolute;
  top: 100%;
  left: 50%;
  transform: translateX(-50%);
  display: flex;
  gap: 3px;
  margin-top: 6px;
  animation: curveDots 2s infinite ease-in-out;
}

@keyframes curveDots {
  0% { transform: translateX(-50%) translateY(0) rotate(0deg); }
  50% { transform: translateX(-50%) translateY(3px) rotate(25deg); }
  100% { transform: translateX(-50%) translateY(0) rotate(0deg); }
}

.ai-dots span {
  width: 6px;
  height: 6px;
  background: white;
  border-radius: 50%;
  opacity: 0.6;
  animation: dotFlash 1s infinite alternate;
}

.ai-dots span:nth-child(2) { animation-delay: 0.2s; }
.ai-dots span:nth-child(3) { animation-delay: 0.4s; }

@keyframes dotFlash {
  0% { transform: scale(1); opacity: 0.4; }
  100% { transform: scale(1.3); opacity: 1; }
}

/* Avatar blinking effect */
#aiAvatar.blink {
  opacity: 0.3;
  transition: opacity 0.2s;
}

@keyframes mockShake {
  0% { transform: translateX(0); }
  25% { transform: translateX(-5px); }
  50% { transform: translateX(5px); }
  75% { transform: translateX(-5px); }
  100% { transform: translateX(0); }
}

#aiBubble.mocking {
  animation: mockShake 0.6s ease;
}

@keyframes shakeButton {
  0% { transform: translate(0, 0); }
  20% { transform: translate(-3px, 0); }
  40% { transform: translate(3px, 0); }
  60% { transform: translate(-3px, 0); }
  80% { transform: translate(3px, 0); }
  100% { transform: translate(0, 0); }
}

.shaky {
  animation: shakeButton 0.6s infinite;
}

@keyframes pulseGlow {
  0% { box-shadow: 0 0 10px #21cbf3, 0 0 20px #21cbf3; transform: scale(1); }
  50% { box-shadow: 0 0 20px #00ff99, 0 0 30px #00ff99; transform: scale(1.05); }
  100% { box-shadow: 0 0 10px #21cbf3, 0 0 20px #21cbf3; transform: scale(1); }
}

@keyframes colorShift {
  0% { background: linear-gradient(45deg, #2196f3, #21cbf3); }
  50% { background: linear-gradient(45deg, #00e676, #00c853); }
  100% { background: linear-gradient(45deg, #2196f3, #21cbf3); }
}

.power-btn {
  animation: pulseGlow 2s infinite, colorShift 5s infinite;
}

@keyframes countdownColor {
  0% { color: #00c853; }
  50% { color: #ffc107; }
  100% { color: #f44336; }
}

.countdown-animate {
  animation: countdownColor 5s linear forwards;
}

@keyframes scoreBounce {
  0% { transform: scale(0.5); opacity: 0; }
  60% { transform: scale(1.2); opacity: 1; }
  80% { transform: scale(0.9); }
  100% { transform: scale(1); }
}

.bounce-in {
  animation: scoreBounce 1s ease forwards;
}

.golden-btn {
  background: linear-gradient(45deg, #ffd700, #ffb300);
  color: #fff8dc;
  border: none;
  padding: 15px 30px;
  font-size: 1.4rem;
  font-weight: bold;
  border-radius: 16px;
  cursor: pointer;
  box-shadow: 0 0 15px rgba(255, 215, 0, 0.5);
  animation: goldenPulse 2s infinite alternate;
  transition: all 0.3s ease;
}

.golden-btn:hover {
  transform: scale(1.05);
  box-shadow: 0 0 25px rgba(255, 215, 0, 0.8);
}





.score-burst {
  font-size: 4rem;
  font-weight: bold;
  color: #FFD700;
  text-shadow: 0 0 20px #FFEB3B, 0 0 40px orange;
  animation: explode 0.6s ease-out;
  position: relative;
  z-index: 2;
}

@keyframes explode {
  0% { transform: scale(0.2); opacity: 0; }
  60% { transform: scale(1.3); opacity: 1; }
  100% { transform: scale(1); }
}

.sparkle {
  position: absolute;
  width: 10px;
  height: 10px;
  border-radius: 50%;
  background: radial-gradient(circle, #fff, #ff0, #f00);
  animation: sparkle-move 0.7s ease-out forwards;
  opacity: 0.8;
  z-index: 1;
}

@keyframes sparkle-move {
  0% { transform: scale(0.5) translate(0, 0); opacity: 1; }
  100% {
    transform: scale(1.5)
      translate(calc(-50px + 100px * var(--x)),
                calc(-50px + 100px * var(--y)));
    opacity: 0;
  }
}



#finalScoreDisplay.show {
  font-size: 4rem;
  font-weight: 700;
  color: #4b52bb
; /* ÿ£ÿ≤ÿ±ŸÇ ŸÖŸÑŸÉŸä */
  font-family: 'Rubik', sans-serif;

  text-align: center;
  margin-top: 20px;
  text-shadow: 1px 1px 3px rgba(0, 0, 0, 0.6); /* ÿ∏ŸÑ ÿÆŸÅŸäŸÅ ŸÑŸÑÿ™Ÿàÿ∂Ÿäÿ≠ */
  animation: explode-scale 0.5s ease-out;
  opacity: 1;
}





@keyframes explode-scale {
  0% { transform: scale(0.1); opacity: 0; }
  60% { transform: scale(1.3); opacity: 1; }
  100% { transform: scale(1); }
}



.score-particle {
  position: absolute;
  width: 10px;
  height: 10px;
  background: gold;
  border-radius: 50%;
  animation: pop 1.2s ease-out forwards;
  opacity: 0.9;
}

@keyframes pop {
  to {
    transform: translate(var(--x), var(--y)) scale(0);
    opacity: 0;
  }
}







@keyframes goldenPulse {
  0% { box-shadow: 0 0 10px rgba(255, 215, 0, 0.6); }
  100% { box-shadow: 0 0 20px rgba(255, 215, 0, 1); }
}

.welcome-btn {
  font-size: 1.2rem;
  padding: 12px 24px;
  border-radius: 8px;
  border: none;
  background: #2196F3;
  color: white;
  cursor: pointer;
  transition: background 0.3s;
}

.welcome-btn:hover {
  background: #1976D2;
}


.welcome-btn:hover {
  transform: scale(1.05);
  box-shadow: 0 6px 18px rgba(0,0,0,0.2);
}






.welcome-card {
  display: contents; /* üî• ÿßŸÑÿ≥ÿ≠ÿ± ŸáŸÜÿß */
}




    </style>
    <!-- ÿ∂ÿπ Ÿáÿ∞Ÿá ÿßŸÑÿ£ÿ≥ÿ∑ÿ± ŸÇÿ®ŸÑ </head> -->
<meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
<style>
  * {
    -webkit-tap-highlight-color: transparent;
    touch-action: manipulation;
  }
  
  



body {
  margin: 0;
  
  font-family: 'Segoe UI', sans-serif;
  background: #eef6fb;
  height: 100vh;
  overflow: hidden;
  display: block; /* ‚úÖ ŸÖŸáŸÖ ÿ¨ÿØÿßŸã */
}



html, body {
  margin: 0;
  padding: 0;
  height: 100%;
  background: black;
}

body {
  padding-top: env(safe-area-inset-top);
  padding-bottom: env(safe-area-inset-bottom);
  padding-left: env(safe-area-inset-left);
  padding-right: env(safe-area-inset-right);
}


</style>

<!-- ÿ•ÿ∂ÿßŸÅÿ© Ÿáÿ∞Ÿá ÿßŸÑÿ£ÿ≥ÿ∑ÿ± -->
<meta http-equiv="X-UA-Compatible" content="IE=edge">
<meta name="mobile-web-app-capable" content="yes">
<meta name="apple-mobile-web-app-capable" content="yes">
<script>
window.addEventListener("DOMContentLoaded", async () => {

  // ‚úÖ ÿ™ŸÅÿπŸäŸÑ ÿßŸÑÿµŸàÿ™ ŸÖŸÜ ÿ£ŸàŸÑ ŸÑŸÖÿ≥ÿ©
 ["touchstart", "click", "pointerdown"].forEach(evt => {
  document.body.addEventListener(evt, () => {
    try {
      if (SoundManager?.context?.state === "suspended") {
        SoundManager.context.resume().then(() => {
          console.log(`üîä AudioContext resumed by ${evt}`);

          // üß† ÿ™ÿ≥ÿÆŸäŸÜ ÿµŸàÿ™ buttonClick ŸÑÿ™ŸÅÿßÿØŸä ÿßŸÑŸÑÿßÿ¨
          const source = SoundManager.context.createBufferSource();
          source.buffer = SoundManager.buffers["buttonClick"];
          source.connect(SoundManager.context.destination);
          source.start(0);
          source.stop(SoundManager.context.currentTime + 0.05);
        });
      }
    } catch (err) {
      console.warn("‚ö†Ô∏è resume ÿ£Ÿà ÿßŸÑÿ™ÿ≥ÿÆŸäŸÜ ŸÅÿ¥ŸÑ:", err);
    }
  }, { once: true });
});


  // ‚úÖ ÿ™ÿ≠ŸÖŸäŸÑ ŸÅÿπŸÑŸä ŸàÿßŸÜÿ™ÿ∏ÿßÿ±
  const splash = document.getElementById("splashScreen");

  const MIN_DISPLAY = 2200;
  const MAX_WAIT = 7000;

  const waitMinTime = new Promise(res => setTimeout(res, MIN_DISPLAY));
  const preload = preloadEverything();


  const maxWait = new Promise(res => setTimeout(res, MAX_WAIT));

  await Promise.race([
    Promise.all([preload, waitMinTime]),
    maxWait
  ]);

  splash.classList.add("fade-out");
  setTimeout(() => {
    splash.style.display = "none";
    goToNextScreen();
   const firstVisitDone = localStorage.getItem("firstVisitDone");
if (firstVisitDone === "true") {
  setTimeout(() => {
    showAIReaction('lateOpen');
  }, 1000);
}


  }, 700);

});

async function preloadEverything() {
  await SoundManager.loadSounds();

 const imagePaths = [
  "assets/ai_default.png",
  "assets/ai_happy.png",
  "assets/ai_angry.png",
  "assets/ai_thinking.png",
  "assets/ai_worried.png",
  "assets/ai_smile.png",
  "assets/ai_shocked.png",
  "assets/ai_embarrassed.png",
  "assets/ai_jokey.png",
 ];


  const soundPaths = [
    "assets/sounds/button-click.mp3",
    "assets/sounds/shape-pick.mp3",
    "assets/sounds/singleClear.mp3",
    "assets/sounds/combo-clear.mp3",
    "assets/sounds/bubble-appear.mp3"
  ];

  await Promise.all(
    imagePaths.map((src) => {
      return new Promise((resolve) => {
        const img = new Image();
        img.onload = resolve;
        img.onerror = resolve;
        img.src = src;
      });
    })
  );

  await Promise.all(
    soundPaths.map((src) => {
      return new Promise((resolve) => {
        const audio = new Audio();
        audio.onloadeddata = resolve;
        audio.onerror = resolve;
        audio.src = src;
      });
    })
  );

  // ‚úÖ ÿ™ÿ≠ŸÖŸäŸÑ ŸÖŸÑŸÅ ÿßŸÑÿ¨ŸÖŸÑ ÿßŸÑÿ™ŸÅÿßÿπŸÑŸäÿ© ÿ≠ÿ≥ÿ® ÿßŸÑŸÑÿ∫ÿ© + ÿßŸÑŸÜŸàÿπ
  await new Promise((resolve) => {
  loadAllAIResponses(resolve); // ‚¨ÖÔ∏è ÿßÿ≥ÿ™ÿÆÿØÿßŸÖ ÿØÿßŸÑÿ© ÿßŸÑÿ™ÿ≠ŸÖŸäŸÑ ÿßŸÑÿ∞ŸÉŸäÿ©
});


  await new Promise((resolve) => {
    const script = document.createElement("script");
   const savedData = JSON.parse(localStorage.getItem("blockPlayerData") || "{}");
const lang = savedData.language || "ar";
const gender = savedData.gender || "male";
const playerType = `${lang}_${gender}`;

script.src = `ai_responses/aiResponses_${playerType}.js`;



    script.onload = () => {
  console.log("‚úÖ ÿ™ŸÖ ÿ™ÿ≠ŸÖŸäŸÑ ŸÖŸÑŸÅ ÿßŸÑÿ¨ŸÖŸÑ:", script.src);
  
  // ‚úÖ ÿØŸÖÿ¨ ÿßŸÑÿ¨ŸÖŸÑ ŸäÿØŸàŸäŸãÿß ŸÖŸÜ tempAIResponses
  if (window.tempAIResponses) {
    window.allAIResponses = window.allAIResponses || {};
    window.allAIResponses[playerType] = window.tempAIResponses;
    console.log("üì• ÿ™ŸÖ ŸÜŸÇŸÑ ÿßŸÑÿ¨ŸÖŸÑ ÿ•ŸÑŸâ allAIResponses:", playerType);
  } else {
    console.warn("‚ö†Ô∏è tempAIResponses ŸÖÿ¥ ŸÖŸàÿ¨ŸàÿØ ÿØÿßÿÆŸÑ ÿßŸÑŸÖŸÑŸÅ:", script.src);
  }

  if (typeof reloadAIResponses === "function") reloadAIResponses();
  resolve();
};

    script.onerror = () => {
      console.error("‚ùå ŸÅÿ¥ŸÑ ÿ™ÿ≠ŸÖŸäŸÑ ŸÖŸÑŸÅ ÿßŸÑÿ¨ŸÖŸÑ:", script.src);
      resolve();
    };
    document.head.appendChild(script);
  });

  await new Promise((res) => setTimeout(res, 300));
}


// ÿØÿßŸÑÿ© ŸÑÿ™ÿ≠ÿØŸäÿØ ÿßŸÑŸàÿ¨Ÿáÿ© ÿ®ÿπÿØ ÿßŸÑÿ™ÿ≠ŸÖŸäŸÑ
function goToNextScreen() {
  const data = localStorage.getItem("blockPlayerData");

  if (!data) {
    // ŸÑŸà ÿ£ŸàŸÑ ŸÖÿ±ÿ©ÿå Ÿäÿ∏Ÿáÿ± ÿ¥ÿßÿ¥ÿ© ÿßÿÆÿ™Ÿäÿßÿ± ÿßŸÑŸÑÿ∫ÿ© ŸàÿßŸÑÿ¨ŸÜÿ≥
    const welcome = document.getElementById("welcomeScreen");
welcome.classList.remove("hidden");
welcome.style.display = "flex";

  } else {
    // ŸäŸÅÿ™ÿ≠ ÿßŸÑŸÇÿßÿ¶ŸÖÿ© ÿßŸÑÿ±ÿ¶Ÿäÿ≥Ÿäÿ© ŸÅŸÇÿ∑ÿå ÿ®ÿØŸàŸÜ ÿ®ÿØÿ° ÿßŸÑŸÑÿπÿ®ÿ©
    const menu = document.getElementById("mainMenu");
if (menu) {
  menu.style.display = "block";
} else {
  console.warn("‚ö†Ô∏è ÿπŸÜÿµÿ± mainMenu ŸÖÿ¥ ŸÖŸàÿ¨ŸàÿØ ŸÅŸä ÿßŸÑÿµŸÅÿ≠ÿ©!");
}


   
  }
}




  // ÿ≠ŸÑ ŸÜŸáÿßÿ¶Ÿä ŸÑÿ™ÿ≠ÿ≥ŸäŸÜ ÿßŸÑÿ£ÿØÿßÿ°
if ('connection' in navigator) {
  if (navigator.connection.saveData || navigator.connection.effectiveType.includes('2g')) {
    document.body.classList.add('low-performance');
  }
}


/*** ÿßÿ®ÿØÿ£ ÿ•ÿ∂ÿßŸÅÿ© Ÿáÿ∞ÿß ÿßŸÑŸÉŸàÿØ ***/
// ÿ™ÿ≠ÿ≥ŸäŸÜ ÿ™ÿ≠ŸÖŸäŸÑ ÿßŸÑÿµŸàÿ± (ÿ•ÿ∞ÿß Ÿàÿ¨ÿØÿ™)
const images = document.querySelectorAll('img');
if (images.length > 0) {
  images.forEach(img => {
    img.loading = 'eager';
    img.decoding = 'async';
  });
}
/*** ÿßŸÜÿ™ŸáŸâ ÿßŸÑŸÉŸàÿØ ÿßŸÑŸÖÿ∂ÿßŸÅ ***/

// ÿ®ÿπÿØ ÿ™ÿ≠ŸÖŸäŸÑ ÿßŸÑÿπŸÜÿßÿµÿ±

const Pan = new Hammer.Pan({ threshold: 5 });







 
  

document.addEventListener("visibilitychange", function () {
  if (document.hidden) {
    console.log("‚è∏Ô∏è ÿ™ŸÖ ÿßŸÑÿÆÿ±Ÿàÿ¨ ŸÖŸÜ ÿßŸÑŸÑÿπÿ®ÿ© ÿ£Ÿà ÿ•ÿ∑ŸÅÿßÿ° ÿßŸÑÿ¥ÿßÿ¥ÿ©");

    // ‚õî ÿ£ŸàŸÇŸÅ ÿßŸÑÿ£ÿ≠ÿØÿßÿ´ ÿßŸÑÿ™ŸÅÿßÿπŸÑŸäÿ©
    isGameRunning = false;

    // ‚õî ÿ£ŸÅÿ±ÿ∫ ÿ∑ÿßÿ®Ÿàÿ± ÿßŸÑÿ¨ŸÖŸÑ
    messageQueue = [];
    isShowingMessage = false;

    // ‚õî ÿ£ÿÆŸÅŸä ÿπŸÜÿßÿµÿ± ÿßŸÑÿßŸÅÿ™ÿßÿ±
    document.getElementById("aiBubble")?.classList.add("hidden");
    document.getElementById("aiBoard")?.classList.add("hidden");
    document.getElementById("aiText")?.classList.remove("show");

    // ‚õî ÿ£ŸàŸÇŸÅ ÿßŸÑÿµŸàÿ™
    if (SoundManager?.context?.state === "running") {
      SoundManager.context.suspend().then(() => {
        console.log("üîá ÿ™ŸÖ ÿ•ŸäŸÇÿßŸÅ ÿßŸÑÿµŸàÿ™ ŸÖÿ§ŸÇÿ™Ÿãÿß");
      });
    }
  } else {
    console.log("‚ñ∂Ô∏è ÿ™ŸÖ ÿßŸÑÿ±ÿ¨Ÿàÿπ ŸÑŸÑÿπÿ®ÿ©");

    // ‚úÖ ÿßÿ≥ÿ™ÿ¶ŸÜÿßŸÅ ÿßŸÑÿµŸàÿ™ ÿπŸÜÿØ ÿßŸÑÿ±ÿ¨Ÿàÿπ
    if (SoundManager?.context?.state === "suspended") {
      SoundManager.context.resume().then(() => {
        console.log("üîä ÿ™ŸÖ ÿßÿ≥ÿ™ÿ¶ŸÜÿßŸÅ ÿßŸÑÿµŸàÿ™");
      });
    }

    // ‚úÖ ÿ£ÿπÿØ ÿ™ŸÅÿπŸäŸÑ ÿßŸÑŸÑÿπÿ® ŸÅŸÇÿ∑ ŸÑŸà ŸÉÿßŸÜÿ™ ÿßŸÑÿ¥ÿßÿ¥ÿ© ŸáŸä ÿ¥ÿßÿ¥ÿ© ÿßŸÑÿ¨ŸäŸÖ
    const gameScreen = document.getElementById("game");
    if (gameScreen.classList.contains("active")) {
      isGameRunning = true;
    }
  }
});




</script>




<script>
  // ÿ™ÿ≠ŸÖŸäŸÑ ÿßŸÑÿπŸÜÿßÿµÿ± ÿßŸÑÿ≠ÿ±ÿ¨ÿ© ÿ£ŸàŸÑÿßŸã (ŸäŸÇŸÑŸÑ ÿßŸÑÿ™ŸàŸÇŸÅ)
  document.addEventListener('DOMContentLoaded', () => {
   

    const criticalAssets = [
      'assets/ai_default.png',
      'assets/sounds/button-click.mp3'
    ];
    
    criticalAssets.forEach(asset => {
      const link = document.createElement('link');
      link.rel = 'preload';
      link.as = asset.includes('.mp3') ? 'audio' : 'image';
      link.href = asset;
      document.head.appendChild(link);
    });
  });
  </script>



</head>
<body>
   <div id="splashScreen" class="splash-screen">
    <img src="assets/nova_logo.png" alt="NovaCode Studio Logo" class="studio-logo">
   
  </div><div class="welcome-screen" id="welcomeScreen">
  <div class="welcome-card enhanced-welcome">
    <h2 class="welcome-title" id="welcomeText" style="display: none;"></h2>

    <div id="langButtons" class="btn-group">
      <button onclick="chooseLanguage('ar')" class="hero-btn">üá∏üá¶ ÿπÿ±ÿ®Ÿä</button>
      <button onclick="chooseLanguage('en')" class="hero-btn">üá∫üá∏ English</button>
    </div>

    <div id="step2" class="step" style="display: none;">
      <p id="genderText">üë§ ÿ•ŸÜÿ™ ŸàŸÑÿØ ŸàŸÑÿß ÿ®ŸÜÿ™ÿü</p>
      <div class="btn-group">
        <button onclick="chooseGender('male')" class="hero-btn">üöπ ŸàŸÑÿØ</button>
        <button onclick="chooseGender('female')" class="hero-btn">üö∫ ÿ®ŸÜÿ™</button>
      </div>
    </div>

    <div id="finalStep" style="display:none;"></div>
  </div>
</div>
!-- ŸÜŸáÿßŸäÿ© welcomeScreen -->

<!-- ŸáŸÜÿß ÿ™ÿ≠ÿ∑ ÿ¥ÿßÿ¥ÿ© avatarIntroScreen ÿßŸÑÿ¨ÿØŸäÿØÿ© -->
<div class="welcome-screen hidden" id="avatarIntroScreen">
  <div id="avatarWrapper" style="display:flex;flex-direction:column;align-items:center;justify-content:center;height:100%;gap:20px;">
    
    <div id="introAiBubble" class="ai-bubble show" style="width:120px;height:120px;">
      <div class="bubble-inner" style="width:100%;height:100%;">
        <img id="introAiAvatar" src="assets/ai_default.png" alt="AI" style="width:90px;height:90px;"/>
        <div class="ai-dots">
          <span></span><span></span><span></span>
        </div>
      </div>
    </div>
    
    <div id="introAiBoard" class="show" style="
  background: white;
  padding: 20px;
  border-radius: 20px;
  box-shadow: 0 4px 12px rgba(0,0,0,0.1);
  width: 90%;
  max-width: 400px;
  height: 180px;
  display: flex;
  align-items: center;
  justify-content: center;
  overflow: hidden;">

      <div id="introAiText" style="font-size:1.3rem;color:#2196F3;line-height:1.5;text-align:center;word-wrap:break-word;"></div>
    </div>

  </div>
</div>



  <!-- Screens -->
  <div class="screen active" id="mainMenu">

    <div class="menu-content">
      <h1 class="game-title">Block Puzzle AI</h1>
      <button class="btn start-btn" onclick="startGame()">ÿßÿ®ÿØÿ£ ÿ±ÿ≠ŸÑÿ™Ÿä</button>
      <button class="btn stats-btn" onclick="showPlayerStats()">üìà ÿ®ŸäÿßŸÜÿßÿ™Ÿä</button>
   

      <p class="copyright">By: NovaCode Studio ¬© 2025</p>
  
      <div id="adBanner" style="width:100%; height:50px; background:#e6e6e6; display:flex; align-items:center; justify-content:center; font-size:14px; color:#333; margin-top: 20px;">
        ÿ•ÿπŸÑÿßŸÜ ÿ™ÿ¨ÿ±Ÿäÿ®Ÿä ŸáŸÜÿß (Banner)
      </div>
    </div>
  </div>
  
  <div class="screen" id="game">
    <button id="backToMenuBtn" onclick="backToMenu()" class="back-home-btn">
      <svg viewBox="0 0 24 24" width="24" height="24">
        <path d="M19 12H5M12 19l-7-7 7-7" stroke="#2196F3" stroke-width="2"/>
      </svg>
    </button>
    
    <div id="scoreboard">Score: 0</div>
    
    <!-- AI Interactive Area -->
    <div id="aiContainer">
      <div id="aiInteractiveArea">
        <div id="aiBubble" class="ai-bubble hidden">
          <div class="bubble-inner">
            <img id="aiAvatar" src="assets/ai_default.png" alt="AI" />
            <div class="ai-dots">
              <span></span><span></span><span></span>
            </div>
          </div>
        </div>
        
        <div id="aiBoard" class="hidden">
          <div id="aiText"></div>
          
        </div>
      </div>
    </div>
    
    <div id="grid"></div>
    <div id="shapes"></div>
  </div>
<div id="resumeCountdownBarContainer"><div id="resumeCountdownBar"></div></div>

<p id="countdown"></p>


  <div class="screen" id="gameover">
    <h1>Game Over</h1>
    <div id="finalScoreDisplay"></div>
    
    <button class="golden-btn" id="resumeBtn" onclick="resumeGame()">‚ú® ÿßÿ≥ÿ™ŸÉŸÖŸÑ ÿßŸÑŸÑÿπÿ®</button>
    <button class="btn" id="restartBtn" style="display:none;" onclick="restartGame()">ÿßÿ®ÿØÿ£ ŸÖŸÜ ÿ¨ÿØŸäÿØ</button>
    <button class="btn golden-btn" id="insightBtn" onclick="showInsightReport()" style="margin-top: 10px; font-size: 1.1rem;">üìò ÿßŸÑÿ™ŸÇÿ±Ÿäÿ± ÿßŸÑŸÜŸÅÿ≥Ÿä</button>

<p id="countdown" class="countdown-animate" style="display:none;"></p>

<div id="countdownBarContainer">
  <div id="countdownBar"></div>
</div>



   
    <div id="countdownBarContainer">
  <div id="countdownBar"></div>
</div>

  </div>
  
  

  <div id="playerStats" class="welcome-screen" style="display:none;">
  <div class="welcome-card" id="playerStatsCard">
    <h2 id="statsText" class="stats-title">üìà ÿ®ŸäÿßŸÜÿßÿ™ŸÉ</h2>
    <div id="statsContent" class="stats-content"></div>
    <button class="welcome-btn" id="backBtn" onclick="closeStats()">üîô ÿ±ÿ¨Ÿàÿπ</button>
  </div>
</div>

  

  <div class="welcome-screen hidden fade-in" id="insightScreen">
    <div id="insightWrapper" style="display:flex;flex-direction:column;align-items:center;justify-content:center;height:100%;gap:20px;">
      <div id="insightAiBubble" class="ai-bubble show" style="width:120px;height:120px;">
        <div class="bubble-inner" style="width:100%;height:100%;">
          <img id="insightAiAvatar" src="assets/ai_default.png" alt="AI" style="width:90px;height:90px;"/>
          <div class="ai-dots"><span></span><span></span><span></span></div>
        </div>
      </div>
      <div id="insightAiBoard" class="show" style="
  background: white;
  padding: 20px;
  border-radius: 20px;
  box-shadow: 0 4px 12px rgba(0,0,0,0.1);
  width: 90%;
  max-width: 400px;
  max-height: 70vh;
  min-height: 200px;
  display: flex;
  flex-direction: column;
  align-items: center;
  justify-content: flex-start;
  overflow-y: auto;
  gap: 10px;">

        <div id="insightAiText" style="font-size:1.2rem;color:#2196F3;line-height:1.5;text-align:center;"></div>
      </div>
      <button id="shareInsightBtn" class="welcome-btn hidden" onclick="shareInsight()">üîó ÿ¥ÿßÿ±ŸÉ ÿßŸÑÿ™ÿ≠ŸÑŸäŸÑ ŸÖÿπ ÿµÿ≠ÿßÿ®ŸÉ</button>
      <button onclick="closeInsight()" class="welcome-btn hidden" id="closeInsightBtn">üèÅ ŸÉŸÅÿßŸäÿ© ÿ™ÿ≠ŸÑŸäŸÑ.. ŸÜÿ±ÿ¨ÿπÿü</button>
    </div>
  </div>

  

  <div id="aiFlash"></div>
  <script>

function reloadAIResponses() {
  try {
    const savedData = JSON.parse(localStorage.getItem("blockPlayerData")) || {};
    const lang = savedData.language || "ar";
    const gender = savedData.gender || "male";
    const playerType = `${lang}_${gender}`;

    console.log("üîÅ ÿ•ÿπÿßÿØÿ© ÿ™ÿ≠ŸÖŸäŸÑ ÿßŸÑÿ¨ŸÖŸÑ ŸÑŸÄ:", playerType);

    if (!window.allAIResponses) {
      console.error("‚ùå allAIResponses ÿ∫Ÿäÿ± ŸÖŸàÿ¨ŸàÿØ");
      window.aiReady = false;
      return;
    }

    if (window.allAIResponses[playerType]) {
      window.aiResponses = window.allAIResponses[playerType];
      window.aiReady = true;
      console.log("‚úÖ ÿ™ŸÖ ÿ™ÿ≠ŸÖŸäŸÑ", Object.keys(aiResponses).length, "ÿ¨ŸÖŸÑ ÿ™ŸÅÿßÿπŸÑŸäÿ©");
    } else {
      console.error("‚ùå ŸÑÿß ŸäŸàÿ¨ÿØ ÿ±ÿØŸàÿØ ŸÑŸÑŸÜŸàÿπ:", playerType);
      window.aiReady = false;
    }
  } catch (error) {
    console.error("‚ùå ÿÆÿ∑ÿ£ ŸÅŸä reloadAIResponses:", error);
    window.aiReady = false;
  }
}





function getRandomAIResponse(eventType) {
  if (typeof aiResponses === "undefined" || !aiResponses[eventType]) {
    console.warn(`‚ö†Ô∏è aiResponses ÿ∫Ÿäÿ± ŸÖÿπÿ±ŸÅ ÿ£Ÿà ŸÖŸÅŸäÿ¥ ÿ¨ŸÖŸÑ ŸÑŸÑÿ≠ÿØÿ´: ${eventType}`);
    return "";
  }

  const responses = aiResponses[eventType];
  const index = Math.floor(Math.random() * responses.length);
  return responses[index];
}





function checkNearLose() {
  const filled = gridCells.filter(cell => cell.classList.contains("filled")).length;
  const ratio = filled / gridCells.length;

  const now = Date.now();
  const oneMinute = 10 * 1000;


  if (ratio >= 0.60 && (now - lastNearLoseTime >= oneMinute)) {
    showAIReaction("nearLose");
    lastNearLoseTime = now;
  }
}





function setupButtonSounds() {
  // ÿ±ÿ®ÿ∑ ÿßŸÑÿµŸàÿ™ ÿ®ÿ¨ŸÖŸäÿπ ÿßŸÑÿ£ÿ≤ÿ±ÿßÿ± ŸÅŸä ÿßŸÑÿµŸÅÿ≠ÿ©
  document.querySelectorAll('button').forEach(button => {
    button.addEventListener('click', () => {
      SoundManager.play('buttonClick');
    });
  });
  
  // ÿ±ÿ®ÿ∑ ÿßŸÑÿµŸàÿ™ ÿ®ÿßŸÑÿπŸÜÿßÿµÿ± ÿßŸÑÿ£ÿÆÿ±Ÿâ ÿßŸÑÿ™Ÿä ÿ™ÿ™ÿµÿ±ŸÅ ŸÖÿ´ŸÑ ÿßŸÑÿ£ÿ≤ÿ±ÿßÿ±
  document.querySelectorAll('[onclick]').forEach(el => {
    if (el.tagName !== 'BUTTON') {
      el.addEventListener('click', () => {
        SoundManager.play('buttonClick');
      });
    }
  });
}



// üîä ÿ±ÿ®ÿ∑ ÿ¨ŸÖŸäÿπ ÿßŸÑÿ£ÿ≤ÿ±ÿßÿ± ÿ®ÿ™ÿ¥ÿ∫ŸäŸÑ ÿßŸÑÿµŸàÿ™
document.addEventListener('click', function(event) {
  const el = event.target.closest('button, .btn, [role="button"], [onclick]');
  if (el && !el.classList.contains('no-sound')) {
    SoundManager.play('buttonClick');
  }
});


    </script>
    

    <!-- AI Reaction Elements -->




  <script>

    // ÿØÿßŸÑÿ© ÿ∞ŸÉŸäÿ© ÿ™ÿ™ÿπŸÇÿ® ÿ¨ŸÖŸäÿπ ÿßŸÑŸÜŸÇÿ±ÿßÿ™ ŸÅŸä ÿßŸÑÿµŸÅÿ≠ÿ©

    // ÿßŸÑŸÉŸàÿØ ÿßŸÑÿ£ÿ≥ÿßÿ≥Ÿä ŸÑŸÑÿπÿ®ÿ© Ÿäÿ®ŸÇŸâ ŸÉŸÖÿß ŸáŸà ÿ®ÿØŸàŸÜ ÿ™ÿ∫ŸäŸäÿ±
    // ŸÅŸÇÿ∑ Ÿäÿ™ŸÖ ÿ™ÿπÿØŸäŸÑ ÿØÿßŸÑÿ© showAIReaction ŸÑÿ™ÿ™ŸÜÿßÿ≥ÿ® ŸÖÿπ ÿßŸÑÿ™ÿµŸÖŸäŸÖ ÿßŸÑÿ¨ÿØŸäÿØ
let isGameRunning = false;
let isTouchActive = false;
let lastLineClearTime = 0;
let shapesSinceLastClear = 0;
let failedShapePlacements = 0;
let uselessShapesInARow = 0;
let countingUselessShapes = false; // ‚Üê ŸÜÿ®ÿØÿ£ ÿßŸÑÿπÿØ ÿ®ÿπÿØ ÿ£ŸàŸÑ ŸÜÿ¨ÿßÿ≠
let lastNearLoseTime = 0;
let smallClearsInARow = 0;
let lastSecretTime = 0;
let lastJokeyTime = 0;
let lastAIReactionTime = 0; // ‚Üê ÿ®Ÿäÿ™ÿ≠ÿØÿ´ ŸÉŸÑ ŸÖÿß AI Ÿäÿ™ŸÉŸÑŸÖ
let lastAIEventType = null;
let messageQueue = [];
let isShowingMessage = false;

const eventPriority = {
  nearLose: 5,
  angry: 4,
  embarrassed: 3,
  combo: 3,
  lineClear: 2,
  jokey: 1,
  idle: 0,
  secret: 1
};

function showAIReaction(eventType) {
    const aiEnabled = localStorage.getItem("aiModeEnabled") !== "false";
  if (!aiEnabled) return;

  if (!isGameRunning && eventType !== "combo") return;


  if (eventType === 'lateOpen') {
    showSingleAIReaction(eventType);
    return;
  }

  // ‚úÖ ŸÑÿß ŸÜÿ≥ŸÖÿ≠ ÿ®ÿ™ŸÉÿ±ÿßÿ± ŸÜŸÅÿ≥ ÿßŸÑÿ≠ÿØÿ´ ÿ•ŸÑÿß ÿ•ÿ∞ÿß ÿßŸÑÿ∑ÿßÿ®Ÿàÿ± ŸÅÿßÿ∂Ÿä
  const alreadyShown = (eventType === lastAIEventType);
  const queueFull = isShowingMessage || messageQueue.length > 0;

  if (alreadyShown && queueFull) {
    console.log("üö´ ÿ™ŸÖ ÿ™ÿ¨ÿßŸáŸÑ ÿ™ŸÉÿ±ÿßÿ± ÿßŸÑÿ≠ÿØÿ´ ŸÅŸä ÿßŸÑÿ≤ÿ≠ŸÖÿ©:", eventType);
    return;
  }

  if (isShowingMessage) {
    if (messageQueue.length === 0) {
      messageQueue.push(eventType);
    } else {
      const current = messageQueue[0];
      if (eventPriority[eventType] > eventPriority[current]) {
        messageQueue[0] = eventType;
      }
    }
    return;
  }

  showSingleAIReaction(eventType);
}

function processMessageQueue() {
  if (messageQueue.length === 0) {
    isShowingMessage = false;
    return;
  }

  const next = messageQueue.shift();
  showSingleAIReaction(next);
}

function showSingleAIReaction(eventType) {
  isShowingMessage = true;
  lastAIReactionTime = Date.now();

  const aiBubble = document.getElementById("aiBubble");
  const aiBoard = document.getElementById("aiBoard");
  const aiText = document.getElementById("aiText");
  const aiAvatar = document.getElementById("aiAvatar");
  const heatBar = document.getElementById("aiHeatBar");

  // ‚úÖ ÿ™ÿ∫ŸäŸäÿ± ÿßŸÑÿµŸàÿ±ÿ© ÿ≠ÿ≥ÿ® ÿßŸÑÿ≠ÿØÿ´
  const avatarMap = {
    idle: "ai_thinking.png",
    combo: "ai_happy.png",
    lineClear: "ai_smile.png",
    nearLose: "ai_worried.png",
    angry: "ai_angry.png",
    shocked: "ai_shocked.png",
    embarrassed: "ai_embarrassed.png",
    default: "ai_default.png"
  };

  aiAvatar.src = `assets/${avatarMap[eventType] || avatarMap.default}`;

  // ‚úÖ ÿ™ÿ¥ÿ∫ŸäŸÑ ÿµŸàÿ™ ÿßŸÑŸÅŸÇÿßÿπÿ©
const message = getRandomAIResponse(eventType);
if (!message) {
  isShowingMessage = false;
  return;
}

if (isGameRunning) {
  SoundManager.play("bubbleAppear");
}



  // ‚úÖ ÿπÿ±ÿ∂ ÿßŸÑÿπŸÜÿßÿµÿ± ÿ®ÿµÿ±ŸäŸãÿß
  aiBubble.classList.remove("hidden");
  aiBubble.classList.add("show");

  aiBoard.classList.remove("hidden");
  aiBoard.classList.add("show");

  aiText.textContent = message;
  aiText.classList.add("show");

  

  // ŸÖÿØÿ© ÿπÿ±ÿ∂ ÿßŸÑÿ¨ŸÖŸÑÿ© ŸàÿßŸÑÿ™ÿ£ÿ´Ÿäÿ±ÿßÿ™
  const DISPLAY_TIME = 3500 + Math.floor(Math.random() * 1500); // ŸÖŸÜ 3.5 ÿ•ŸÑŸâ 5 ÿ´ŸàÿßŸÜŸä


  setTimeout(() => {
    aiBubble.classList.remove("show");
    aiBubble.classList.add("hide");

    aiBoard.classList.remove("show");
    aiBoard.classList.add("hide");

    aiText.classList.remove("show");
    

    setTimeout(() => {
      aiBubble.classList.remove("hide");
      aiBubble.classList.add("hidden");

      aiBoard.classList.remove("hide");
      aiBoard.classList.add("hidden");

      isShowingMessage = false;
      processMessageQueue();
    }, 500); // ‚Üê ÿ™ÿ∑ÿßÿ®ŸÇ ŸÖÿπ ÿ™ÿ£ÿ´Ÿäÿ± ÿßŸÑÿÆÿ±Ÿàÿ¨
  }, DISPLAY_TIME);
  lastAIEventType = eventType;

}




    // ÿ®ÿßŸÇŸä ŸÉŸàÿØ ÿßŸÑŸÑÿπÿ®ÿ© Ÿäÿ®ŸÇŸâ ŸÉŸÖÿß ŸáŸà ÿ®ÿØŸàŸÜ ÿ™ÿ∫ŸäŸäÿ±
  

    const gameTranslations = {
      ar: {
        startBtn: "ÿßÿ®ÿØÿ£ ÿ±ÿ≠ŸÑÿ™Ÿä",
        statsBtn: "üìà ÿ®ŸäÿßŸÜÿßÿ™Ÿä",
        scoreText: "ÿßŸÑŸÜŸÇÿßÿ∑: ",
        gameOver: "ÿßŸÜÿ™Ÿáÿ™ ÿßŸÑŸÑÿπÿ®ÿ©",
        resumeBtn: "ÿßÿ≥ÿ™ŸÉŸÖŸÑ ÿßŸÑŸÑÿπÿ® (ÿ•ÿπŸÑÿßŸÜ)",
        restartBtn: "ŸÑÿπÿ®ÿ© ÿ¨ÿØŸäÿØÿ©",
        countdownText: "ÿ£Ÿà ÿßŸÜÿ™ÿ∏ÿ± 5 ÿ´ŸàÿßŸÜŸä...",
        aiThinking: "ü§ñ ŸäŸÅŸÉÿ±...",
        statsTitle: "ÿ®ŸäÿßŸÜÿßÿ™ ÿßŸÑŸÑÿßÿπÿ®",
        backBtn: "üîô ÿ±ÿ¨Ÿàÿπ",
        levelMessage: "ŸÖÿ≥ÿ™ŸàÿßŸÉ: ÿπÿßŸÑŸÖŸä"
      },
      en: {
        startBtn: "Start My Journey",
        statsBtn: "üìà My Stats",
        scoreText: "Score: ",
        gameOver: "Game Over",
        resumeBtn: "Resume Game (Ad)",
        restartBtn: "Start New Game",
        countdownText: "Or wait 5 seconds...",
        aiThinking: "ü§ñ Thinking...",
        statsTitle: "Player Stats",
        backBtn: "üîô Back",
        levelMessage: "Your Level: Pro"
      }
    };

    let gridCells = [], shapesInHand = [], shapesUsed = 0, score = 0;
    let difficultyLevel = 1;
    let floatingStartX = 0, floatingStartY = 0, pointerStartX = 0, pointerStartY = 0;
    let aiInternalNotes = [];
let isSoundOn = true; // ‚Üê Ÿáÿ∞ÿß ÿßŸÑÿ≥ÿ∑ÿ± ŸáŸÜÿß
    let aiMemory = {
      context: [],
      mood: "neutral",
      lastEvent: null,
      intensity: 0
    };

    let playerBehavior = {
  fastMoves: 0,
  slowMoves: 0,
  perfectClears: 0,
  nearFails: 0,
  lastMoveTime: null,
  avgSpeed: 0,
  totalMoves: 0,
  failedAttempts: 0,
  lastShapeCode: null,
  repeatedShapeCount: 0
};



let lastActivityTime = Date.now(); // ‚è±Ô∏è ŸÑÿ™ÿ™ÿ®ÿπ ÿ¢ÿÆÿ± ŸÜÿ¥ÿßÿ∑ ŸÑŸÑŸëÿßÿπÿ®

    let currentShape = null, sourceElement = null, floating = null;
    let offset = { x: 0, y: 0 }, resumed = false, monitorInterval = null;
let animationFrameId = null;

    const grid = document.getElementById("grid");
    const shapesDiv = document.getElementById("shapes");
    const scoreboard = document.getElementById("scoreboard");
    const finalScoreDisplay = document.getElementById("finalScoreDisplay");
    const resumeBtn = document.getElementById("resumeBtn");
    const restartBtn = document.getElementById("restartBtn");
    const countdownEl = document.getElementById("countdown");
/*** ÿßÿ®ÿØÿ£ ÿ•ÿ∂ÿßŸÅÿ© Ÿáÿ∞ÿß ÿßŸÑŸÉŸàÿØ ***/
const canvas = document.querySelector('canvas');
if (canvas) {
  canvas.style.imageRendering = 'pixelated';
  canvas.style.transform = 'translateZ(0)';
}
/*** ÿßŸÜÿ™ŸáŸâ ÿßŸÑŸÉŸàÿØ ÿßŸÑŸÖÿ∂ÿßŸÅ ***/
  const screens = {
  menu: document.getElementById("mainMenu"),
  game: document.getElementById("game"),
  gameover: document.getElementById("gameover")
};


    const weightedShapes = [
  { shape: [[0,0]], weight: 1 }, // ŸÜŸÇÿ∑ÿ© Ÿàÿßÿ≠ÿØÿ©
  { shape: [[0,0],[1,0]], weight: 1 }, // ÿÆÿ∑ ÿ±ÿ£ÿ≥Ÿä ŸÖŸÉŸàŸÜ ŸÖŸÜ ŸÜŸÇÿ∑ÿ™ŸäŸÜ
  { shape: [[0,0],[0,1]], weight: 1 }, // ÿÆÿ∑ ÿ£ŸÅŸÇŸä ŸÖŸÉŸàŸÜ ŸÖŸÜ ŸÜŸÇÿ∑ÿ™ŸäŸÜ
  { shape: [[0,0],[1,0],[0,1]], weight: 1 }, // ÿ¥ŸÉŸÑ L ÿµÿ∫Ÿäÿ±
  { shape: [[0,0],[1,0],[2,0]], weight: 4 }, // ÿÆÿ∑ ÿ±ÿ£ÿ≥Ÿä ŸÖŸÉŸàŸÜ ŸÖŸÜ 3 ŸÜŸÇÿßÿ∑
  { shape: [[0,0],[0,1],[0,2]], weight: 4 }, // ÿÆÿ∑ ÿ£ŸÅŸÇŸä ŸÖŸÉŸàŸÜ ŸÖŸÜ 3 ŸÜŸÇÿßÿ∑
  { shape: [[0,0],[1,0],[1,1]], weight: 2 }, // ÿ¥ŸÉŸÑ ÿ≤ÿßŸàŸäÿ© ŸäŸÖŸäŸÜ ÿ™ÿ≠ÿ™
  { shape: [[0,0],[0,1],[1,1]], weight: 2 }, // ÿ¥ŸÉŸÑ ÿ≤ÿßŸàŸäÿ© Ÿäÿ≥ÿßÿ± ÿ™ÿ≠ÿ™
  { shape: [[0,0],[1,0],[2,0],[0,1],[1,1],[2,1]], weight: 7 }, // ŸÖÿ≥ÿ™ÿ∑ŸäŸÑ 2x3
  { shape: [[0,0],[1,0],[2,0],[1,1]], weight: 1 }, // ÿ¥ŸÉŸÑ T ŸÖŸÇŸÑŸàÿ®
  { shape: [[0,0],[0,1],[1,1],[2,1]], weight: 2 }, // ÿ¥ŸÉŸÑ ÿ≥ŸáŸÖ ŸÑŸÑŸäŸÖŸäŸÜ
  { shape: [[0,0],[1,0],[2,0],[3,0]], weight: 3 }, // ÿÆÿ∑ ÿ±ÿ£ÿ≥Ÿä ÿ∑ŸàŸäŸÑ 4 ŸÜŸÇÿßÿ∑
  { shape: [[0,0],[0,1],[0,2],[0,3]], weight: 3 }, // ÿÆÿ∑ ÿ£ŸÅŸÇŸä ÿ∑ŸàŸäŸÑ 4 ŸÜŸÇÿßÿ∑
  { shape: [[0,0],[1,0],[0,1],[1,1]], weight: 7 }, // ŸÖÿ±ÿ®ÿπ 2x2
  { shape: [[0,0],[1,0],[2,0],[0,1],[1,1],[2,1],[0,2],[1,2],[2,2]], weight: 7 }, // ŸÖÿ±ÿ®ÿπ 3x3
  { shape: [[0,0],[0,1],[0,2],[1,2],[2,2]], weight: 1 }, // ÿ¥ŸÉŸÑ L ŸÖÿπŸÉŸàÿ≥ ŸÉÿ®Ÿäÿ±
  { shape: [[0,0],[2,0],[0,1],[2,1],[0,2],[1,2],[2,2]], weight: 0.5 }, // ÿ¥ŸÉŸÑ U
  { shape: [[0,0],[1,0],[2,0],[1,1],[1,2]], weight: 2 }, // ÿ¥ŸÉŸÑ +
  { shape: [[0,0],[1,0],[1,1],[1,2],[2,2]], weight: 0.5 }, // ÿ¥ŸÉŸÑ S ŸÖÿßÿ¶ŸÑ
  { shape: [[0,0],[0,1],[1,1],[1,2],[2,2]], weight: 0.5 }  // ÿ¥ŸÉŸÑ Z ŸÖÿßÿ¶ŸÑ
];


  function switchScreen(screen) {
  if (!screens[screen]) {
    console.error(`‚ùå ÿßŸÑÿ¥ÿßÿ¥ÿ© '${screen}' ŸÖÿ¥ ŸÖÿπÿ±ŸÅÿ© ÿØÿßÿÆŸÑ screens object`);
    return;
  }

  Object.values(screens).forEach(s => s.classList.remove("active"));
  screens[screen].classList.add("active");
}

function startGame() {
  isGameRunning = true;
  console.log("üéÆ ÿ™ŸÖ ÿ™ÿ¥ÿ∫ŸäŸÑ startGame()");
  gameStartTime = Date.now();
  lastActivityTime = Date.now();

  if (!window.aiReady) {
    console.log("ŸÑÿ≥Ÿá ŸÖÿ≥ÿ™ŸÜŸä ÿ™ÿ≠ŸÖŸäŸÑ ÿßŸÑÿ¨ŸÖŸÑ...");
    setTimeout(startGame, 100);
    clearPreview();
    shapesDiv.innerHTML = "";
    return; // ‚õî ÿ•ŸÜŸáÿßÿ° ŸÖÿ®ŸÉÿ± ŸÇÿ®ŸÑ ÿ™ŸÜŸÅŸäÿ∞ ÿ£Ÿä ÿ¥Ÿäÿ° ÿ¢ÿÆÿ±
  }
  

  // ‚úÖ ÿ®ÿØÿ° ŸÖÿ±ÿßŸÇÿ®ÿ© ÿßŸÑÿÆŸÖŸàŸÑ (ÿßŸÑŸÖŸÑŸÑ)
  setInterval(() => {
    if (Date.now() - lastActivityTime > 17000) {
      showAIReaction("idle");
      lastActivityTime = Date.now(); // ŸÖŸÜÿπ ÿßŸÑÿ™ŸÉÿ±ÿßÿ± ÿßŸÑÿ≥ÿ±Ÿäÿπ
    }
  }, 4000);

  // ‚úÖ ÿ®ÿØÿ° ŸÖÿ±ÿßŸÇÿ®ÿ© ÿßŸÑÿ¨ŸäŸÖ ÿ£ŸàŸÅÿ± ÿ®ÿπÿØ ÿßŸÑÿ™ÿ£ŸÉÿØ ŸÖŸÜ ÿ¨ÿßŸáÿ≤Ÿäÿ© AI
  startGameOverWatcher();

  resumed = false;

  let oldBehavior = JSON.parse(localStorage.getItem("blockBehavior") || "{}");
  if (oldBehavior.totalMoves) playerBehavior = oldBehavior;

  switchScreen("game");
  grid.innerHTML = "";
  gridCells = [];

  for (let i = 0; i < 64; i++) {
    const cell = document.createElement("div");
    cell.className = "cell";
    grid.appendChild(cell);
    gridCells.push(cell);
  }

  score = 0;
  shapesUsed = 0;
  updateScore();
  generateSmartShapes();

  // ‚úÖ ŸÖÿ±ÿßŸÇÿ®ÿ© ÿßŸÑÿ£ÿØÿßÿ° ÿßŸÑÿ≥Ÿäÿ¶
  setTimeout(() => {
    const checkBadPerformance = setInterval(() => {
      if (!isGameRunning) return;

      const elapsed = Date.now() - gameStartTime;
      console.log("‚è± ŸàŸÇÿ™ ÿßŸÑŸÑÿπÿ®:", elapsed, "üìâ ÿßŸÑŸÜŸÇÿßÿ∑:", score, "üî• ŸÉŸÖÿ®Ÿà:", playerBehavior.perfectClears);
      if (score < 350 && elapsed > 25000 && playerBehavior.perfectClears === 0) {
        showAIReaction("embarrassed");
        clearInterval(checkBadPerformance);
      }
    }, 5000);
  }, 10000);

  // ‚úÖ ÿ•ÿπÿßÿØÿ© ÿ™ŸÅÿπŸäŸÑ ÿßŸÑÿµŸàÿ™ ŸÑŸà ŸÖÿ™ŸàŸÇŸÅ
  document.body.addEventListener('touchstart', () => {
    if (SoundManager.context?.state === 'suspended') {
      SoundManager.context.resume();
    }
  }, { once: true });
}

    function restartGame() {
    
      startGame();
    }

    function updateScore() {
      scoreboard.textContent = `Score: ${score}`;
      let smartFactor = 0;
if (playerBehavior.avgSpeed && playerBehavior.avgSpeed < 2000) smartFactor += 1;
if (playerBehavior.perfectClears >= 5) smartFactor += 1;
if (playerBehavior.nearFails === 0 && score > 800) smartFactor += 1;
difficultyLevel = 1 + smartFactor * 0.3; // ÿ™ŸÇŸÑŸäŸÑ Ÿàÿ™Ÿäÿ±ÿ© ÿßŸÑÿ™ÿµÿßÿπÿØ


    }

    function xyToIndex(x, y) {
      return y * 8 + x;
    }


function canPlaceAnyShape() {
  return shapesInHand.some(shape => canPlaceShapeAnywhere(shape));
}

setInterval(() => {
  const now = Date.now();
  if (now - lastSecretTime >= 60000 && now - lastAIReactionTime >= 5000) {
    showAIReaction("secret");
    lastSecretTime = now;
  }
}, 5000); // ŸÜÿ±ÿßŸÇÿ® ŸÉŸÑ 5 ÿ´ŸàÿßŸÜŸä

setInterval(() => {
  const now = Date.now();
  if (now - lastJokeyTime >= 30000 && now - lastAIReactionTime >= 5000) {
    showAIReaction("jokey");
    lastJokeyTime = now;
  }
}, 5000); // ŸÜÿ±ÿßŸÇÿ® ŸÉŸÑ 5 ÿ´ŸàÿßŸÜŸä




function canPlaceShapeAnywhere(shape) {
  const normalized = normalizeShape(shape);
  const maxX = Math.max(...normalized.map(([x]) => x));
  const maxY = Math.max(...normalized.map(([_, y]) => y));

  for (let y = 0; y <= 8 - maxY - 1; y++) {
    for (let x = 0; x <= 8 - maxX - 1; x++) {
      if (canPlace(normalized, x, y)) {
        return true;
      }
    }
  }

  return false;
}






function canPlaceShapeAt(shape, startRow, startCol) {
  for (let r = 0; r < shape.length; r++) {
    for (let c = 0; c < shape[r].length; c++) {
      if (shape[r][c]) {
        const cellIndex = xyToIndex(startCol + c, startRow + r);
        if (cellIndex < 0 || cellIndex >= gridCells.length || gridCells[cellIndex].classList.contains("filled")) {
          return false;
        }
      }
    }
  }
  return true;
}




function canPlace(shape, x, y) {
  for (const [dx, dy] of shape) {
    const gx = x + dx;
    const gy = y + dy;

    if (gx < 0 || gx >= 8 || gy < 0 || gy >= 8) {
      return false;
    }

    const index = gy * 8 + gx;
    const cell = gridCells[index];

    if (!cell || cell.classList.contains("filled")) {
      return false;
    }
  }

  return true;
}





function canShapeFitAnywhere(shape) {
  shape = normalizeShape(shape); // ‚Üê Ÿáÿ∞ÿß ÿßŸÑÿ™ÿπÿØŸäŸÑ ŸÖŸáŸÖ ÿ¨ÿØŸãÿß
  const maxDx = Math.max(...shape.map(([dx]) => dx));
  const maxDy = Math.max(...shape.map(([_, dy]) => dy));

  for (let y = 0; y <= 7 - maxDy; y++) {
    for (let x = 0; x <= 7 - maxDx; x++) {
      if (canPlace(shape, x, y)) {
        return true;
      }
    }
  }

  return false;
}


function normalizeShape(shape) {
  const minX = Math.min(...shape.map(([x]) => x));
  const minY = Math.min(...shape.map(([_, y]) => y));
  return shape.map(([x, y]) => [x - minX, y - minY]);
}









    function rotateShape(shape, times = 1) {
      let result = shape.map(([x, y]) => [x, y]);
      for (let t = 0; t < times; t++) {
        result = result.map(([x, y]) => [y, -x]);
        const minX = Math.min(...result.map(([x]) => x));
        const minY = Math.min(...result.map(([_, y]) => y));
        result = result.map(([x, y]) => [x - minX, y - minY]);
      }
      return result;
    }




    function createShapeElement(shape) {
  const el = document.createElement("div");
  el.className = "shape";

  // ÿ≠ÿ≥ÿßÿ® ÿ£ŸÇŸÑ ÿ•ÿ≠ÿØÿßÿ´Ÿä X Ÿà Y ŸÑÿ™ÿ®ÿØÿ£ ÿßŸÑÿ¥ÿ®ŸÉÿ© ŸÖŸÜ ÿßŸÑÿ≤ÿßŸàŸäÿ© ÿßŸÑÿπŸÑŸäÿß ÿßŸÑŸäÿ≥ÿ±Ÿâ
  const xs = shape.map(([x]) => x);
  const ys = shape.map(([_, y]) => y);
  const minX = Math.min(...xs);
  const minY = Math.min(...ys);

  shape.forEach(([x, y]) => {
    const block = document.createElement("div");
    block.className = "block";

    // ÿ™ÿ≠ÿØŸäÿØ ŸÖŸàŸÇÿπ ÿßŸÑÿ®ŸÑŸàŸÉ ÿØÿßÿÆŸÑ ÿ¥ÿ®ŸÉÿ© 4x4 ŸÑŸÉŸÜ ÿ™ÿ®ÿØÿ£ ŸÖŸÜ (0,0)
    block.style.gridColumn = `${x - minX + 1}`;
    block.style.gridRow = `${y - minY + 1}`;

    el.appendChild(block);
  });

  return el;
}


    function getRandomWeightedShape() {
      let filtered = weightedShapes.filter(s => s.shape.length <= (5 + difficultyLevel));
      let totalWeight = filtered.reduce((sum, s) => sum + s.weight, 0);
      let rand = Math.random() * totalWeight;
      for (let s of filtered) {
        if (rand < s.weight) return s.shape;
        rand -= s.weight;
      }
    }


document.addEventListener("touchmove", e => {
  
if (activePointerId !== "touch" || !floating) return;

  const touch = e.touches[0];
  const moveX = touch.pageX - pointerStartX;
  const moveY = touch.pageY - pointerStartY;
  floating.style.left = `${floatingStartX + moveX}px`;
  floating.style.top = `${floatingStartY + moveY}px`;
}, { passive: false });





function generateSmartShapes() {
  shapesDiv.innerHTML = "";
  shapesUsed = 0;
  shapesInHand = [];
  let tries = 0;

  while (shapesInHand.length < 3 && tries < 100) {
  let shape = getRandomWeightedShape();
let rotation = Math.floor(Math.random() * 4);
shape = rotateShape(shape, rotation);
shape = normalizeShape(shape); // ‚Üê ŸÖŸáŸÖ ÿ¨ÿØŸãÿß ŸáŸÜÿß



    if (canShapeFitAnywhere(shape)) {
      shapesInHand.push(shape);
    }

    tries++;
  }

  // ‚úÖ ÿ™ÿ£ŸÉÿØ ÿ£ŸÜ ÿ¨ŸÖŸäÿπ ÿßŸÑÿ£ÿ¥ŸÉÿßŸÑ ŸÇÿßÿ®ŸÑÿ© ŸÑŸÑŸàÿ∂ÿπ
  const anyFit = shapesInHand.some(shape => canShapeFitAnywhere(shape));
  if (shapesInHand.length < 3 || !anyFit) {
    console.warn("üõë ŸÅÿ¥ŸÑ ÿ™ŸàŸÑŸäÿØ ÿ£ÿ¥ŸÉÿßŸÑ ÿµÿßŸÑÿ≠ÿ© ‚Äì Game Over");
    showGameOver();
    return;
  }





  
  // ‚úÖ ÿ™ŸàŸÑŸäÿØ ÿßŸÑÿπŸÜÿßÿµÿ± ÿπŸÑŸâ ÿßŸÑÿ¥ÿßÿ¥ÿ©
  shapesInHand.forEach(shape => {
    const el = createShapeElement(shape);
    shapesDiv.appendChild(el);

   el.addEventListener("pointerdown", e => {
      if (activePointerId !== null && e.pointerId !== activePointerId) return; // ‚ùå ÿ™ÿ¨ÿßŸáŸÑ ÿ£Ÿä ŸÑŸÖÿ≥ÿ© ÿ•ÿ∂ÿßŸÅŸäÿ©
  activePointerId = e.pointerId;
 
  activePointerId = e.pointerId;
if (e.pointerType === "touch") {
  activeTouchId = e.pointerId;
}

el.addEventListener("touchstart", e => {
  if (activePointerId !== null) return;

  const touch = e.touches[0];
  activePointerId = "touch";
  activeTouchId = touch.identifier;

  pointerStartX = touch.pageX;
  pointerStartY = touch.pageY;
  floatingStartX = el.offsetLeft;
  floatingStartY = el.offsetTop;
  floating = el;

  el.style.zIndex = 1000;
  SoundManager.play('shapePick');
});

  SoundManager.play('shapePick');

      SoundManager.play('shapePick');
      e.preventDefault();

      sourceElement = el;

      const cellSize = gridCells[0].getBoundingClientRect().width;
      document.documentElement.style.setProperty('--cell-size', `${cellSize}px`);

      const rect = el.getBoundingClientRect();
      offset.x = e.clientX - rect.left;
      offset.y = e.clientY - rect.top;

      floating = el.cloneNode(true);
      floating.classList.add("floating");

      const maxX = Math.max(...shape.map(([x]) => x));
      const maxY = Math.max(...shape.map(([_, y]) => y));

      floating.style.width = `${cellSize * (maxX + 1)}px`;
      floating.style.height = `${cellSize * (maxY + 1)}px`;

      document.body.appendChild(floating);

      const x = e.pageX - offset.x;
      const y = e.pageY - offset.y - (cellSize * 4);

      floating.style.left = `${x}px`;
      floating.style.top = `${y}px`;

      pointerStartX = e.pageX;
      pointerStartY = e.pageY;
      floatingStartX = x;
      floatingStartY = y;

      currentShape = shape;
      lastPointer = { pageX: e.pageX, pageY: e.pageY };

 

      animationFrameId = requestAnimationFrame(followPointer);

      el.style.visibility = "hidden";
    });
  });
}




let activeTouchId = null;
let activePointerId = null;


let gameOverCheckInterval = null;
let isDragging = false;


function startGameOverWatcher() {
  clearInterval(gameOverCheckInterval);

  gameOverCheckInterval = setInterval(() => {
    if (isDragging) return; // ŸàŸÇŸÅ ÿßŸÑŸÅÿ≠ÿµ ÿ£ÿ´ŸÜÿßÿ° ÿßŸÑÿ≥ÿ≠ÿ®

   


    const filledCellsCount = gridCells.filter(c => c.classList.contains("filled")).length;
    const fillRatio = filledCellsCount / gridCells.length;

    if (fillRatio >= 0.75 && !window._alreadyWarnedNearLose) {
      showAIReaction('nearLose');
      setTimeout(() => {
  window._alreadyWarnedNearLose = false;
}, 10000);

    }

    shapesInHand.forEach((shape, i) => {
      const canFit = canShapeFitAnywhere(shape);
     
    });


    const anyFit = shapesInHand.some(shape => canPlaceShapeAnywhere(shape));
    

  if (!anyFit) {
  

  // üëá ŸÖŸáŸÖ ÿ¨ÿØÿßŸã ŸÜŸàŸÇŸÅ ŸÖÿ±ÿßŸÇÿ®ÿ© ÿßŸÑÿ¨ŸäŸÖ ÿ£ŸàŸÅÿ±
  clearInterval(gameOverCheckInterval);

  // ‚úÖ ŸÜŸÅŸëÿ∞ ÿßŸÑÿ¨ŸäŸÖ ÿ£ŸàŸÅÿ± ŸÖÿ®ÿßÿ¥ÿ±ÿ©
  showGameOver();
}

  }, 100);

}






function trackPointer(e) {
  lastPointer.pageX = e.pageX;
  lastPointer.pageY = e.pageY;
}



function followPointer() {
  if (!floating || !lastPointer) return;

  const cellSize = gridCells[0].getBoundingClientRect().width;
  const gridRect = grid.getBoundingClientRect();

  const speedBoost = 1.4;

  const moveX = (lastPointer.pageX - pointerStartX) * speedBoost;
  const moveY = (lastPointer.pageY - pointerStartY) * speedBoost;

  const x = floatingStartX + moveX;
  const y = floatingStartY + moveY;
lastActivityTime = Date.now(); // ÿ™ÿ≠ÿØŸäÿ´ ŸàŸÇÿ™ ÿßŸÑŸÜÿ¥ÿßÿ∑ ÿßŸÑÿ£ÿÆŸäÿ±
  // üîÑ ÿ™ÿ≠ÿ±ŸäŸÉ ÿßŸÑÿ¥ŸÉŸÑ ÿßŸÑÿπÿßÿ¶ŸÖ ÿ®ÿ≥ÿ±ÿπÿ© ÿ£ÿπŸÑŸâ
  floating.style.left = `${x}px`;
  floating.style.top = `${y}px`;

  // ‚úÖ ÿ≠ÿ≥ÿßÿ® ŸÖŸàÿ∂ÿπ ÿßŸÑÿ∏ŸÑ ÿ®ŸÜÿßÿ°Ÿã ÿπŸÑŸâ ŸÖÿ±ŸÉÿ≤ ÿßŸÑÿ¥ŸÉŸÑ ŸÖÿπ ÿ™ÿπŸàŸäÿ∂ 0.5 ÿÆŸÑŸäÿ© ŸÑÿ™Ÿàÿßÿ≤ŸÜ ÿßŸÑÿ≠ÿ±ŸÉÿ©
  const gridX = Math.floor((x + cellSize * 0.5 - gridRect.left) / (gridRect.width / 8));
  const gridY = Math.floor((y + cellSize * 0.5 - gridRect.top) / (gridRect.height / 8));

  if (canPlace(currentShape, gridX, gridY)) {
    showPreview(currentShape, gridX, gridY);
  } else {
    clearPreview();
  }

  animationFrameId = requestAnimationFrame(followPointer);
}






function placeShape(shape, x, y) {
  
  failedShapePlacements = 0; // ‚Üê ŸÜÿ®ÿØÿ£ ÿßŸÑÿπÿØ ŸÖŸÜ ÿ¨ÿØŸäÿØ ŸÑŸà ŸÜÿ¨ÿ≠ ŸÅŸä Ÿàÿßÿ≠ÿØÿ©

  shapesSinceLastClear++;
if (shapesSinceLastClear >= 6) {
  showAIReaction('embarrassed');
  shapesSinceLastClear = 0;
}

  shapesInHand = shapesInHand.filter(s => s !== currentShape);

  shape.forEach(([dx, dy]) => {
    gridCells[xyToIndex(x + dx, y + dy)].classList.add("filled");
  });
shapesSinceLastClear++;
if (shapesSinceLastClear >= 6) {
  showAIReaction("embarrassed");
  shapesSinceLastClear = 0;
}

  score += shape.length * 10;
checkFullLines();
updateScore();
checkNearLose();


  shapesUsed++;

  // ÿßŸÑÿ¨ŸÖŸÑ ÿßŸÑÿ™ŸÅÿßÿπŸÑŸäÿ© ŸÑŸÑÿ∞ŸÉÿßÿ° ÿßŸÑÿßÿµÿ∑ŸÜÿßÿπŸä
  if (playerBehavior.repeatedShapeCount >= 3) {
    showAIReaction('angry');
    playerBehavior.repeatedShapeCount = 0;
  }

  if (playerBehavior.failedAttempts >= 3) {
    showAIReaction('angry');
    playerBehavior.failedAttempts = 0;
  }

  if (playerBehavior.totalMoves >= 6 && playerBehavior.perfectClears === 0 && score < 250) {
    showAIReaction("embarrassed");
  }

  shapesInHand.forEach((shape, i) => {
  
});

  if (shapesUsed >= 3) {
    generateSmartShapes();
    shapesUsed = 0;

    // ‚úÖ ŸÅÿ≠ÿµ ÿßŸÑÿ¨ŸäŸÖ ÿ£ŸàŸÅÿ± ÿ®ÿπÿØ ÿßŸÑÿ™ŸàŸÑŸäÿØ
    if (!canPlaceAnyShape()) {
      console.warn("üìõ ŸÖŸÅŸäÿ¥ ŸÖŸÉÿßŸÜ ŸÑÿ£Ÿä ÿ¥ŸÉŸÑ ‚Äì Game Over");
      showGameOver();
      return;
    }
  }
 if (countingUselessShapes) {
  uselessShapesInARow++;
  if (uselessShapesInARow >= 6) {
    showAIReaction("embarrassed");
    uselessShapesInARow = 0;
  }
}


}
    
// ÿ∂ÿπ Ÿáÿ∞ÿß ÿ®ÿØŸÑÿßŸã ŸÖŸÜ gameLoop ÿßŸÑŸÇÿØŸäŸÖ
function runGame() {
  // ÿ£ŸÉŸàÿßÿØ ÿßŸÑŸÑÿπÿ®ÿ© ÿßŸÑÿ≠ÿßŸÑŸäÿ© ŸáŸÜÿß
  if (!document.hidden) {
    setTimeout(runGame, 1000/60); // 60 FPS
  }
  lastActivityTime = Date.now(); // ‚è±Ô∏è ÿ™ÿ≠ÿØŸäÿ´ ÿ¢ÿÆÿ± ŸÜÿ¥ÿßÿ∑

}






runGame();

    function checkFullLines() {
  let clearedRows = [], clearedCols = [];

  // ŸÉŸàÿØ ÿßŸÑŸÉÿ¥ŸÅ ÿπŸÜ ÿßŸÑÿµŸÅŸàŸÅ ŸàÿßŸÑÿ£ÿπŸÖÿØÿ© ÿßŸÑŸÖŸÖÿ™ŸÑÿ¶ÿ© Ÿäÿ®ŸÇŸâ ŸÉŸÖÿß ŸáŸà
  for (let row = 0; row < 8; row++) {
    if ([...Array(8)].every((_, col) => gridCells[xyToIndex(col, row)].classList.contains("filled"))) {
      clearedRows.push(row);
    }
  }

  for (let col = 0; col < 8; col++) {
    if ([...Array(8)].every((_, row) => gridCells[xyToIndex(col, row)].classList.contains("filled"))) {
      clearedCols.push(col);
    }
  }
shapesSinceLastClear = 0; // ÿµŸÅŸäŸÜÿß ÿßŸÑÿπÿØÿßÿØ ŸÑÿ£ŸÜ ÿ™ŸÖ ŸÖÿ≥ÿ≠ ÿµŸÅŸàŸÅ

  if (clearedRows.length || clearedCols.length) {
    const totalCleared = clearedRows.length + clearedCols.length;

// ÿßŸÑÿ≠ÿßŸÑÿ© 1: ŸÖÿ≥ÿ≠ 3 ÿµŸÅŸàŸÅ ÿ£Ÿà ÿ£ŸÉÿ´ÿ± ŸÖÿ±ÿ© Ÿàÿßÿ≠ÿØÿ©
if (totalCleared >= 3) {
  showAIReaction("shocked");
  smallClearsInARow = 0; // ŸÜÿ®ÿØÿ£ ŸÖŸÜ ÿ¨ÿØŸäÿØ
}

// ÿßŸÑÿ≠ÿßŸÑÿ© 2: ŸÖÿ≥ÿ≠ ÿµŸÅ ÿ£Ÿà ÿµŸÅŸäŸÜ
else if (totalCleared > 0 && totalCleared <= 2) {
  smallClearsInARow++;
  if (smallClearsInARow >= 3) {
    showAIReaction("shocked");
    smallClearsInARow = 0;
  }
} else {
  // ŸÑŸà ŸÖÿßŸÅŸäÿ¥ ŸÖÿ≥ÿ≠ ÿµŸÅŸàŸÅ ŸÅŸä ÿßŸÑŸÑÿπÿ®ÿ© ÿØŸä
  smallClearsInARow = 0;
}

    countingUselessShapes = true;
uselessShapesInARow = 0;

    uselessShapesInARow = 0;

    shapesSinceLastClear = 0;

    // ÿ£ÿ∂ŸÅ Ÿáÿ∞ÿß ÿßŸÑÿ¨ÿ≤ÿ° ÿßŸÑÿ¨ÿØŸäÿØ ŸáŸÜÿß ‚Üì
    
    
    // ÿ™ÿ¥ÿ∫ŸäŸÑ ÿßŸÑÿµŸàÿ™ ÿßŸÑŸÖŸÜÿßÿ≥ÿ®
    if (totalCleared >= 2) {
      SoundManager.play('comboClear');
    } else {
      SoundManager.play('singleClear');
    }

    // ÿ®ÿßŸÇŸä ÿßŸÑŸÉŸàÿØ Ÿäÿ®ŸÇŸâ ŸÉŸÖÿß ŸáŸà ‚Üì
    clearedRows.forEach(row => {
      for (let col = 0; col < 8; col++) gridCells[xyToIndex(col, row)].classList.remove("filled");
    });

    clearedCols.forEach(col => {
      for (let row = 0; row < 8; row++) gridCells[xyToIndex(col, row)].classList.remove("filled");
    });

    score += totalCleared * 100;
    updateScore();

    setTimeout(() => {
      if (totalCleared >= 2) {
        showAIReaction('combo');
      } else {
        showAIReaction('lineClear');
      }
      
    }, 100);
  }
}


function showGameOver() {
  if (screens.gameover.classList.contains("active")) return;

  clearInterval(gameOverCheckInterval);
  playerBehavior.nearFails++;

  switchScreen("gameover");

  // ‚úÖ ÿ•ÿ∏Ÿáÿßÿ± ÿßŸÑÿ≤ÿ± ÿßŸÑÿ∞Ÿáÿ®Ÿä
  document.getElementById("resumeBtn").style.display = "inline-block";
  document.getElementById("restartBtn").style.display = "none";
  document.getElementById("insightBtn").style.display = "none";

  // ‚úÖ ÿπÿ±ÿ∂ ÿßŸÑÿ≥ŸÉŸàÿ± ÿ®ÿ¥ŸÉŸÑ ŸÖÿ™ŸÅÿ¨ÿ±
  const finalDisplay = document.getElementById("finalScoreDisplay");
  finalDisplay.innerHTML = `<div class="score-burst">${score}</div>`;
  finalDisplay.classList.add("show");

  // ‚úÖ ÿ™ŸÅÿ¨Ÿäÿ± ŸÖŸÅÿ±ŸÇÿπÿßÿ™ ÿ≠ŸàŸÑ ÿßŸÑÿ±ŸÇŸÖ
  triggerFireworks(finalDisplay);

  // ‚úÖ ÿπÿØÿßÿØ ÿßŸÑÿßÿ≥ÿ™ÿ¶ŸÜÿßŸÅ
  countdownEl.style.display = "block";
  startResumeCountdown();

  // ‚úÖ ÿ≠ŸÅÿ∏ ÿßŸÑÿ£ÿØÿßÿ°
  const history = JSON.parse(localStorage.getItem("playerHistory") || "[]");
  history.push({
    score,
    fastMoves: playerBehavior.fastMoves,
    slowMoves: playerBehavior.slowMoves,
    perfectClears: playerBehavior.perfectClears,
    nearFails: playerBehavior.nearFails,
    failedAttempts: playerBehavior.failedAttempts || 0,
    totalMoves: playerBehavior.totalMoves,
    avgSpeed: playerBehavior.avgSpeed,
    duration: Date.now() - gameStartTime,
    mood: aiMemory.mood || "neutral",
    shapeRepeats: playerBehavior.repeatedShapeCount || 0
  });
  if (history.length > 10) history.shift();
  localStorage.setItem("playerHistory", JSON.stringify(history));

  isGameRunning = false;
}


function triggerFireworks(container) {
  for (let i = 0; i < 12; i++) {
    const sparkle = document.createElement("div");
    sparkle.className = "sparkle";
    sparkle.style.left = `${50 + Math.random() * 100 - 50}%`;
    sparkle.style.top = `${50 + Math.random() * 100 - 50}%`;
    container.appendChild(sparkle);
    setTimeout(() => sparkle.remove(), 1000);
  }
}




function resumeGame() {
  isGameRunning = true;

  // Ÿáÿ∞ÿß ŸÖŸÉÿßŸÜ Ÿàÿ∂ÿπ ŸÉŸàÿØ AdMob ÿßŸÑÿ≠ŸÇŸäŸÇŸä ŸÑÿßÿ≠ŸÇÿßŸã
  // ÿßŸÑŸÖÿ´ÿßŸÑ ÿßŸÑÿ™ÿßŸÑŸä ÿ¨ÿßŸáÿ≤ ŸÑÿßÿ≥ÿ™ÿ®ÿØÿßŸÑŸá ÿ®ŸÄ AdMob Rewarded Ad
  
  // 1. ŸáŸÜÿß ÿ≥ÿ™ÿ∂ÿπ ŸÉŸàÿØ ÿπÿ±ÿ∂ ÿßŸÑÿ•ÿπŸÑÿßŸÜ ÿßŸÑŸÖŸÉÿßŸÅÿ¶ (AdMob)
  // 2. ÿπŸÜÿØ ÿßŸÉÿ™ŸÖÿßŸÑ ŸÖÿ¥ÿßŸáÿØÿ© ÿßŸÑÿ•ÿπŸÑÿßŸÜÿå Ÿäÿ™ŸÖ ÿ™ŸÜŸÅŸäÿ∞ ÿßŸÑŸÉŸàÿØ ÿØÿßÿÆŸÑ onAdWatched()
  
  // ŸÖÿ≠ÿßŸÉÿßÿ© ŸÑÿπÿ±ÿ∂ ÿßŸÑÿ•ÿπŸÑÿßŸÜ (ÿßÿ≠ÿ∞ŸÅ Ÿáÿ∞ÿß ÿπŸÜÿØ ÿØŸÖÿ¨ AdMob ÿßŸÑŸÅÿπŸÑŸä)
  const onAdWatched = () => {
    // ŸÉŸàÿØ ÿßÿ≥ÿ™ÿ¶ŸÜÿßŸÅ ÿßŸÑŸÑÿπÿ® ÿßŸÑŸÅÿπŸÑŸä
    clearInterval(countdownTimer);
    clearPreview();
    
    // ŸÖÿ≥ÿ≠ ÿ£Ÿä ÿ£ÿ¥ŸÉÿßŸÑ ŸÖÿ™ÿ®ŸÇŸäÿ©
    shapesDiv.innerHTML = "";
    generateSmartShapes(); // ‚Üê ÿ™ŸàŸÑŸäÿØ ÿ£ÿ¥ŸÉÿßŸÑ ÿ¨ÿØŸäÿØÿ© ÿ®ÿπÿØ ÿßŸÑÿ•ÿπŸÑÿßŸÜ

    // ÿ•ÿπÿßÿØÿ© ÿ™ÿ¥ÿ∫ŸäŸÑ ŸÖÿ±ÿßŸÇÿ®ÿ© ÿßŸÑÿ¨ŸäŸÖ ÿ£ŸàŸÅÿ± ÿ®ÿπÿØ ÿßŸÑÿßÿ≥ÿ™ÿ¶ŸÜÿßŸÅ
startGameOverWatcher();

    // ŸÖÿ≥ÿ≠ ÿ®ÿπÿ∂ ÿßŸÑÿÆŸÑÿßŸäÿß ÿπÿ¥Ÿàÿßÿ¶ŸäÿßŸã (ŸÖÿ´ÿßŸÑ: 5 ÿÆŸÑÿßŸäÿß)
let filledCells = gridCells.filter(cell => cell.classList.contains("filled"));
let targetToClear = Math.floor(filledCells.length * 0.4); // 40% ŸÖŸÜ ÿßŸÑŸÖŸÑŸäÿßŸÜŸäŸÜ



let cellSize = 0;




let cellsCleared = 0;
for (let row = 0; row < 8; row++) {
  for (let col = 0; col < 8; col++) {
    const index = xyToIndex(col, row);
    const cell = gridCells[index];

    if (cell.classList.contains("filled")) {
      cell.classList.remove("filled");
      cellsCleared++;
    }

    if (cellsCleared >= targetToClear) break;
  }
  if (cellsCleared >= targetToClear) break;
}


    
    // ÿ•ÿπÿßÿØÿ© ÿ™ŸàŸÑŸäÿØ ÿßŸÑÿ£ÿ¥ŸÉÿßŸÑ


    // ÿßŸÑÿπŸàÿØÿ© ÿ•ŸÑŸâ ÿ¥ÿßÿ¥ÿ© ÿßŸÑŸÑÿπÿ®
    switchScreen("game");
    
    // ÿ®ÿØÿ° ÿßŸÑŸÖÿ±ÿßŸÇÿ®ÿ© ŸÖŸÜ ÿ¨ÿØŸäÿØ

  };
  
  // ŸÖÿ≠ÿßŸÉÿßÿ© ÿßŸÑÿ•ÿπŸÑÿßŸÜ (ÿßÿ≥ÿ™ÿ®ÿØŸÑ Ÿáÿ∞ÿß ÿ® AdMob)
  onAdWatched(); // ÿßÿ≠ÿ∞ŸÅ Ÿáÿ∞ÿß ÿßŸÑÿ≥ÿ∑ÿ± ÿπŸÜÿØ ÿØŸÖÿ¨ AdMÿ®
  
  // ŸÉŸàÿØ AdMob ÿßŸÑŸÖÿ´ÿßŸÑ (ÿ¨ÿßŸáÿ≤ ŸÑŸÑÿ•ÿ∂ÿßŸÅÿ©):
  /*
  if(window.admob) {
    admob.rewarded.load().then(() => {
      return admob.rewarded.show();
    }).then(() => {
      onAdWatched();
    }).catch(err => {
      console.log("Error showing ad:", err);
    });
  }
  */
}

// ÿØÿßŸÑÿ© ŸÖÿ≥ÿßÿπÿØÿ© ŸÑÿπÿ±ÿ∂ ÿßŸÑÿ•ÿπŸÑÿßŸÜ (ÿ≥ÿ™ÿ≠ÿ™ÿßÿ¨ ŸÑÿ±ÿ®ÿ∑Ÿáÿß ÿ®AdMob ŸÑÿßÿ≠ŸÇÿßŸã)
function showRewardedAdWithCallback(callback) {
  isGameRunning = true;
  lastActivityTime = Date.now();
startGameOverWatcher();


  // ÿ¨ÿßŸáÿ≤ÿ© ŸÑÿØŸÖÿ¨ AdMob ŸÖÿ®ÿßÿ¥ÿ±ÿ©
  callback(); // ÿßÿ≠ÿ∞ŸÅ Ÿáÿ∞ÿß ÿßŸÑÿ≥ÿ∑ÿ± ÿπŸÜÿØ ÿØŸÖÿ¨ AdMob
  
  // ŸÜŸÖŸàÿ∞ÿ¨ ŸÉŸàÿØ AdMob:
  /*
  return new Promise((resolve) => {
    if(window.admob) {
      admob.rewarded.load().then(() => {
        return admob.rewarded.show();
      }).then(() => {
        callback();
        resolve(true);
      }).catch(err => {
        console.log("Error showing ad:", err);
        resolve(false);
      });
    } else {
      resolve(false);
    }
  });
  */
 
}



function showRewardedAd(callback) {
  // Ÿáÿ∞ÿß ŸÖŸÉÿßŸÜ ÿ±ÿ®ÿ∑ ÿ•ÿπŸÑÿßŸÜ AdMob ÿßŸÑÿ≠ŸÇŸäŸÇŸä ŸÑÿßÿ≠ŸÇŸãÿß
  console.log("üì∫ ÿπÿ±ÿ∂ ÿ•ÿπŸÑÿßŸÜ ÿßŸÑŸÖŸÉÿßŸÅÿ£ÿ©");
  
  // ŸÑŸÖÿ≠ÿßŸÉÿßÿ© ÿßŸÑÿ•ÿπŸÑÿßŸÜ (ŸÑŸÑÿ™ÿ∑ŸàŸäÿ± ŸÅŸÇÿ∑)
  const adShown = confirm("Ÿáÿ∞ÿß ŸÖŸÉÿßŸÜ ÿ•ÿπŸÑÿßŸÜ ÿßŸÑŸÖŸÉÿßŸÅÿ£ÿ©. ŸáŸÑ ÿ™ÿ±ŸäÿØ ÿßŸÑŸÖÿ™ÿßÿ®ÿπÿ©ÿü");
  
  if (adShown) {
    if (callback) callback();
    return true;
  }
  return false;
}

function generateInsightReport() {
  const textArea = document.getElementById("insightAiText");
  const avatar = document.getElementById("insightAiAvatar");
  const dots = document.querySelector("#insightAiBubble .ai-dots");
  const shareBtn = document.getElementById("shareInsightBtn");
  const closeBtn = document.getElementById("closeInsightBtn");

  shareBtn.classList.add("hidden");
  closeBtn.classList.add("hidden");
  shareBtn.classList.remove("visible");
  closeBtn.classList.remove("visible");

  const b = playerBehavior;
  const mood = aiMemory?.mood || "neutral";
  const lang = JSON.parse(localStorage.getItem("blockPlayerData"))?.language || 'ar';
  const ai = window.aiResponses?.insightBlocks || {};
  const rand = arr => arr[Math.floor(Math.random() * arr.length)];
  const report = [];

  // 1. ŸÖŸÇÿØŸÖÿ© ÿ¨ÿßÿØÿ© ÿ™ÿ≠ŸÑŸäŸÑŸäÿ©
  if (ai.opening?.length) report.push("üß† " + rand(ai.opening));

  // 2. ÿ™ÿ≠ŸÑŸäŸÑ ÿ£ÿØÿßÿ° (ÿ≠ÿ≥ÿ® ÿßŸÑŸÜÿ™ÿßÿ¶ÿ¨)
  if (b.score > 4000 && ai.analysis_strong?.length) {
    report.push("üìä " + rand(ai.analysis_strong));
  } else if (b.score < 1000 && ai.analysis_weak?.length) {
    report.push("üìâ " + rand(ai.analysis_weak));
  } else if (ai.analysis_neutral?.length) {
    report.push("üìà " + rand(ai.analysis_neutral));
  }

  // 3. ÿ™ÿ≠ŸÑŸäŸÑ ŸÜŸÅÿ≥Ÿä (ÿ≠ÿ≥ÿ® ÿßŸÑÿ≥ŸÑŸàŸÉ)
  if (b.repeatedShapeCount > 3 && ai.emotion_stubborn?.length) {
    report.push("üß± " + rand(ai.emotion_stubborn));
  } else if (b.failedAttempts > 4 && ai.emotion_nervous?.length) {
    report.push("üò∞ " + rand(ai.emotion_nervous));
  } else if (b.slowMoves > b.fastMoves && ai.emotion_hesitant?.length) {
    report.push("üê¢ " + rand(ai.emotion_hesitant));
  } else if (ai.emotion_generic?.length) {
    report.push("üåÄ " + rand(ai.emotion_generic));
  }

  // 4. ÿØÿπŸÖ ÿπÿßÿ∑ŸÅŸä ÿ≠ŸÇŸäŸÇŸä (ŸÑŸà ŸÅÿπŸÑÿßŸã Ÿäÿ≥ÿ™ÿ≠ŸÇ)
  if ((b.perfectClears >= 1 || b.gamesPlayed >= 4 || b.failedAttempts >= 5) && ai.support?.length) {
    report.push("üíô " + rand(ai.support));
  }

  // 5. ÿØÿπŸàÿ© ŸÑŸÑÿ™ÿ≠ÿØŸä ÿ®ŸÜÿßÿ°Ÿã ÿπŸÑŸâ ÿßŸÑŸÖÿ≤ÿßÿ¨ ÿßŸÑÿ≠ÿßŸÑŸä ŸÑŸÑÿÆÿµŸÖ
  if (mood === "confident" && ai.challenge_strong?.length) {
    report.push("üî• " + rand(ai.challenge_strong));
  } else if (ai.challenge_neutral?.length) {
    report.push("üéØ " + rand(ai.challenge_neutral));
  }

  // 6. ÿ™ÿ¥ÿ®ŸäŸá ÿÆÿ™ÿßŸÖŸä ÿ∫ÿ±Ÿäÿ®
  if (ai.closing?.length) {
    report.push("üåÄ " + rand(ai.closing));
  }

  const message = "\n\n" + report.join("\n\n");

  textArea.textContent = "";
  dots.style.display = "flex";
  avatar.src = "assets/ai_thinking.png";

  setTimeout(() => {
    dots.style.display = "none";
    let i = 0;
    function typeChar() {
      if (i < message.length) {
        textArea.textContent += message[i++];
        setTimeout(typeChar, 35);
      } else {
        shareBtn.classList.remove("hidden");
        closeBtn.classList.remove("hidden");
        shareBtn.classList.add("visible");
        closeBtn.classList.add("visible");
        avatar.src = "assets/ai_smile.png";
        avatar.classList.add("bounce");
      }
    }
    typeChar();
  }, 1000);
    startAvatarIntroduction();
}



function showInsightReport() {
  // ÿ•ÿÆŸÅÿßÿ° ÿ¥ÿßÿ¥ÿ© gameover ÿ£ŸàŸÑÿßŸã
  document.getElementById("gameover").classList.remove("active");
  
  // ÿ•ÿ∏Ÿáÿßÿ± ÿ¥ÿßÿ¥ÿ© ÿßŸÑÿ™ŸÇÿ±Ÿäÿ±
  document.getElementById("insightScreen").classList.remove("hidden");
  
  // ÿ™ŸàŸÑŸäÿØ ÿßŸÑÿ™ŸÇÿ±Ÿäÿ±
  generateInsightReport();
  
  // ÿ•ÿπÿßÿØÿ© ÿ™ÿ≠ŸÖŸäŸÑ ÿ±ÿØŸàÿØ ÿßŸÑÿ∞ŸÉÿßÿ° ÿßŸÑÿßÿµÿ∑ŸÜÿßÿπŸä ŸÑŸÑÿ™ÿ£ŸÉÿØ ŸÖŸÜ ÿπŸÖŸÑŸáÿß
  reloadAIResponses();
}


    function showAIMessage(text) {
      const aiText = document.getElementById("aiText");
      const heatBar = document.getElementById("aiHeatBar");
      aiText.textContent = text;
      aiText.classList.remove("show");
      heatBar.classList.remove("active");
      void aiText.offsetWidth;
      void heatBar.offsetWidth;
      aiText.classList.add("show");
      heatBar.classList.add("active");

      setTimeout(() => {
        aiText.classList.remove("show");
        heatBar.classList.remove("active");
      }, 3500);
    }

    function clearRandomLine() {
      const isRow = Math.random() < 0.5;
      const index = Math.floor(Math.random() * 8);
      if (isRow) {
        for (let col = 0; col < 8; col++) {
          gridCells[xyToIndex(col, index)].classList.remove("filled");
        }
      } else {
        for (let row = 0; row < 8; row++) {
          gridCells[xyToIndex(index, row)].classList.remove("filled");
        }
      }
    }

    

    function clearPreview() {
      gridCells.forEach(cell => {
        cell.classList.remove("preview");
        cell.classList.remove("line-clear-preview");
      });
    }

    function showPreview(shape, x, y) {
      clearPreview();
      const previewIndexes = [];

      shape.forEach(([dx, dy]) => {
        const gx = x + dx;
        const gy = y + dy;
        if (gx >= 0 && gx < 8 && gy >= 0 && gy < 8) {
          const index = xyToIndex(gx, gy);
          previewIndexes.push(index);
          gridCells[index].classList.add("preview");
        }
      });

      for (let row = 0; row < 8; row++) {
        if ([...Array(8)].every((_, col) => {
          const i = xyToIndex(col, row);
          return gridCells[i].classList.contains("filled") || previewIndexes.includes(i);
        })) {
          for (let col = 0; col < 8; col++) {
            gridCells[xyToIndex(col, row)].classList.add("line-clear-preview");
          }
        }
      }

      for (let col = 0; col < 8; col++) {
        if ([...Array(8)].every((_, row) => {
          const i = xyToIndex(col, row);
          return gridCells[i].classList.contains("filled") || previewIndexes.includes(i);
        })) {
          for (let row = 0; row < 8; row++) {
            gridCells[xyToIndex(col, row)].classList.add("line-clear-preview");
          }
        }
      }
    }



    let lastPointer = null;

function animateFloating(e) {
  if (!e || !e.pageX || !e.pageY) return;
  if (!floating || !lastPointer || !currentShape) return;

  const gridX = lastPointer.gridX;
  const gridY = lastPointer.gridY;

  if (typeof gridX === "undefined" || typeof gridY === "undefined") return;

  requestAnimationFrame(() => {
    const centerX = e.pageX - offset.x;
    const centerY = e.pageY - offset.y;

    const floatX = centerX - floating.offsetWidth / 2;
    const floatY = centerY - floating.offsetHeight / 2 - (cellSize * 4);

    floating.style.left = `${floatX}px`;
    floating.style.top = `${floatY}px`;

    if (canPlace(currentShape, gridX, gridY)) {
      showPreview(currentShape, gridX, gridY);
    } else {
      clearPreview();
    }
  });
}



window.addEventListener("pointermove", e => {
  if (e.pointerId !== activePointerId) return;

  if (!floating) return;
  lastPointer = e;
  animateFloating(e);
});






document.addEventListener("pointerup", e => {
  if (e.pointerId === activePointerId) {
  activePointerId = null;
}
// üëà ŸÅŸÉ ŸÇŸÅŸÑ ÿßŸÑŸÑŸÖÿ≥ÿ© ŸÑŸÖÿß ÿ™ÿÆŸÑÿµ

  if (!floating) return;

  // üß† ŸÜÿ≠ÿ≥ÿ® ŸÖŸÉÿßŸÜ ÿßŸÑÿ•ÿ≥ŸÇÿßÿ∑ ÿ®ŸÜŸÅÿ≥ ÿ∑ÿ±ŸäŸÇÿ© ÿßŸÑÿ¥ŸÉŸÑ ÿßŸÑÿπÿßÿ¶ŸÖ (ŸÖÿπ ÿ≥ÿ±ÿπÿ© 1.4)
  const cellSize = gridCells[0].getBoundingClientRect().width;
  const gridRect = grid.getBoundingClientRect();

  const moveX = (e.pageX - pointerStartX) * 1.4;
  const moveY = (e.pageY - pointerStartY) * 1.4;

  const boostedX = floatingStartX + moveX;
  const boostedY = floatingStartY + moveY;

  const gridX = Math.floor((boostedX + cellSize * 0.5 - gridRect.left) / (gridRect.width / 8));
  const gridY = Math.floor((boostedY + cellSize * 0.5 - gridRect.top) / (gridRect.height / 8));

  if (canPlace(currentShape, gridX, gridY)) {
    placeShape(currentShape, gridX, gridY);
    sourceElement.remove(); // ÿ≠ÿ∞ŸÅ ÿßŸÑÿ¥ŸÉŸÑ ŸÖŸÜ ÿ™ÿ≠ÿ™
  } else {
    
    sourceElement.style.visibility = "visible"; // ÿ±ÿ¨ŸëÿπŸá ŸÑŸà ŸÅÿ¥ŸÑ
    failedShapePlacements++;
console.log("‚ùå ŸÅÿ¥ŸÑ ŸÅŸä Ÿàÿ∂ÿπ ÿßŸÑÿ¥ŸÉŸÑ - ÿßŸÑŸÖÿ≠ÿßŸàŸÑÿ© ÿ±ŸÇŸÖ", failedShapePlacements);

if (failedShapePlacements >= 3) {
  showAIReaction('angry');
  failedShapePlacements = 0;
}

    failedShapePlacements++;
console.log("‚ùå ŸÅÿ¥ŸÑ ŸÅŸä Ÿàÿ∂ÿπ ÿßŸÑÿ¥ŸÉŸÑ - ÿßŸÑÿπÿØÿØ:", failedShapePlacements);

if (failedShapePlacements >= 3) {
  showAIReaction('angry');
  failedShapePlacements = 0;
}

  }

  clearPreview();
  floating.remove();
  floating = null;
  currentShape = null;
  sourceElement = null;

  cancelAnimationFrame(animationFrameId);
  isDragging = false;
  activePointerId = null;



});






  let playerData;
try {
  playerData = JSON.parse(localStorage.getItem("blockPlayerData")) || {};
  if (typeof playerData.language !== 'string' || typeof playerData.gender !== 'string') {
    throw new Error("ÿ®ŸäÿßŸÜÿßÿ™ ÿ∫Ÿäÿ± ÿµÿßŸÑÿ≠ÿ©");
  }
} catch (e) {
  console.warn("üö® ÿ®ŸäÿßŸÜÿßÿ™ ŸÖÿ¥ ŸÖÿ∏ÿ®Ÿàÿ∑ÿ© ŸÖŸÜ localStorage - ŸáŸÜÿ®ÿØÿ£ ŸÖŸÜ ÿ¨ÿØŸäÿØ");
  localStorage.removeItem("blockPlayerData");
  playerData = { language: '', gender: '' };
}



    function chooseLanguage(lang) {
  playerData.language = lang;
  localStorage.setItem("blockPlayerData", JSON.stringify(playerData));
  document.getElementById("step2").style.display = "none";
document.getElementById("welcomeText").style.display = "block";
document.getElementById("langButtons").style.display = "none";
document.getElementById("step2").style.display = "block";



  if(lang === 'en') {
    document.getElementById("welcomeText").innerText = "ü§ñ Hello! Let me know you better!";
    document.getElementById("genderText").innerText = "üë§ Are you a boy or a girl?";
    document.querySelectorAll("#step2 button")[0].innerText = "üöπ Boy";
    document.querySelectorAll("#step2 button")[1].innerText = "üö∫ Girl";

    document.getElementById("ageText").innerText = "üéÇ How old are you?";
    document.querySelectorAll("#step3 button")[0].innerText = "üî¢ Under 18";
    document.querySelectorAll("#step3 button")[1].innerText = "üî¢ Above 18";

    document.querySelector("#finalStep button").innerText = "üöÄ Let's Start The Journey!";
  } else {
    document.getElementById("welcomeText").innerText = "ü§ñ ÿ£ŸáŸÑÿßŸã! ÿÆŸÑŸäŸÜÿß ŸÜÿ™ÿπÿ±ŸÅ ÿπŸÑŸäŸÉ ÿ¥ŸàŸäÿ©!";
    document.getElementById("genderText").innerText = "üë§ ÿ•ŸÜÿ™ ŸàŸÑÿØ ŸàŸÑÿß ÿ®ŸÜÿ™ÿü";
    document.querySelectorAll("#step2 button")[0].innerText = "üöπ ŸàŸÑÿØ";
    document.querySelectorAll("#step2 button")[1].innerText = "üö∫ ÿ®ŸÜÿ™";

    document.getElementById("ageText").innerText = "üéÇ ÿπŸÖÿ±ŸÉ ÿ£ŸÇŸÑ ŸÖŸÜ 18 ŸàŸÑÿß ÿ£ŸÉÿ™ÿ±ÿü";
    document.querySelectorAll("#step3 button")[0].innerText = "üî¢ ÿ£ŸÇŸÑ ŸÖŸÜ 18";
    document.querySelectorAll("#step3 button")[1].innerText = "üî¢ ÿ£ŸÉÿ®ÿ± ŸÖŸÜ 18";

    document.querySelector("#finalStep button").innerText = "üöÄ ŸäŸÑÿß ŸÜÿ®ÿØÿ£ ÿßŸÑÿ±ÿ≠ŸÑÿ©!";
  }

  applyLanguage(); // ‚Üê ÿ≥ÿ∑ÿ± ŸÖŸáŸÖ ÿ¨ÿØÿßŸã ŸÑÿ∂ŸÖÿßŸÜ ÿ™ÿ±ÿ¨ŸÖÿ© ÿ®ÿßŸÇŸä ÿßŸÑŸàÿßÿ¨Ÿáÿ©
  switchScreen("menu"); // ‚Üê ŸÑŸà ŸÉŸÜÿ™ ÿπÿßŸäÿ≤ ŸäŸÜŸÇŸÑŸá ÿ™ŸÑŸÇÿßÿ¶ŸäŸãÿß ŸÑŸÑŸÇÿßÿ¶ŸÖÿ© ÿ®ÿπÿØ ÿßŸÑŸÑÿ∫ÿ©

}


function chooseGender(gender) {
  playerData.gender = gender;
  localStorage.setItem("blockPlayerData", JSON.stringify(playerData));

  document.getElementById("welcomeScreen").classList.add("hidden");
  document.getElementById("avatarIntroScreen").classList.remove("hidden");

  reloadAIResponses();

 reloadAIResponses();
setTimeout(() => {
  if (window.aiReady) {
  showReactionMessage(getAvatarWelcomeMessage());


  }
  localStorage.setItem("firstVisitDone", "true");

}, 100);

}





 function getAvatarWelcomeMessage() {
  localStorage.setItem("blockPlayerData", JSON.stringify(playerData));
  reloadAIResponses();

  function startAvatarIntroduction() {
    document.getElementById("welcomeScreen").classList.add("hidden");
document.getElementById("avatarIntroScreen").classList.remove("hidden");

    console.log("üöÄ ÿØÿÆŸÑŸÜÿß ŸÅÿπŸÑÿßŸã ÿπŸÑŸâ startAvatarIntroduction()");

  const aiText = document.getElementById("introAiText");
  const aiDots = document.querySelector("#avatarIntroScreen .ai-dots");
  const avatarImg = document.getElementById("introAiAvatar");
  
  const savedData = JSON.parse(localStorage.getItem("blockPlayerData")) || {};
  const lang = savedData.language || "ar";
  const gender = savedData.gender || "male";
  
  let message = "";

  if (lang === "ar") {
    if (gender === "male") {
      message = "ÿ£ŸáŸÑÿßŸã ÿ®ŸäŸÉ!\nÿ£ŸÜÿß ÿ®Ÿäÿ∂ÿ© ÿßŸÑÿ®ÿ∑ÿ±ŸäŸÇ ÿßŸÑÿ≤ÿ±ŸÇÿßÿ° ÿßŸÑŸÖÿ≤ÿ±ŸÇÿ¥ÿ©... ÿ∞ŸÉÿßÿ° ÿßÿµÿ∑ŸÜÿßÿπŸä ÿπŸÑŸâ ŸÖÿ≤ÿßÿ¨Ÿä ŸÅÿßÿÆÿ± ŸÖŸÜ ÿßŸÑÿ¢ÿÆÿ±.\nŸÖŸáŸÖÿ™Ÿä ÿßŸÑÿ®ÿ≥Ÿäÿ∑ÿ©: ÿ£ÿÆŸÑŸäŸÉ ÿ™ÿ∑ŸÅÿ¥ Ÿàÿ™ŸÖÿ≥ÿ≠ ÿßŸÑŸÑÿπÿ®ÿ©!";
    } else {
      message = "ÿ£ŸáŸÑÿßŸã ÿ®ŸäŸÉŸä!\nÿ£ŸÜÿß ÿ®Ÿäÿ∂ÿ© ÿßŸÑÿ®ÿ∑ÿ±ŸäŸÇ ÿßŸÑÿ≤ÿ±ŸÇÿßÿ° ÿßŸÑŸÖÿ≤ÿ±ŸÇÿ¥ÿ©... ÿ∞ŸÉÿßÿ° ÿßÿµÿ∑ŸÜÿßÿπŸä ÿπŸÑŸâ ŸÖÿ≤ÿßÿ¨Ÿä ŸÅÿßÿÆÿ± ŸÖŸÜ ÿßŸÑÿ¢ÿÆÿ±.\nŸÖŸáŸÖÿ™Ÿä ÿßŸÑŸÑÿ∞Ÿäÿ∞ÿ©: ÿ£ÿÆŸÑŸäŸÉŸä ÿ™ÿ≤ŸáŸÇŸä Ÿàÿ™ŸÖÿ≥ÿ≠Ÿä ÿßŸÑŸÑÿπÿ®ÿ©!";
    }
  } else if (lang === "en") {
    if (gender === "male") {
      message = "Hey there!\nI'm the Blue Penguin Egg... a sarcastic piece of AI made just to mess with you.\nMy simple mission: Make you rage quit and delete the game!";
    } else {
      message = "Hey girl!\nI'm the Blue Penguin Egg... a sarcastic piece of AI crafted just to drive you crazy.\nMy sweet mission: Make you rage quit and uninstall the game!";
    }
  }

  aiText.textContent = "";
  aiDots.style.display = "flex"; 

  setTimeout(() => {
    aiDots.style.display = "none"; 

    let charIndex = 0;
    function typeNextChar() {
      if (charIndex < message.length) {
        aiText.textContent += message[charIndex];
        charIndex++;
        setTimeout(typeNextChar, 40); // ÿ≥ÿ±ÿπÿ© ÿßŸÑŸÉÿ™ÿßÿ®ÿ©
      } else {
        
        setTimeout(() => {
  avatarImg.src = "assets/ai_angry.png";
  avatarImg.classList.add("shake");

  // üëá ÿ•ŸÜÿ¥ÿßÿ° ÿ≤ÿ±ÿßÿ± "ŸäŸÑÿß ŸÜÿ®ÿØÿ£ ÿßŸÑÿ±ÿ≠ŸÑÿ©"
  const startBtn = document.createElement("button");
  startBtn.innerText = lang === "ar" ? "üéÆ ŸäŸÑÿß ŸÜÿ®ÿØÿ£ ÿßŸÑÿ±ÿ≠ŸÑÿ©!" : "üéÆ Let's Start!";
  startBtn.className = "welcome-btn";
  startBtn.style.marginTop = "25px";
startBtn.onclick = () => {
  let data = JSON.parse(localStorage.getItem("blockPlayerData")) || {};
  data.introDone = true;
  localStorage.setItem("blockPlayerData", JSON.stringify(data));

  // ÿ£ÿÆŸÅŸä ŸÉŸÑ ÿßŸÑÿ¥ÿßÿ¥ÿßÿ™ ÿßŸÑÿ™ŸÖŸáŸäÿØŸäÿ©
  document.getElementById("welcomeScreen").classList.add("hidden");
  document.getElementById("avatarIntroScreen").classList.add("hidden");

  // ÿßŸÅÿ™ÿ≠ ÿßŸÑŸÇÿßÿ¶ŸÖÿ© ÿßŸÑÿ±ÿ¶Ÿäÿ≥Ÿäÿ©
  switchScreen("menu");
  applyLanguage();
};


  document.getElementById("avatarWrapper").appendChild(startBtn);
}, 2000);

      }
    }

    typeNextChar();
  }, 1200);

}



document.getElementById("welcomeText").innerText = "ü§ñ ÿ¨ÿßÿ±Ÿä ÿßŸÑÿ™ÿ≠ÿ∂Ÿäÿ± ŸÑŸÖÿ∫ÿßŸÖÿ±ÿ™ŸÉ.";
document.getElementById("langButtons").style.display = "none";


  // ŸÜÿ®ÿØÿ£ ŸÅÿ≠ÿµ ÿßŸÑÿ™ÿ≠ŸÖŸäŸÑ
  const checkReady = setInterval(() => {
    if (window.aiReady) {
      clearInterval(checkReady);
      document.getElementById("welcomeScreen").style.display = "none";
document.getElementById("avatarIntroScreen").classList.remove("hidden");
startAvatarIntroduction();

    }
  }, 100);
}





    function showPlayerStats() {
      let savedData = JSON.parse(localStorage.getItem("blockPlayerData")) || {};
      let lang = savedData.language || 'ar';
      let t = applyLanguageText(lang);
      
      let highestScore = localStorage.getItem("blockHighestScore") || 0;
      let lastScore = localStorage.getItem("blockLastScore") || 0;
      let playCount = localStorage.getItem("blockPlayCount") || 0;
      let aiEnabled = localStorage.getItem("aiModeEnabled") !== "false";


let soundEnabled = localStorage.getItem("soundEnabled") !== "false";

let statsHTML = `
  <div class="row">${t.genderLabel}: ${savedData.gender === 'male' ? (lang === 'ar' ? 'ŸàŸÑÿØ' : 'Boy') : (lang === 'ar' ? 'ÿ®ŸÜÿ™' : 'Girl')}
    <button onclick="changeGender()">${t.change}</button>
  </div>
  <div class="row">${t.langLabel}: ${lang === 'ar' ? 'ÿßŸÑÿπÿ±ÿ®Ÿäÿ©' : 'English'}
    <button onclick="changeLanguage()">${t.change}</button>
  </div>
  <div class="row">${t.highScore}: ${highestScore}</div>
  <div class="row">${t.lastScore}: ${lastScore}</div>
  <div class="row">${t.playCount}: ${playCount}</div>
  <hr style="width:100%;margin:10px 0;">
  <div class="row">${t.aiMessage}:
    <button id="aiModeToggleBtn" onclick="toggleAIMode()">
      ${aiEnabled ? t.aiStatusOn : t.aiStatusOff}
    </button>
  </div>
  <div class="row">${t.soundLabel}:
    <button id="soundToggleBtn" onclick="toggleSoundSetting()">
      ${soundEnabled ? t.soundOn : t.soundOff}
    </button>
  </div>
  <div style="margin-top: 10px; color: #4CAF50;">${gameTranslations[lang].levelMessage}</div>
`;




      document.getElementById("statsContent").innerHTML = statsHTML;
      document.getElementById("playerStats").style.display = "flex";
    }

    function changeGender() {
  let data = JSON.parse(localStorage.getItem("blockPlayerData")) || {};
  data.gender = (data.gender === 'male') ? 'female' : 'male';
  localStorage.setItem("blockPlayerData", JSON.stringify(data));
  reloadAIResponses(); // üëà ÿ™ÿ∂ŸäŸÅ ÿØŸä
  showPlayerStats();
}



function toggleAIMode() {
  const current = localStorage.getItem("aiModeEnabled");
  const newValue = current === "false" ? "true" : "false";
  localStorage.setItem("aiModeEnabled", newValue);

  // ÿ™ÿ≠ÿØŸäÿ´ ÿßŸÑÿ≤ÿ± ÿ®ÿµÿ±ŸäŸãÿß
  const btn = document.getElementById("aiModeToggleBtn");
  if (btn) {
    const t = applyLanguageText(playerData.language || "ar");
btn.textContent = newValue === "true" ? t.aiStatusOn : t.aiStatusOff;

  }
}

function toggleSoundSetting() {
  const current = localStorage.getItem("soundEnabled");
  const newValue = current === "false" ? "true" : "false";
  localStorage.setItem("soundEnabled", newValue);
  isSoundOn = newValue === "true";

  const t = applyLanguageText(playerData.language || "ar");
  const btn = document.getElementById("soundToggleBtn");
  if (btn) {
    btn.textContent = isSoundOn ? t.soundOn : t.soundOff;
  }
}






function getTranslation(key) {
  const lang = localStorage.getItem("lang") || "en";
  return gameTranslations[lang][key] || key;
}


function changeLanguage() {
  let data = JSON.parse(localStorage.getItem("blockPlayerData")) || {};
  data.language = (data.language === 'ar') ? 'en' : 'ar';
  localStorage.setItem("blockPlayerData", JSON.stringify(data));
  reloadAIResponses(); // üëà ÿ™ÿ∂ŸäŸÅ ÿØŸä
  showPlayerStats();
  applyLanguage();
}


    function closeStats() {
      document.getElementById("playerStats").style.display = "none";
    }

    function getAIPersonalMessage(score) {
      const lang = JSON.parse(localStorage.getItem("blockPlayerData"))?.language || 'ar';
      
      if(score < 100) return lang === 'ar' ? "ŸÑÿ≥Ÿá ÿ®ÿ™ÿ®ÿØÿ£ ÿßŸÑÿ±ÿ≠ŸÑÿ©! üöÄ" : "Just starting! üöÄ";
      if(score < 500) return lang === 'ar' ? "ÿ£ÿØÿßÿ° ÿ¨ŸÖŸäŸÑ! üí™ ÿßÿ≥ÿ™ŸÖÿ±." : "Good performance! üí™ Keep going.";
      if(score < 1000) return lang === 'ar' ? "ÿ•ŸÜÿ™ ŸÖÿ≠ÿ™ÿ±ŸÅ! üî•" : "You're a pro! üî•";
      return gameTranslations[lang].levelMessage;
    }

    function applyLanguage() {
      const saved = JSON.parse(localStorage.getItem("blockPlayerData")) || {};
      const lang = saved.language || "ar";
      const t = gameTranslations[lang];

      document.querySelector(".game-title").textContent = "Block Puzzle AI";
      document.querySelector(".start-btn").textContent = t.startBtn;
      document.querySelector(".stats-btn").textContent = t.statsBtn;
      document.getElementById("shareInsightBtn").textContent = lang === "ar"
  ? "üîó ÿ¥ÿßÿ±ŸÉ ÿßŸÑÿ™ÿ≠ŸÑŸäŸÑ ŸÖÿπ ÿµÿ≠ÿßÿ®ŸÉ"
  : "üîó Share Insight";

document.getElementById("closeInsightBtn").textContent = lang === "ar"
  ? "üèÅ ŸÉŸÅÿßŸäÿ© ÿ™ÿ≠ŸÑŸäŸÑ.. ŸÜÿ±ÿ¨ÿπÿü"
  : "üèÅ Enough insight.. go back?";

      document.getElementById("insightBtn").textContent = lang === "ar"
  ? "üìò ÿ™ŸÇÿ±Ÿäÿ± ÿ≠ÿßŸÑÿ™ŸÉ ÿßŸÑŸÜŸÅÿ≥Ÿäÿ©"
  : "üìò AI Insight Report";

      document.getElementById("scoreboard").textContent = t.scoreText + score;
      document.querySelector("#gameover h1").textContent = t.gameOver;
      document.getElementById("resumeBtn").textContent = t.resumeBtn;
      document.getElementById("restartBtn").textContent = t.restartBtn;
      document.getElementById("countdown").textContent = t.countdownText;
      document.getElementById("statsText").textContent = t.statsTitle;
      document.getElementById("backBtn").textContent = t.backBtn;

      if (document.getElementById("welcomeScreen").style.display !== "none") {
        chooseLanguage(lang);
      }
    }

    function shareInsight() {
  const report = document.getElementById("insightAiText").textContent;
  if (navigator.share) {
    navigator.share({
      title: "ÿ™ÿ≠ŸÑŸäŸÑ ÿßŸÑÿ®Ÿäÿ∂ÿ© üß†",
      text: report,
    }).then(() => {
      console.log("‚úÖ ÿ™ŸÖ ŸÖÿ¥ÿßÿ±ŸÉÿ© ÿßŸÑÿ™ÿ≠ŸÑŸäŸÑ");
    }).catch(err => {
      alert("‚ùå ŸÅÿ¥ŸÑ ŸÅŸä ÿßŸÑŸÖÿ¥ÿßÿ±ŸÉÿ©: " + err);
    });
  } else {
    alert("ÿßŸÑŸÖÿ¥ÿßÿ±ŸÉÿ© ÿ∫Ÿäÿ± ŸÖÿØÿπŸàŸÖÿ© ŸÅŸä Ÿáÿ∞ÿß ÿßŸÑŸÖÿ™ÿµŸÅÿ≠.");
  }
}


function closeInsight() {
  document.getElementById("insightScreen").classList.add("hidden");
  switchScreen("menu");
}




    function applyLanguageText(lang) {
      return {
        vibrationLabel: lang === 'ar' ? "üì≥ ÿßŸÑÿßŸáÿ™ÿ≤ÿßÿ≤" : "üì≥ Vibration",
vibrationOn: lang === 'ar' ? "‚úÖ ŸÖŸÅÿπŸÑ" : "‚úÖ On",
vibrationOff: lang === 'ar' ? "üö´ ÿ∫Ÿäÿ± ŸÖŸÅÿπŸÑ" : "üö´ Off",

        soundLabel: lang === 'ar' ? "üîä ÿßŸÑÿµŸàÿ™" : "üîä Sound",
soundOn: lang === 'ar' ? "‚úÖ ÿ¥ÿ∫ÿßŸÑ" : "‚úÖ On",
soundOff: lang === 'ar' ? "üö´ ŸÖÿ∫ŸÑŸÇ" : "üö´ Off",

        genderLabel: lang === 'ar' ? "üë§ ÿßŸÑŸÜŸàÿπ" : "üë§ Gender",
        ageLabel: lang === 'ar' ? "üéÇ ÿßŸÑÿ≥ŸÜ" : "üéÇ Age",
        langLabel: lang === 'ar' ? "üåç ÿßŸÑŸÑÿ∫ÿ©" : "üåç Language",
        highScore: lang === 'ar' ? "üèÜ ÿ£ÿπŸÑŸâ ŸÜÿ™Ÿäÿ¨ÿ©" : "üèÜ High Score",
        lastScore: lang === 'ar' ? "üéØ ÿ¢ÿÆÿ± ŸÜÿ™Ÿäÿ¨ÿ©" : "üéØ Last Score",
        playCount: lang === 'ar' ? "üî• ŸÖÿ±ÿßÿ™ ÿßŸÑŸÑÿπÿ®" : "üî• Play Count",
        aiMessage: lang === 'ar' ? "üí° ÿßŸÑŸÖÿ≥ÿßÿπÿØ ÿßŸÑÿ∞ŸÉŸä" : "üí° Smart Assistant",
aiStatusOn: lang === 'ar' ? "‚úÖ ŸÖŸÅÿπŸÑ" : "‚úÖ Enabled",
aiStatusOff: lang === 'ar' ? "üö´ ÿ∫Ÿäÿ± ŸÖŸÅÿπŸÑ" : "üö´ Disabled",

        change: lang === 'ar' ? "ÿ™ÿ∫ŸäŸäÿ±" : "Change"
      };
    }

    let idleTimer, idleRepeater;
    function resetIdleTimer() {
      clearTimeout(idleTimer);
      clearInterval(idleRepeater);

      idleTimer = setTimeout(() => {
        showAIReaction("idle");
        idleRepeater = setInterval(() => {
          showAIReaction("idle");
        }, 15000);
      }, 12000);
    }

    ["pointerdown", "pointermove", "keydown"].forEach(evt =>
      window.addEventListener(evt, resetIdleTimer)
    );
    resetIdleTimer();

   function backToMenu() {
  isGameRunning = false;

  // ‚õî ÿ£ŸàŸÇŸÅ ÿµŸàÿ™ ÿßŸÑÿ®ÿßÿ®ŸÑ ÿ•ŸÜ ŸàŸèÿ¨ÿØ
  if (SoundManager?.sounds?.bubbleAppear) {
    SoundManager.sounds.bubbleAppear.pause();
    SoundManager.sounds.bubbleAppear.currentTime = 0;
  }

  // ‚õî ÿ£ÿÆŸÅŸê ÿßŸÑŸÅŸÇÿßÿπÿ©
  document.getElementById("aiBubble")?.classList.add("hidden");
  document.getElementById("aiBubble")?.classList.remove("show", "hide");
  document.getElementById("aiBoard")?.classList.add("hidden");
  document.getElementById("aiBoard")?.classList.remove("show", "hide");
  document.getElementById("aiText")?.classList.remove("show");

  // ‚õî ÿßŸÖÿ≥ÿ≠ ÿ£Ÿä ÿ±ÿ≥ÿßÿ¶ŸÑ ŸÖÿπŸÑŸÇÿ©
  messageQueue = [];
  isShowingMessage = false;

  // ‚úÖ ÿßÿ±ÿ¨ÿπ ŸÑŸÑŸÇÿßÿ¶ŸÖÿ©
  switchScreen("menu");
}



let countdownTimer;
function startResumeCountdown() {
  const countdownEl = document.getElementById("countdown");
  const countdownBarContainer = document.getElementById("countdownBarContainer");
  const countdownBar = document.getElementById("countdownBar");
  const restartBtn = document.getElementById("restartBtn");
  const insightBtn = document.getElementById("insightBtn");
  const resumeBtn = document.getElementById("resumeBtn");
  const finalScoreDisplay = document.getElementById("finalScoreDisplay");

  let seconds = 5;

  // ÿ•ÿÆŸÅÿßÿ° ÿßŸÑÿπŸÜÿßÿµÿ± ŸÇÿ®ŸÑ ÿßŸÑÿ®ÿØÿ°
  countdownEl.style.display = "block";
  countdownBarContainer.style.display = "block";
  countdownBar.style.animation = "countdownShrink 5s linear forwards";
  countdownEl.textContent = `ÿ£Ÿà ÿßŸÜÿ™ÿ∏ÿ± ${seconds} ÿ´ŸàÿßŸÜŸä.`;
  finalScoreDisplay.style.display = "none";
  finalScoreDisplay.classList.remove("show", "bounce-in");

  // ÿπÿØ ÿ™ŸÜÿßÿ≤ŸÑŸä
  countdownTimer = setInterval(() => {
    seconds--;
    if (seconds > 0) {
      countdownEl.textContent = `ÿ£Ÿà ÿßŸÜÿ™ÿ∏ÿ± ${seconds} ÿ´ŸàÿßŸÜŸä.`;
    }
  }, 1000);

  // ÿ®ÿπÿØ 5 ÿ´ŸàÿßŸÜŸä - ÿ•ÿ∏Ÿáÿßÿ± ÿ≤ÿ± ÿßŸÑÿ™ŸÇÿ±Ÿäÿ± ŸàÿßŸÑÿ±Ÿäÿ≥ÿ™ÿßÿ±ÿ™ + ÿßŸÑÿ≥ŸÉŸàÿ± ŸÖÿπ ŸÖÿ§ÿ´ÿ±ÿßÿ™
setTimeout(() => {
  clearInterval(countdownTimer);
  countdownEl.style.display = "none";
  countdownBarContainer.style.display = "none";
  resumeBtn.style.display = "none";
  restartBtn.style.display = "inline-block";
  insightBtn.style.display = "inline-block";

  // ‚ú® ÿ•ÿ∏Ÿáÿßÿ± ÿßŸÑÿ≥ŸÉŸàÿ± ÿ®ÿπÿØ ÿßŸÜÿ™Ÿáÿßÿ° ÿßŸÑÿπÿØÿßÿØ ŸÅŸÇÿ∑
  finalScoreDisplay.textContent = score;
  finalScoreDisplay.style.display = "block";
  finalScoreDisplay.classList.add("show", "bounce-in");

  // üí• ŸÖŸÅÿ±ŸÇÿπÿßÿ™ ÿ≠ŸàŸÑ ÿßŸÑÿ≥ŸÉŸàÿ±
  for (let i = 0; i < 15; i++) {
    const particle = document.createElement("div");
    particle.className = "score-particle";
    particle.style.left = `${50 + Math.random() * 10 - 5}%`;
    particle.style.top = `${50 + Math.random() * 10 - 5}%`;
    particle.style.setProperty('--x', `${Math.random() * 200 - 100}px`);
    particle.style.setProperty('--y', `${Math.random() * 200 - 100}px`);
    finalScoreDisplay.appendChild(particle);

    setTimeout(() => particle.remove(), 1500);
  }

}, 5000);

}




function showReactionMessage(message) {
  const aiEnabled = localStorage.getItem("aiModeEnabled") !== "false";
if (!aiEnabled) return;

  const isGameActive = document.getElementById("game").classList.contains("active");
  const isIntroActive = document.getElementById("avatarIntroScreen").classList.contains("active");

  // üëá ŸÑŸà ÿßŸÑÿ¥ÿßÿ¥ÿ© ŸÖÿ¥ ŸÜÿ¥ÿ∑ÿ© ÿ≠ÿßŸÑŸäŸãÿßÿå ÿßÿ≥ÿ™ŸÜŸâ ÿ¥ŸàŸäÿ© Ÿàÿ¨ÿ±ÿ® ÿ™ÿßŸÜŸä
  if (!(isGameActive || isIntroActive)) {
    setTimeout(() => {
      showReactionMessage(message);
    }, 200);
    return;
  }

  if (document.hidden) {
    isShowingMessage = false;
    return;
  }




  if (isGameRunning) {
  SoundManager.play('bubbleAppear');
}

  const aiBubble = document.getElementById("aiBubble");
  const aiBoard = document.getElementById("aiBoard");
  const aiText = document.getElementById("aiText");
  const heatBar = document.getElementById("aiHeatBar");
  const aiDots = document.querySelector(".ai-dots");

  aiText.textContent = "";
  aiDots.style.display = "flex"; // ÿßÿ∏Ÿáÿßÿ± ÿßŸÑŸÜŸÇÿ∑ ÿßŸÑŸÑŸä ÿ®ÿ™ÿ™ÿ≠ÿ±ŸÉ

  aiBubble.classList.remove("hidden");
  aiBoard.classList.remove("hidden");
  aiBubble.classList.add("show");
  aiBoard.classList.add("show");
  aiText.classList.remove("hidden");
  aiText.classList.add("show");

  // Reset and animate the heat bar
  heatBar.style.width = "100%";
  heatBar.style.transition = "none";
  void heatBar.offsetWidth;
  heatBar.style.transition = "width 3s linear";
  heatBar.style.width = "0%";

  // ÿ®ÿπÿØ ÿ´ÿßŸÜŸäÿ© ŸÖŸÜ ÿßŸÑÿ™ŸÅŸÉŸäÿ±ÿå Ÿäÿ®ÿØÿ£ ŸäŸÉÿ™ÿ® ÿßŸÑÿ¨ŸÖŸÑÿ©
  setTimeout(() => {
    aiDots.style.display = "none"; // ÿßÿÆŸÅÿßÿ° ÿßŸÑŸÜŸÇÿ∑
    let charIndex = 0;
    function typeNextChar() {
      if (charIndex < message.length) {
        aiText.textContent += message[charIndex];
        charIndex++;
        setTimeout(typeNextChar, 40); // ÿ≥ÿ±ÿπÿ© ÿßŸÑÿ≠ÿ±ŸÅ
      }
    }
    typeNextChar();
  }, 1000); // ŸàŸÇÿ™ ÿßŸÑÿ™ŸÅŸÉŸäÿ± ŸÇÿ®ŸÑ Ÿäÿ®ÿØÿ£ ŸäŸÉÿ™ÿ®

  // Hide after 3.5 seconds
  setTimeout(() => {
    aiBubble.classList.add("hide");
    aiBoard.classList.add("hide");
    aiText.classList.remove("show");

    setTimeout(() => {
      aiBubble.classList.remove("show", "hide");
      aiBoard.classList.remove("show", "hide");
      aiBubble.classList.add("hidden");
      aiBoard.classList.add("hidden");
      aiText.classList.add("hidden");

      processMessageQueue();
    }, 500);
  }, 3500);
}




function startAvatarBlink() {
  const avatarImg = document.getElementById("aiAvatar");
  setInterval(() => {
    avatarImg.classList.add("blink");
    setTimeout(() => {
      avatarImg.classList.remove("blink");
    }, 200); // ŸÖÿØÿ© ÿßŸÑÿ±ŸÖÿ¥
  }, 4000); // ŸÉŸÑ 4 ÿ´ŸàÿßŸÜŸä ÿ±ŸÖÿ¥ÿ©
}

startAvatarBlink();

window.allAIResponses = {}; // ŸÖŸÉÿßŸÜ ÿ™ÿÆÿ≤ŸäŸÜ ŸÉŸÑ ÿßŸÑÿ¨ŸÖŸÑ

function loadAllAIResponses(callback) {
  const configs = ['ar_male', 'ar_female', 'en_male', 'en_female'];
  let loadedCount = 0;
  const totalToLoad = configs.length;

  function checkAllLoaded() {
    loadedCount++;
    console.log(`‚úÖ ÿ™ŸÖ ÿ™ÿ≠ŸÖŸäŸÑ (${loadedCount}/${totalToLoad})`);
    if (loadedCount === totalToLoad) {
      console.log("üéâ ÿßŸÉÿ™ŸÖŸÑ ÿ™ÿ≠ŸÖŸäŸÑ ÿ¨ŸÖŸäÿπ ŸÖŸÑŸÅÿßÿ™ ÿßŸÑÿ±ÿØŸàÿØ");
      if (callback) callback();
    }
  }

  configs.forEach(config => {
    const script = document.createElement('script');
    script.src = `ai_responses/aiResponses_${config}.js`;
    script.onload = function() {
      if (window.tempAIResponses) {
        window.allAIResponses[config] = window.tempAIResponses;
        delete window.tempAIResponses;
      }
      checkAllLoaded();
    };
    script.onerror = function() {
      console.error(`‚ùå ŸÅÿ¥ŸÑ ÿ™ÿ≠ŸÖŸäŸÑ: aiResponses_${config}.js`);
      checkAllLoaded();
    };
    document.body.appendChild(script);
  });
}


function toggleSound() {
  isSoundOn = !isSoundOn;

  const icon = document.getElementById("soundIcon");

  if (isSoundOn) {
    icon.setAttribute("fill", "#2196F3");
    icon.setAttribute("d", "M3 9v6h4l5 5V4L7 9H3zm13.5 3c0-1.77-1.02-3.29-2.5-4.03v8.05c1.48-.73 2.5-2.25 2.5-4.02z");
  } else {
    icon.setAttribute("fill", "#ccc");
    icon.setAttribute("d", "M3 9v6h4l5 5V4L7 9H3z"); // ÿ¥ŸÉŸÑ ŸÖŸÉÿ®ÿ± ÿ®ÿØŸàŸÜ ŸÖŸàÿ¨ÿßÿ™
  }
}

window.onload = () => {
  loadAllAIResponses(() => {
    reloadAIResponses();
    let savedData = JSON.parse(localStorage.getItem("blockPlayerData"));
    if (savedData && savedData.language) {
      document.getElementById("welcomeScreen").style.display = "none";
      applyLanguage();
    }
    setupButtonSounds(); // <-- Ÿáÿ∞Ÿá ŸáŸä ÿßŸÑÿ•ÿ∂ÿßŸÅÿ© ÿßŸÑÿ¨ÿØŸäÿØÿ©
  });
}

// Sound Manager - ŸäÿØŸäÿ± ÿ¨ŸÖŸäÿπ ÿßŸÑÿ£ÿµŸàÿßÿ™ ŸÅŸä ÿßŸÑŸÑÿπÿ®ÿ©
const SoundManager = {
  sounds: {},
  context: new (window.AudioContext || window.webkitAudioContext)(),
buffers: {}, // ŸÑÿ™ÿÆÿ≤ŸäŸÜ ÿßŸÑÿ£ÿµŸàÿßÿ™ ÿ®ÿπÿØ ŸÅŸÉ ÿ™ÿ¥ŸÅŸäÿ±Ÿáÿß
loadSounds: async function () {
  const files = {
    buttonClick: "assets/sounds/button-click.mp3",
    shapePick: "assets/sounds/shape-pick.mp3",
    singleClear: "assets/sounds/singleClear.mp3",
    comboClear: "assets/sounds/combo-clear.mp3",
    bubbleAppear: "assets/sounds/bubble-appear.mp3"
  };

  const ctx = this.context;

  for (let key in files) {
    try {
      const response = await fetch(files[key]);
      const arrayBuffer = await response.arrayBuffer();
      const audioBuffer = await ctx.decodeAudioData(arrayBuffer);
      this.buffers[key] = audioBuffer;

      // ‚úÖ ÿ™ÿ≥ÿÆŸäŸÜ buttonClick ÿ®ÿπÿØ ÿßŸÑÿ™ÿ≠ŸÖŸäŸÑ
      if (key === 'buttonClick') {
        const source = ctx.createBufferSource();
        source.buffer = audioBuffer;
        source.connect(ctx.destination);
        source.start(0);
        source.stop(ctx.currentTime + 0.05); // ÿ™ŸàŸÇŸÅ ÿ≥ÿ±Ÿäÿπ
      }

    } catch (err) {
      console.warn("‚ùå ŸÅÿ¥ŸÑ ÿ™ÿ≠ŸÖŸäŸÑ ÿßŸÑÿµŸàÿ™:", key, err);
    }
  }

  console.log("‚úÖ ÿßŸÑÿ£ÿµŸàÿßÿ™ ÿ™ŸÖ ÿ™ÿ≠ŸÖŸäŸÑŸáÿß ŸàŸÅŸÉ ÿ™ÿ¥ŸÅŸäÿ±Ÿáÿß");
},


play: function (name) {
  if (!isSoundOn) return;

  const buffer = this.buffers?.[name];
  if (buffer) {
    const source = this.context.createBufferSource();
    source.buffer = buffer;
    source.connect(this.context.destination);
    source.start(0);
  }
},

};

  </script>

<script>
document.addEventListener("DOMContentLoaded", () => {
  const grid = document.getElementById("grid");
  if (!grid) {
    console.warn("‚ö†Ô∏è ÿßŸÑÿπŸÜÿµÿ± #grid ÿ∫Ÿäÿ± ŸÖŸàÿ¨ŸàÿØ.");
    return;
  }

  window.manager = new Hammer.Manager(grid);

  const Pan = new Hammer.Pan({ threshold: 5 });
  manager.add(Pan);

manager.on('panstart panmove panend', (e) => {
  const eventMap = {
    'panstart': 'pointerdown',
    'panmove': 'pointermove',
    'panend': 'pointerup'
  };

  // ‚úÖ ŸÖŸÜÿπ ÿ£Ÿä ŸÑŸÖÿ≥ÿ© ÿ•ÿ∂ÿßŸÅŸäÿ© ÿ∫Ÿäÿ± ÿßŸÑÿ£ŸàŸÑŸâ
  if (eventMap[e.type] === "pointerdown" && isTouchActive) return;
  if (eventMap[e.type] === "pointerdown") isTouchActive = true;
  if (eventMap[e.type] === "pointerup") isTouchActive = false;

  const event = new PointerEvent(eventMap[e.type], {
    clientX: e.center.x,
    clientY: e.center.y
  });

 const realTarget = document.elementFromPoint(e.center.x, e.center.y);
if (realTarget) {
  realTarget.dispatchEvent(event);
}

});


  // üü¢ ÿ™ÿÆÿ≤ŸäŸÜŸá ŸÅŸä window ÿπŸÑÿ¥ÿßŸÜ ÿ™ÿ≥ÿ™ÿÆÿØŸÖŸá ŸÅŸä ÿ£ŸÖÿßŸÉŸÜ ÿ™ÿßŸÜŸäÿ© ŸÑŸà ÿ≠ÿ®Ÿäÿ™
  window.hammerManager = manager;
});
</script>

<script>
  document.addEventListener("DOMContentLoaded", () => {
    const grid = document.getElementById("grid");
    if (!grid) {
      console.warn("‚ö†Ô∏è ÿßŸÑÿπŸÜÿµÿ± #grid ŸÖÿ¥ ŸÖŸàÿ¨ŸàÿØ.");
      return;
    }
  
    window.manager = new Hammer.Manager(grid);
    const Pan = new Hammer.Pan({ threshold: 5 });
    window.manager.add(Pan);
  
    window.manager.on('panstart panmove panend', (e) => {
      const eventMap = {
        'panstart': 'pointerdown',
        'panmove': 'pointermove',
        'panend': 'pointerup'
      };
  
      const event = new PointerEvent(eventMap[e.type], {
        clientX: e.center.x,
        clientY: e.center.y
      });
  
     const realTarget = document.elementFromPoint(e.center.x, e.center.y);
if (realTarget) {
  realTarget.dispatchEvent(event);
}

    });
  });
  </script>

<script>
  document.addEventListener("DOMContentLoaded", () => {
    const grid = document.getElementById("grid");
    if (!grid) {
      console.warn("‚ö†Ô∏è ÿßŸÑÿπŸÜÿµÿ± #grid ÿ∫Ÿäÿ± ŸÖŸàÿ¨ŸàÿØ.");
      return;
    }
  
    window.manager = new Hammer.Manager(grid);
    const Pan = new Hammer.Pan({ threshold: 5 });
    window.manager.add(Pan);
  
    window.manager.on('panstart panmove panend', (e) => {
      const eventMap = {
        'panstart': 'pointerdown',
        'panmove': 'pointermove',
        'panend': 'pointerup'
      };
  
      const event = new PointerEvent(eventMap[e.type], {
        clientX: e.center.x,
        clientY: e.center.y
      });
  
      const realTarget = document.elementFromPoint(e.center.x, e.center.y);
if (realTarget) {
  realTarget.dispatchEvent(event);
}

    });
  
    // ‚úÖ ÿ£Ÿä ÿßÿ≥ÿ™ÿÆÿØÿßŸÖ ÿ™ÿßŸÜŸä ŸÑŸÑŸÄ manager ŸÑÿßÿ≤ŸÖ Ÿäÿ®ŸÇŸâ ŸáŸÜÿß ÿ£Ÿà ÿ®ÿπÿØŸá
  });

  window.addEventListener('DOMContentLoaded', async () => {
  await preloadEverything(); // ŸáŸÜÿß ÿ®ŸÜŸÅÿ™ÿ±ÿ∂ ÿπŸÜÿØŸÉ ÿØÿßŸÑÿ© ÿ™ÿ≠ŸÖŸäŸÑ ÿ£ÿµŸàÿßÿ™/ÿµŸàÿ±


document.body.addEventListener("touchend", (e) => {
  if (activePointerId !== "touch") return;

  const isOriginalTouchGone = Array.from(e.changedTouches).some(t => t.identifier === activeTouchId);
  if (!isOriginalTouchGone) return; // ‚úÖ ŸÑŸà ÿßŸÑŸÑŸä ÿÆÿ±ÿ¨ ŸÖÿ¥ ŸÜŸÅÿ≥ ÿßŸÑŸÑŸÖÿ≥ÿ© ÿßŸÑÿ£ÿµŸÑŸäÿ©ÿå ÿ™ÿ¨ÿßŸáŸÑ

  activePointerId = null;
  activeTouchId = null;

  if (!floating) return;

  const cellSize = gridCells[0].getBoundingClientRect().width;

  // ŸÜÿ≥ÿ™ÿÆÿØŸÖ ÿ¢ÿÆÿ± ÿ•ÿ≠ÿØÿßÿ´Ÿäÿßÿ™ ŸÖÿ≠ŸÅŸàÿ∏ÿ©
  const moveX = (lastPointer.pageX - pointerStartX) * 1.4;
  const moveY = (lastPointer.pageY - pointerStartY) * 1.4;

  const boostedX = floatingStartX + moveX;
  const boostedY = floatingStartY + moveY;

  const gridRect = grid.getBoundingClientRect();
  const gridX = Math.floor((boostedX + cellSize * 0.5 - gridRect.left) / (gridRect.width / 8));
  const gridY = Math.floor((boostedY + cellSize * 0.5 - gridRect.top) / (gridRect.height / 8));

  tryDropFloatingShape(gridX, gridY);
});

  // ŸÜÿØŸä ŸÅÿ±ÿµÿ© 2 ÿ´ÿßŸÜŸäÿ© ŸÑŸÑÿπÿ±ÿ∂
  setTimeout(() => {
    document.getElementById("splashScreen").style.display = "none";
   // ÿØŸä ÿßŸÑÿØÿßŸÑÿ© ÿßŸÑŸÑŸä ÿ™ŸÅÿ™ÿ≠ ÿßŸÑŸÇÿßÿ¶ŸÖÿ© ÿ£Ÿà intro AI
  }, 2000);
});



  </script>
  

  <script>
  if ('serviceWorker' in navigator) {
    navigator.serviceWorker.getRegistrations().then(registrations => {
      for (let reg of registrations) {
        reg.update(); // ÿ™ÿ≠ÿØÿ´ ÿ™ŸÑŸÇÿßÿ¶ŸäŸãÿß
      }
    });
  }
</script>





<script>
  if ('serviceWorker' in navigator) {
    window.addEventListener('load', () => {
      navigator.serviceWorker.register('/service-worker.js')
        .then(reg => console.log('‚úÖ Service Worker registered:', reg))
        .catch(err => console.error('‚ùå SW registration failed:', err));
    });
  }
</script>


</body>
</html>